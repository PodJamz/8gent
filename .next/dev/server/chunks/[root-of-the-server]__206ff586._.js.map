{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/jamesspalding/OpenClaw-OS/src/lib/passcodeAuth.ts"],"sourcesContent":["/**\n * Passcode Authentication System\n *\n * Handles 6-digit passcode verification for protected areas and iPod collaborators.\n * Uses HMAC-SHA256 for secure hashing and timing-safe comparison.\n */\n\nimport crypto from 'crypto';\n\n// SECURITY: Require PASSCODE_SECRET to be set - no default fallback\nfunction getPasscodeSecret(): string {\n  const secret = process.env.PASSCODE_SECRET;\n  if (!secret) {\n    throw new Error('PASSCODE_SECRET environment variable is required');\n  }\n  if (secret.length < 32) {\n    throw new Error('PASSCODE_SECRET must be at least 32 characters long');\n  }\n  return secret;\n}\n\n// Lazy-initialize to allow env vars to be set before first use\nlet cachedSecret: string | null = null;\nfunction getSecret(): string {\n  if (!cachedSecret) {\n    cachedSecret = getPasscodeSecret();\n  }\n  return cachedSecret;\n}\n\n// Cookie names for session tokens\nexport const ADMIN_COOKIE = 'jamos_admin';\nexport const AREA_COOKIE_PREFIX = 'jamos_area_';\nexport const IPOD_COOKIE = 'jamos_ipod';\n\n// Session duration (24 hours for admin, 7 days for areas/iPod)\nconst ADMIN_SESSION_DURATION = 24 * 60 * 60 * 1000;\nconst AREA_SESSION_DURATION = 7 * 24 * 60 * 60 * 1000;\n\n/**\n * Hash a 6-digit passcode\n */\nexport function hashPasscode(passcode: string): string {\n  return crypto\n    .createHmac('sha256', getSecret())\n    .update(passcode)\n    .digest('hex');\n}\n\n/**\n * Verify a passcode against a hash (timing-safe)\n */\nexport function verifyPasscode(passcode: string, hash: string): boolean {\n  const inputHash = hashPasscode(passcode);\n  const inputBuffer = Buffer.from(inputHash);\n  const hashBuffer = Buffer.from(hash);\n\n  if (inputBuffer.length !== hashBuffer.length) {\n    return false;\n  }\n\n  return crypto.timingSafeEqual(inputBuffer, hashBuffer);\n}\n\n/**\n * Session token payload\n */\ninterface SessionPayload {\n  type: 'admin' | 'area' | 'ipod';\n  subject: string; // admin username, area slug, or collaborator slug\n  exp: number;\n}\n\n/**\n * Sign a session token\n */\nexport function signSession(payload: SessionPayload): string {\n  const payloadB64 = Buffer.from(JSON.stringify(payload)).toString('base64url');\n  const signature = crypto\n    .createHmac('sha256', getSecret())\n    .update(payloadB64)\n    .digest('base64url');\n  return `${payloadB64}.${signature}`;\n}\n\n/**\n * Verify and decode a session token\n */\nexport function verifySession(token: string | undefined): SessionPayload | null {\n  if (!token) return null;\n\n  const parts = token.split('.');\n  if (parts.length !== 2) return null;\n\n  const [payloadB64, signature] = parts;\n\n  // Verify signature\n  const expectedSig = crypto\n    .createHmac('sha256', getSecret())\n    .update(payloadB64)\n    .digest('base64url');\n\n  const sigBuffer = Buffer.from(signature);\n  const expectedBuffer = Buffer.from(expectedSig);\n\n  if (sigBuffer.length !== expectedBuffer.length) return null;\n  if (!crypto.timingSafeEqual(sigBuffer, expectedBuffer)) return null;\n\n  // Decode payload\n  try {\n    const payload = JSON.parse(Buffer.from(payloadB64, 'base64url').toString()) as SessionPayload;\n\n    // Check expiry\n    if (Date.now() > payload.exp) return null;\n\n    return payload;\n  } catch {\n    return null;\n  }\n}\n\n/**\n * Create an admin session token\n */\nexport function createAdminSession(username: string): string {\n  return signSession({\n    type: 'admin',\n    subject: username,\n    exp: Date.now() + ADMIN_SESSION_DURATION,\n  });\n}\n\n/**\n * Create an area session token\n */\nexport function createAreaSession(areaSlug: string): string {\n  return signSession({\n    type: 'area',\n    subject: areaSlug,\n    exp: Date.now() + AREA_SESSION_DURATION,\n  });\n}\n\n/**\n * Create an iPod collaborator session token\n */\nexport function createiPodSession(collaboratorSlug: string): string {\n  return signSession({\n    type: 'ipod',\n    subject: collaboratorSlug,\n    exp: Date.now() + AREA_SESSION_DURATION,\n  });\n}\n\n/**\n * Get cookie name for a protected area\n */\nexport function getAreaCookieName(areaSlug: string): string {\n  return `${AREA_COOKIE_PREFIX}${areaSlug}`;\n}\n\n/**\n * Validate a 6-digit passcode format\n */\nexport function isValidPasscodeFormat(passcode: string): boolean {\n  return /^\\d{6}$/.test(passcode);\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;;;;CAKC,GAED;;AAEA,oEAAoE;AACpE,SAAS;IACP,MAAM,SAAS,QAAQ,GAAG,CAAC,eAAe;IAC1C,IAAI,CAAC,QAAQ;QACX,MAAM,IAAI,MAAM;IAClB;IACA,IAAI,OAAO,MAAM,GAAG,IAAI;QACtB,MAAM,IAAI,MAAM;IAClB;IACA,OAAO;AACT;AAEA,+DAA+D;AAC/D,IAAI,eAA8B;AAClC,SAAS;IACP,IAAI,CAAC,cAAc;QACjB,eAAe;IACjB;IACA,OAAO;AACT;AAGO,MAAM,eAAe;AACrB,MAAM,qBAAqB;AAC3B,MAAM,cAAc;AAE3B,+DAA+D;AAC/D,MAAM,yBAAyB,KAAK,KAAK,KAAK;AAC9C,MAAM,wBAAwB,IAAI,KAAK,KAAK,KAAK;AAK1C,SAAS,aAAa,QAAgB;IAC3C,OAAO,gHAAM,CACV,UAAU,CAAC,UAAU,aACrB,MAAM,CAAC,UACP,MAAM,CAAC;AACZ;AAKO,SAAS,eAAe,QAAgB,EAAE,IAAY;IAC3D,MAAM,YAAY,aAAa;IAC/B,MAAM,cAAc,OAAO,IAAI,CAAC;IAChC,MAAM,aAAa,OAAO,IAAI,CAAC;IAE/B,IAAI,YAAY,MAAM,KAAK,WAAW,MAAM,EAAE;QAC5C,OAAO;IACT;IAEA,OAAO,gHAAM,CAAC,eAAe,CAAC,aAAa;AAC7C;AAcO,SAAS,YAAY,OAAuB;IACjD,MAAM,aAAa,OAAO,IAAI,CAAC,KAAK,SAAS,CAAC,UAAU,QAAQ,CAAC;IACjE,MAAM,YAAY,gHAAM,CACrB,UAAU,CAAC,UAAU,aACrB,MAAM,CAAC,YACP,MAAM,CAAC;IACV,OAAO,GAAG,WAAW,CAAC,EAAE,WAAW;AACrC;AAKO,SAAS,cAAc,KAAyB;IACrD,IAAI,CAAC,OAAO,OAAO;IAEnB,MAAM,QAAQ,MAAM,KAAK,CAAC;IAC1B,IAAI,MAAM,MAAM,KAAK,GAAG,OAAO;IAE/B,MAAM,CAAC,YAAY,UAAU,GAAG;IAEhC,mBAAmB;IACnB,MAAM,cAAc,gHAAM,CACvB,UAAU,CAAC,UAAU,aACrB,MAAM,CAAC,YACP,MAAM,CAAC;IAEV,MAAM,YAAY,OAAO,IAAI,CAAC;IAC9B,MAAM,iBAAiB,OAAO,IAAI,CAAC;IAEnC,IAAI,UAAU,MAAM,KAAK,eAAe,MAAM,EAAE,OAAO;IACvD,IAAI,CAAC,gHAAM,CAAC,eAAe,CAAC,WAAW,iBAAiB,OAAO;IAE/D,iBAAiB;IACjB,IAAI;QACF,MAAM,UAAU,KAAK,KAAK,CAAC,OAAO,IAAI,CAAC,YAAY,aAAa,QAAQ;QAExE,eAAe;QACf,IAAI,KAAK,GAAG,KAAK,QAAQ,GAAG,EAAE,OAAO;QAErC,OAAO;IACT,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAKO,SAAS,mBAAmB,QAAgB;IACjD,OAAO,YAAY;QACjB,MAAM;QACN,SAAS;QACT,KAAK,KAAK,GAAG,KAAK;IACpB;AACF;AAKO,SAAS,kBAAkB,QAAgB;IAChD,OAAO,YAAY;QACjB,MAAM;QACN,SAAS;QACT,KAAK,KAAK,GAAG,KAAK;IACpB;AACF;AAKO,SAAS,kBAAkB,gBAAwB;IACxD,OAAO,YAAY;QACjB,MAAM;QACN,SAAS;QACT,KAAK,KAAK,GAAG,KAAK;IACpB;AACF;AAKO,SAAS,kBAAkB,QAAgB;IAChD,OAAO,GAAG,qBAAqB,UAAU;AAC3C;AAKO,SAAS,sBAAsB,QAAgB;IACpD,OAAO,UAAU,IAAI,CAAC;AACxB"}},
    {"offset": {"line": 233, "column": 0}, "map": {"version":3,"sources":["file:///Users/jamesspalding/OpenClaw-OS/src/lib/openclaw/client-impl.ts"],"sourcesContent":["import { nanoid } from 'nanoid';\nimport WebSocket from 'isomorphic-ws';\nimport { Buffer } from 'buffer';\n\n// Protocol constants based on OpenClaw source\nconst PROTOCOL_VERSION = 3;\n\nexport interface OpenClawClientConfig {\n    url: string;\n    authToken?: string;\n    device?: {\n        id: string;\n        publicKey: string;\n        privateKey: string;\n    };\n}\n\ntype MessageHandler = (message: any) => void;\n\nexport class OpenClawClientImpl {\n    private ws: WebSocket | null = null;\n    private url: string;\n    private authToken?: string;\n    private pendingRequests = new Map<string, { resolve: (val: any) => void; reject: (err: any) => void }>();\n    private eventListeners = new Map<string, Set<MessageHandler>>();\n    private isConnected = false;\n    private connectPromise: Promise<void> | null = null;\n\n    constructor(config: OpenClawClientConfig) {\n        this.url = config.url;\n        this.authToken = config.authToken;\n    }\n\n    async connect(): Promise<void> {\n        if (this.isConnected) return;\n        if (this.connectPromise) return this.connectPromise;\n\n        this.connectPromise = new Promise((resolve, reject) => {\n            try {\n                // Set origin to satisfy gateway check for Control UI\n                const options = {\n                    headers: {\n                        Origin: 'http://localhost:18789'\n                    }\n                };\n                this.ws = new WebSocket(this.url, options);\n\n                this.ws.onopen = () => {\n                    console.log('[OpenClawClient] WebSocket connected');\n                };\n\n                this.ws.onmessage = (event) => {\n                    try {\n                        let data: any;\n                        const rawData = event.data;\n\n                        // console.log('[OpenClawClient] Raw message type:', typeof rawData);\n\n                        if (typeof rawData === 'string') {\n                            data = JSON.parse(rawData);\n                        } else if (Buffer.isBuffer(rawData)) {\n                            // console.log('[OpenClawClient] Buffer received, length:', rawData.length);\n                            data = JSON.parse(rawData.toString());\n                        } else if (rawData instanceof ArrayBuffer) {\n                            // console.log('[OpenClawClient] ArrayBuffer received, byteLength:', rawData.byteLength);\n                            const decoder = new TextDecoder();\n                            data = JSON.parse(decoder.decode(rawData));\n                        } else if (Array.isArray(rawData)) {\n                            // Buffer[]\n                            // console.log('[OpenClawClient] Buffer array received');\n                            data = JSON.parse(Buffer.concat(rawData).toString());\n                        } else {\n                            // unknown\n                            console.warn('[OpenClawClient] Unknown message type:', typeof rawData);\n                            return;\n                        }\n\n                        // console.log('[OpenClawClient] Parsed message:', data?.type, data?.event || data?.method);\n                        this.handleMessage(data, resolve, reject);\n                    } catch (err) {\n                        console.error('[OpenClawClient] Failed to parse message:', err);\n                    }\n                };\n\n                this.ws.onerror = (error) => {\n                    console.error('[OpenClawClient] WebSocket error:', error);\n                    if (!this.isConnected) reject(error);\n                };\n\n                this.ws.onclose = () => {\n                    console.log('[OpenClawClient] WebSocket closed');\n                    this.isConnected = false;\n                    this.connectPromise = null;\n                };\n            } catch (err) {\n                reject(err);\n            }\n        });\n\n        return this.connectPromise;\n    }\n\n    private handleMessage(message: any, connectResolve: () => void, connectReject: (err: any) => void) {\n        // console.log('[OpenClawClient] Received:', message);\n\n        if (message.type === 'event' && message.event === 'connect.challenge') {\n            this.handleChallenge(message.payload, connectResolve, connectReject);\n            return;\n        }\n\n        if (message.type === 'res') {\n            const pending = this.pendingRequests.get(message.id);\n            if (pending) {\n                if (message.ok) {\n                    pending.resolve(message.body || message.payload); // Adapting to potential response format\n                } else {\n                    pending.reject(new Error(message.error?.message || 'Unknown error'));\n                }\n                this.pendingRequests.delete(message.id);\n            }\n            return;\n        }\n\n        if (message.type === 'event') {\n            const listeners = this.eventListeners.get(message.event);\n            if (listeners) {\n                listeners.forEach(handler => handler(message.payload));\n            }\n        }\n    }\n\n    private handleChallenge(payload: { nonce: string }, resolve: () => void, reject: (err: any) => void) {\n        const connectReq = {\n            type: 'req',\n            id: nanoid(),\n            method: 'connect',\n            params: {\n                minProtocol: PROTOCOL_VERSION,\n                maxProtocol: PROTOCOL_VERSION,\n                role: 'operator',\n                client: {\n                    id: 'webchat', // Bypass Control UI secure context check\n                    displayName: 'OpenClaw OS',\n                    version: '0.1.0',\n                    platform: 'web',\n                    mode: 'ui',\n                    deviceFamily: 'browser'\n                },\n                auth: { token: this.authToken }\n            }\n        };\n\n        if (this.ws) {\n            this.send(connectReq);\n            // We assume connection is successful if we don't get an immediate error? \n            // Or should we wait for a response? The protocol usually sends a generic 'res' for the connect req.\n\n            // Register a temporary handler for the connect response\n            this.pendingRequests.set(connectReq.id, {\n                resolve: () => {\n                    this.isConnected = true;\n                    resolve();\n                },\n                reject: (err) => {\n                    this.isConnected = false;\n                    reject(err);\n                }\n            });\n        }\n    }\n\n    private send(message: any) {\n        if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n            this.ws.send(JSON.stringify(message));\n        } else {\n            console.warn('[OpenClawClient] Cannot send, socket not open');\n        }\n    }\n\n    public async request(method: string, params: any = {}): Promise<any> {\n        await this.connect();\n        const id = nanoid();\n        return new Promise((resolve, reject) => {\n            this.pendingRequests.set(id, { resolve, reject });\n            this.send({\n                type: 'req',\n                id,\n                method,\n                params\n            });\n            // specific logic for timeout could be added here\n        });\n    }\n\n    public subscribe(event: string, handler: MessageHandler) {\n        if (!this.eventListeners.has(event)) {\n            this.eventListeners.set(event, new Set());\n        }\n        this.eventListeners.get(event)!.add(handler);\n        return () => {\n            this.eventListeners.get(event)?.delete(handler);\n        };\n    }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 418, "column": 0}, "map": {"version":3,"sources":["file:///Users/jamesspalding/OpenClaw-OS/src/lib/openclaw/client.ts"],"sourcesContent":["import { OpenClawClientImpl } from './client-impl';\n\n// Default to local gateway if not configured\nconst GATEWAY_URL = process.env.NEXT_PUBLIC_OPENCLAW_GATEWAY_URL || 'ws://localhost:3000';\nconst GATEWAY_TOKEN = process.env.NEXT_PUBLIC_OPENCLAW_GATEWAY_TOKEN || 'openclaw-admin-token'; // Default for dev\n\nclass OpenClawClient {\n  private static instance: OpenClawClientImpl;\n\n  public static getInstance(): OpenClawClientImpl {\n    if (!OpenClawClient.instance) {\n      // Load from localStorage if possible\n      let url = GATEWAY_URL;\n      let token = GATEWAY_TOKEN;\n\n      if (typeof window !== 'undefined') {\n        const stored = localStorage.getItem('openclaw_onboarding');\n        if (stored) {\n          try {\n            const parsed = JSON.parse(stored);\n            if (parsed.gatewayUrl) url = parsed.gatewayUrl;\n            if (parsed.gatewayToken) token = parsed.gatewayToken;\n          } catch (e) {\n            // Use defaults\n          }\n        }\n      }\n\n      OpenClawClient.instance = new OpenClawClientImpl({\n        url: url,\n        authToken: token\n      });\n    }\n    return OpenClawClient.instance;\n  }\n}\n\nexport const openClaw = OpenClawClient.getInstance();\n\nexport const useOpenClaw = () => {\n  return openClaw;\n};\n\n// Shims for Convex compatibility\nexport class ConvexHttpClient {\n  constructor(private url: string) { }\n  // Add methods as needed\n  async query(name: string, args: any) { console.warn(\"ConvexHttpClient.query shim called\", name, args); return null; }\n  async mutation(name: string, args: any) { console.warn(\"ConvexHttpClient.mutation shim called\", name, args); return null; }\n  async action(name: string, args: any) { console.warn(\"ConvexHttpClient.action shim called\", name, args); return null; }\n}\n\nexport function makeFunctionReference(name: string) {\n  return name;\n}\n\nexport class ConvexReactClient {\n  constructor(private url: string) { }\n}\n\nexport const ConvexProvider = ({ client, children }: any) => children;\nexport const ConvexProviderWithClerk = ({ client, children }: any) => children;\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA;;AAEA,6CAA6C;AAC7C,MAAM,cAAc,4DAAgD;AACpE,MAAM,gBAAgB,4DAAkD,wBAAwB,kBAAkB;AAElH,MAAM;IACJ,OAAe,SAA6B;IAE5C,OAAc,cAAkC;QAC9C,IAAI,CAAC,eAAe,QAAQ,EAAE;YAC5B,qCAAqC;YACrC,IAAI,MAAM;YACV,IAAI,QAAQ;YAEZ;;YAaA,eAAe,QAAQ,GAAG,IAAI,gKAAkB,CAAC;gBAC/C,KAAK;gBACL,WAAW;YACb;QACF;QACA,OAAO,eAAe,QAAQ;IAChC;AACF;AAEO,MAAM,WAAW,eAAe,WAAW;AAE3C,MAAM,cAAc;IACzB,OAAO;AACT;AAGO,MAAM;;IACX,YAAY,AAAQ,GAAW,CAAE;aAAb,MAAA;IAAe;IACnC,wBAAwB;IACxB,MAAM,MAAM,IAAY,EAAE,IAAS,EAAE;QAAE,QAAQ,IAAI,CAAC,sCAAsC,MAAM;QAAO,OAAO;IAAM;IACpH,MAAM,SAAS,IAAY,EAAE,IAAS,EAAE;QAAE,QAAQ,IAAI,CAAC,yCAAyC,MAAM;QAAO,OAAO;IAAM;IAC1H,MAAM,OAAO,IAAY,EAAE,IAAS,EAAE;QAAE,QAAQ,IAAI,CAAC,uCAAuC,MAAM;QAAO,OAAO;IAAM;AACxH;AAEO,SAAS,sBAAsB,IAAY;IAChD,OAAO;AACT;AAEO,MAAM;;IACX,YAAY,AAAQ,GAAW,CAAE;aAAb,MAAA;IAAe;AACrC;AAEO,MAAM,iBAAiB,CAAC,EAAE,MAAM,EAAE,QAAQ,EAAO,GAAK;AACtD,MAAM,0BAA0B,CAAC,EAAE,MAAM,EAAE,QAAQ,EAAO,GAAK"}},
    {"offset": {"line": 494, "column": 0}, "map": {"version":3,"sources":["file:///Users/jamesspalding/OpenClaw-OS/src/lib/security.ts"],"sourcesContent":["/**\n * Security Monitoring Library\n *\n * Client-side utilities for security event logging and device fingerprinting.\n */\n\nimport { ConvexHttpClient } from \"@/lib/openclaw/client\";\nimport { makeFunctionReference } from \"@/lib/openclaw/client\";\n\n// Lazy-initialized Convex client for server-side logging\nlet _convexSecurityClient: ConvexHttpClient | null = null;\nfunction getSecurityConvexClient(): ConvexHttpClient | null {\n  if (_convexSecurityClient === null && process.env.NEXT_PUBLIC_CONVEX_URL) {\n    _convexSecurityClient = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL);\n  }\n  return _convexSecurityClient;\n}\n\n// =============================================================================\n// Types\n// =============================================================================\n\nexport type SecurityEventType =\n  | \"admin_login_success\"\n  | \"admin_login_failed\"\n  | \"admin_logout\"\n  | \"passcode_unlock_success\"\n  | \"passcode_unlock_failed\"\n  | \"ipod_auth_success\"\n  | \"ipod_auth_failed\"\n  | \"clerk_signin\"\n  | \"clerk_signout\"\n  | \"api_request\"\n  | \"api_error\"\n  | \"rate_limit_hit\"\n  | \"brute_force_attempt\"\n  | \"suspicious_ip\"\n  | \"session_hijack_attempt\"\n  | \"invalid_token\"\n  | \"geo_anomaly\"\n  | \"system_alert\"\n  | \"config_change\";\n\nexport type SecuritySeverity = \"info\" | \"warning\" | \"critical\" | \"alert\";\n\nexport type ActorType =\n  | \"anonymous\"\n  | \"admin\"\n  | \"user\"\n  | \"collaborator\"\n  | \"system\";\n\nexport interface SecurityEventPayload {\n  eventType: SecurityEventType;\n  severity: SecuritySeverity;\n  actorType: ActorType;\n  actorId?: string;\n  actorEmail?: string;\n  message: string;\n  metadata?: Record<string, unknown>;\n  targetResource?: string;\n  targetId?: string;\n}\n\nexport interface GeoData {\n  country?: string;\n  region?: string;\n  city?: string;\n  latitude?: number;\n  longitude?: number;\n}\n\nexport interface DeviceInfo {\n  fingerprint?: string;\n  deviceType?: string;\n  browser?: string;\n  os?: string;\n}\n\n// =============================================================================\n// Device Detection\n// =============================================================================\n\n/**\n * Parse user agent to extract device info\n */\nexport function parseUserAgent(ua: string): DeviceInfo {\n  const info: DeviceInfo = {};\n\n  // Detect device type\n  if (/bot|crawler|spider|crawling/i.test(ua)) {\n    info.deviceType = \"bot\";\n  } else if (/mobile|android|iphone|ipad|ipod|blackberry|windows phone/i.test(ua)) {\n    if (/ipad|tablet|playbook|silk/i.test(ua)) {\n      info.deviceType = \"tablet\";\n    } else {\n      info.deviceType = \"mobile\";\n    }\n  } else {\n    info.deviceType = \"desktop\";\n  }\n\n  // Detect browser\n  if (/firefox/i.test(ua)) {\n    info.browser = \"Firefox\";\n  } else if (/edg/i.test(ua)) {\n    info.browser = \"Edge\";\n  } else if (/chrome|chromium|crios/i.test(ua)) {\n    info.browser = \"Chrome\";\n  } else if (/safari/i.test(ua)) {\n    info.browser = \"Safari\";\n  } else if (/opera|opr/i.test(ua)) {\n    info.browser = \"Opera\";\n  } else if (/msie|trident/i.test(ua)) {\n    info.browser = \"IE\";\n  } else {\n    info.browser = \"Unknown\";\n  }\n\n  // Detect OS\n  if (/windows/i.test(ua)) {\n    info.os = \"Windows\";\n  } else if (/macintosh|mac os x/i.test(ua)) {\n    info.os = \"macOS\";\n  } else if (/linux/i.test(ua)) {\n    info.os = \"Linux\";\n  } else if (/android/i.test(ua)) {\n    info.os = \"Android\";\n  } else if (/iphone|ipad|ipod/i.test(ua)) {\n    info.os = \"iOS\";\n  } else {\n    info.os = \"Unknown\";\n  }\n\n  return info;\n}\n\n/**\n * Generate a simple device fingerprint (server-side)\n */\nexport function generateFingerprint(\n  ip: string,\n  ua: string,\n  acceptLanguage?: string\n): string {\n  // Create a simple hash from available data\n  const data = `${ip}|${ua}|${acceptLanguage || \"\"}`;\n  let hash = 0;\n  for (let i = 0; i < data.length; i++) {\n    const char = data.charCodeAt(i);\n    hash = (hash << 5) - hash + char;\n    hash = hash & hash; // Convert to 32-bit integer\n  }\n  return Math.abs(hash).toString(16).padStart(8, \"0\");\n}\n\n// =============================================================================\n// Server-Side Logging (for API routes)\n// =============================================================================\n\n/**\n * Log a security event from a server-side context (API route)\n */\nexport async function logSecurityEvent(\n  payload: SecurityEventPayload,\n  request: Request,\n  geoData?: GeoData\n): Promise<void> {\n  try {\n    const client = getSecurityConvexClient();\n    if (!client) {\n      console.warn(\"[Security] Convex client not available, logging to console only\");\n      console.log(\"[Security Event]\", payload.eventType, payload.message);\n      return;\n    }\n\n    const ip = getClientIp(request);\n    const userAgent = request.headers.get(\"user-agent\") || \"unknown\";\n    const deviceInfo = parseUserAgent(userAgent);\n    const fingerprint = generateFingerprint(ip, userAgent);\n\n    // Use makeFunctionReference to avoid type generation dependency\n    const logSecurityEventMutation = makeFunctionReference<\n      \"mutation\",\n      {\n        eventType: SecurityEventType;\n        severity: SecuritySeverity;\n        actorType: ActorType;\n        actorId?: string;\n        actorEmail?: string;\n        message: string;\n        metadata?: Record<string, unknown>;\n        targetResource?: string;\n        targetId?: string;\n        ipAddress: string;\n        userAgent: string;\n        fingerprint: string;\n        deviceType?: string;\n        browser?: string;\n        os?: string;\n        country?: string;\n        region?: string;\n        city?: string;\n      },\n      void\n    >(\"security:logSecurityEvent\");\n\n    await client.mutation(logSecurityEventMutation, {\n      eventType: payload.eventType,\n      severity: payload.severity,\n      actorType: payload.actorType,\n      actorId: payload.actorId,\n      actorEmail: payload.actorEmail,\n      message: payload.message,\n      metadata: payload.metadata,\n      targetResource: payload.targetResource,\n      targetId: payload.targetId,\n      ipAddress: ip,\n      userAgent,\n      fingerprint,\n      deviceType: deviceInfo.deviceType,\n      browser: deviceInfo.browser,\n      os: deviceInfo.os,\n      country: geoData?.country,\n      region: geoData?.region,\n      city: geoData?.city,\n    });\n\n    console.log(\"[Security] Event logged:\", payload.eventType, payload.severity);\n  } catch (error) {\n    // Log to console as fallback, never fail silently\n    console.error(\"[Security] Failed to log event to Convex:\", error);\n    console.log(\"[Security Event Fallback]\", payload.eventType, payload.message);\n  }\n}\n\n/**\n * Extract client IP from request headers\n * Handles Vercel, Cloudflare, and standard proxies\n */\nexport function getClientIp(request: Request): string {\n  // Try various headers in order of preference\n  const headers = request.headers;\n\n  // Vercel\n  const vercelIp = headers.get(\"x-vercel-forwarded-for\");\n  if (vercelIp) {\n    return vercelIp.split(\",\")[0].trim();\n  }\n\n  // Cloudflare\n  const cfIp = headers.get(\"cf-connecting-ip\");\n  if (cfIp) {\n    return cfIp;\n  }\n\n  // Standard proxy header\n  const forwardedFor = headers.get(\"x-forwarded-for\");\n  if (forwardedFor) {\n    return forwardedFor.split(\",\")[0].trim();\n  }\n\n  // Real IP header\n  const realIp = headers.get(\"x-real-ip\");\n  if (realIp) {\n    return realIp;\n  }\n\n  // Fallback\n  return \"unknown\";\n}\n\n// =============================================================================\n// Rate Limiting Helper\n// =============================================================================\n\n// In-memory rate limit tracker (use Redis in production)\nconst rateLimitMap = new Map<string, { count: number; resetAt: number }>();\n\nexport interface RateLimitConfig {\n  windowMs: number; // Time window in milliseconds\n  maxRequests: number; // Max requests per window\n}\n\nexport interface RateLimitResult {\n  allowed: boolean;\n  remaining: number;\n  resetAt: number;\n}\n\n/**\n * Check and update rate limit for a key (IP, user ID, etc.)\n */\nexport function checkRateLimit(\n  key: string,\n  config: RateLimitConfig\n): RateLimitResult {\n  const now = Date.now();\n  const existing = rateLimitMap.get(key);\n\n  if (!existing || existing.resetAt < now) {\n    // New window\n    const resetAt = now + config.windowMs;\n    rateLimitMap.set(key, { count: 1, resetAt });\n    return {\n      allowed: true,\n      remaining: config.maxRequests - 1,\n      resetAt,\n    };\n  }\n\n  if (existing.count >= config.maxRequests) {\n    return {\n      allowed: false,\n      remaining: 0,\n      resetAt: existing.resetAt,\n    };\n  }\n\n  existing.count++;\n  return {\n    allowed: true,\n    remaining: config.maxRequests - existing.count,\n    resetAt: existing.resetAt,\n  };\n}\n\n// Clean up old rate limit entries periodically\nif (typeof setInterval !== \"undefined\") {\n  setInterval(() => {\n    const now = Date.now();\n    for (const [key, value] of rateLimitMap.entries()) {\n      if (value.resetAt < now) {\n        rateLimitMap.delete(key);\n      }\n    }\n  }, 60000); // Clean up every minute\n}\n\n// =============================================================================\n// Brute Force Detection\n// =============================================================================\n\n// Track failed attempts per IP\nconst failedAttempts = new Map<\n  string,\n  { count: number; firstAttempt: number }\n>();\n\nexport interface BruteForceConfig {\n  maxAttempts: number; // Max failed attempts before flagging\n  windowMs: number; // Time window to count attempts\n}\n\n/**\n * Record a failed attempt and check for brute force\n */\nexport function recordFailedAttempt(\n  ip: string,\n  config: BruteForceConfig = { maxAttempts: 5, windowMs: 15 * 60 * 1000 }\n): boolean {\n  const now = Date.now();\n  const existing = failedAttempts.get(ip);\n\n  if (!existing || now - existing.firstAttempt > config.windowMs) {\n    // New window\n    failedAttempts.set(ip, { count: 1, firstAttempt: now });\n    return false;\n  }\n\n  existing.count++;\n  return existing.count >= config.maxAttempts;\n}\n\n/**\n * Clear failed attempts for an IP (call on successful login)\n */\nexport function clearFailedAttempts(ip: string): void {\n  failedAttempts.delete(ip);\n}\n\n// =============================================================================\n// Geo Lookup (using ip-api.com - free for non-commercial)\n// =============================================================================\n\nconst geoCache = new Map<string, { data: GeoData; cachedAt: number }>();\nconst GEO_CACHE_TTL = 24 * 60 * 60 * 1000; // 24 hours\n\n/**\n * Look up geolocation for an IP address\n */\nexport async function lookupGeo(ip: string): Promise<GeoData | null> {\n  // Skip local/private IPs\n  if (\n    ip === \"unknown\" ||\n    ip === \"127.0.0.1\" ||\n    ip.startsWith(\"192.168.\") ||\n    ip.startsWith(\"10.\") ||\n    ip.startsWith(\"172.\")\n  ) {\n    return null;\n  }\n\n  // Check cache\n  const cached = geoCache.get(ip);\n  if (cached && Date.now() - cached.cachedAt < GEO_CACHE_TTL) {\n    return cached.data;\n  }\n\n  try {\n    const response = await fetch(\n      `http://ip-api.com/json/${ip}?fields=country,regionName,city,lat,lon`,\n      { signal: AbortSignal.timeout(2000) }\n    );\n\n    if (!response.ok) {\n      return null;\n    }\n\n    const data = await response.json();\n\n    if (data.status === \"fail\") {\n      return null;\n    }\n\n    const geoData: GeoData = {\n      country: data.country,\n      region: data.regionName,\n      city: data.city,\n      latitude: data.lat,\n      longitude: data.lon,\n    };\n\n    // Cache the result\n    geoCache.set(ip, { data: geoData, cachedAt: Date.now() });\n\n    return geoData;\n  } catch {\n    return null;\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 769, "column": 0}, "map": {"version":3,"sources":["file:///Users/jamesspalding/OpenClaw-OS/src/app/api/auth/admin/route.ts"],"sourcesContent":["/**\n * Admin Authentication API\n *\n * Handles master admin login with username/password.\n * Includes security event logging for all auth attempts.\n */\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport { cookies } from 'next/headers';\nimport crypto from 'crypto';\nimport {\n  ADMIN_COOKIE,\n  createAdminSession,\n  verifySession,\n} from '@/lib/passcodeAuth';\nimport {\n  logSecurityEvent,\n  getClientIp,\n  recordFailedAttempt,\n  clearFailedAttempts,\n} from '@/lib/security';\n\n// SECURITY: Admin credentials from environment - no defaults allowed\nfunction getAdminUsername(): string {\n  const username = process.env.ADMIN_USERNAME;\n  if (!username) {\n    throw new Error('ADMIN_USERNAME environment variable is required');\n  }\n  return username;\n}\n\nfunction getAdminPasswordHash(): string {\n  const hash = process.env.ADMIN_PASSWORD_HASH;\n  if (!hash) {\n    throw new Error('ADMIN_PASSWORD_HASH environment variable is required');\n  }\n  return hash;\n}\n\n// Hash a password for comparison\nfunction hashPassword(password: string): string {\n  const secret = process.env.PASSCODE_SECRET;\n  if (!secret) {\n    throw new Error('PASSCODE_SECRET environment variable is required');\n  }\n  return crypto\n    .createHash('sha256')\n    .update(password + secret)\n    .digest('hex');\n}\n\n// Timing-safe comparison\nfunction safeCompare(a: string, b: string): boolean {\n  const bufA = Buffer.from(a);\n  const bufB = Buffer.from(b);\n  if (bufA.length !== bufB.length) return false;\n  return crypto.timingSafeEqual(bufA, bufB);\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const { username, password } = await request.json();\n\n    if (!username || !password) {\n      return NextResponse.json(\n        { error: 'Username and password required' },\n        { status: 400 }\n      );\n    }\n\n    // Verify username\n    if (username !== getAdminUsername()) {\n      const ip = getClientIp(request);\n      const isBruteForce = recordFailedAttempt(ip);\n\n      // Log failed attempt\n      await logSecurityEvent(\n        {\n          eventType: 'admin_login_failed',\n          severity: isBruteForce ? 'critical' : 'warning',\n          actorType: 'anonymous',\n          message: isBruteForce\n            ? `Brute force detected: Multiple failed admin login attempts from ${ip}`\n            : `Failed admin login attempt: Invalid username \"${username}\"`,\n          targetResource: '/api/auth/admin',\n        },\n        request\n      );\n\n      if (isBruteForce) {\n        await logSecurityEvent(\n          {\n            eventType: 'brute_force_attempt',\n            severity: 'alert',\n            actorType: 'anonymous',\n            message: `Brute force attack detected: ${ip} exceeded failed login threshold`,\n            targetResource: '/api/auth/admin',\n          },\n          request\n        );\n      }\n\n      return NextResponse.json(\n        { error: 'Invalid credentials' },\n        { status: 401 }\n      );\n    }\n\n    // Verify password\n    const inputHash = hashPassword(password);\n    const expectedHash = getAdminPasswordHash();\n\n    if (!safeCompare(inputHash, expectedHash)) {\n      const ip = getClientIp(request);\n      const isBruteForce = recordFailedAttempt(ip);\n\n      // Log failed attempt\n      await logSecurityEvent(\n        {\n          eventType: 'admin_login_failed',\n          severity: isBruteForce ? 'critical' : 'warning',\n          actorType: 'anonymous',\n          message: isBruteForce\n            ? `Brute force detected: Multiple failed admin login attempts from ${ip}`\n            : 'Failed admin login attempt: Invalid password',\n          targetResource: '/api/auth/admin',\n        },\n        request\n      );\n\n      if (isBruteForce) {\n        await logSecurityEvent(\n          {\n            eventType: 'brute_force_attempt',\n            severity: 'alert',\n            actorType: 'anonymous',\n            message: `Brute force attack detected: ${ip} exceeded failed login threshold`,\n            targetResource: '/api/auth/admin',\n          },\n          request\n        );\n      }\n\n      return NextResponse.json(\n        { error: 'Invalid credentials' },\n        { status: 401 }\n      );\n    }\n\n    // Create session token\n    const token = createAdminSession(username);\n\n    // Set cookie\n    const cookieStore = await cookies();\n    cookieStore.set(ADMIN_COOKIE, token, {\n      httpOnly: true,\n      secure: process.env.NODE_ENV === 'production',\n      sameSite: 'lax',\n      path: '/',\n      maxAge: 60 * 60 * 24, // 24 hours\n    });\n\n    // Clear failed attempts on successful login\n    const ip = getClientIp(request);\n    clearFailedAttempts(ip);\n\n    // Log successful login\n    await logSecurityEvent(\n      {\n        eventType: 'admin_login_success',\n        severity: 'info',\n        actorType: 'admin',\n        actorId: username,\n        message: `Admin login successful: ${username}`,\n        targetResource: '/api/auth/admin',\n      },\n      request\n    );\n\n    return NextResponse.json({ success: true });\n  } catch (error) {\n    console.error('Admin auth error:', error);\n    return NextResponse.json(\n      { error: 'Authentication failed' },\n      { status: 500 }\n    );\n  }\n}\n\n// Check if admin is logged in\nexport async function GET() {\n  try {\n    const cookieStore = await cookies();\n    const token = cookieStore.get(ADMIN_COOKIE)?.value;\n    const session = verifySession(token);\n\n    if (!session || session.type !== 'admin') {\n      return NextResponse.json({ isAuthenticated: false });\n    }\n\n    return NextResponse.json({\n      isAuthenticated: true,\n      username: session.subject,\n    });\n  } catch {\n    return NextResponse.json({ isAuthenticated: false });\n  }\n}\n\n// Logout\nexport async function DELETE(request: NextRequest) {\n  try {\n    const cookieStore = await cookies();\n    const token = cookieStore.get(ADMIN_COOKIE)?.value;\n    const session = verifySession(token);\n\n    cookieStore.delete(ADMIN_COOKIE);\n\n    // Log logout\n    if (session) {\n      await logSecurityEvent(\n        {\n          eventType: 'admin_logout',\n          severity: 'info',\n          actorType: 'admin',\n          actorId: session.subject,\n          message: `Admin logout: ${session.subject}`,\n          targetResource: '/api/auth/admin',\n        },\n        request\n      );\n    }\n\n    return NextResponse.json({ success: true });\n  } catch {\n    return NextResponse.json({ success: true });\n  }\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;;;;;CAKC,GAED;AACA;AACA;AACA;AAKA;;;;;;AAOA,qEAAqE;AACrE,SAAS;IACP,MAAM,WAAW,QAAQ,GAAG,CAAC,cAAc;IAC3C,IAAI,CAAC,UAAU;QACb,MAAM,IAAI,MAAM;IAClB;IACA,OAAO;AACT;AAEA,SAAS;IACP,MAAM,OAAO,QAAQ,GAAG,CAAC,mBAAmB;IAC5C,IAAI,CAAC,MAAM;QACT,MAAM,IAAI,MAAM;IAClB;IACA,OAAO;AACT;AAEA,iCAAiC;AACjC,SAAS,aAAa,QAAgB;IACpC,MAAM,SAAS,QAAQ,GAAG,CAAC,eAAe;IAC1C,IAAI,CAAC,QAAQ;QACX,MAAM,IAAI,MAAM;IAClB;IACA,OAAO,gHAAM,CACV,UAAU,CAAC,UACX,MAAM,CAAC,WAAW,QAClB,MAAM,CAAC;AACZ;AAEA,yBAAyB;AACzB,SAAS,YAAY,CAAS,EAAE,CAAS;IACvC,MAAM,OAAO,OAAO,IAAI,CAAC;IACzB,MAAM,OAAO,OAAO,IAAI,CAAC;IACzB,IAAI,KAAK,MAAM,KAAK,KAAK,MAAM,EAAE,OAAO;IACxC,OAAO,gHAAM,CAAC,eAAe,CAAC,MAAM;AACtC;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,EAAE,QAAQ,EAAE,QAAQ,EAAE,GAAG,MAAM,QAAQ,IAAI;QAEjD,IAAI,CAAC,YAAY,CAAC,UAAU;YAC1B,OAAO,yVAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAiC,GAC1C;gBAAE,QAAQ;YAAI;QAElB;QAEA,kBAAkB;QAClB,IAAI,aAAa,oBAAoB;YACnC,MAAM,KAAK,IAAA,uIAAW,EAAC;YACvB,MAAM,eAAe,IAAA,+IAAmB,EAAC;YAEzC,qBAAqB;YACrB,MAAM,IAAA,4IAAgB,EACpB;gBACE,WAAW;gBACX,UAAU,eAAe,aAAa;gBACtC,WAAW;gBACX,SAAS,eACL,CAAC,gEAAgE,EAAE,IAAI,GACvE,CAAC,8CAA8C,EAAE,SAAS,CAAC,CAAC;gBAChE,gBAAgB;YAClB,GACA;YAGF,IAAI,cAAc;gBAChB,MAAM,IAAA,4IAAgB,EACpB;oBACE,WAAW;oBACX,UAAU;oBACV,WAAW;oBACX,SAAS,CAAC,6BAA6B,EAAE,GAAG,gCAAgC,CAAC;oBAC7E,gBAAgB;gBAClB,GACA;YAEJ;YAEA,OAAO,yVAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAsB,GAC/B;gBAAE,QAAQ;YAAI;QAElB;QAEA,kBAAkB;QAClB,MAAM,YAAY,aAAa;QAC/B,MAAM,eAAe;QAErB,IAAI,CAAC,YAAY,WAAW,eAAe;YACzC,MAAM,KAAK,IAAA,uIAAW,EAAC;YACvB,MAAM,eAAe,IAAA,+IAAmB,EAAC;YAEzC,qBAAqB;YACrB,MAAM,IAAA,4IAAgB,EACpB;gBACE,WAAW;gBACX,UAAU,eAAe,aAAa;gBACtC,WAAW;gBACX,SAAS,eACL,CAAC,gEAAgE,EAAE,IAAI,GACvE;gBACJ,gBAAgB;YAClB,GACA;YAGF,IAAI,cAAc;gBAChB,MAAM,IAAA,4IAAgB,EACpB;oBACE,WAAW;oBACX,UAAU;oBACV,WAAW;oBACX,SAAS,CAAC,6BAA6B,EAAE,GAAG,gCAAgC,CAAC;oBAC7E,gBAAgB;gBAClB,GACA;YAEJ;YAEA,OAAO,yVAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAsB,GAC/B;gBAAE,QAAQ;YAAI;QAElB;QAEA,uBAAuB;QACvB,MAAM,QAAQ,IAAA,kJAAkB,EAAC;QAEjC,aAAa;QACb,MAAM,cAAc,MAAM,IAAA,qVAAO;QACjC,YAAY,GAAG,CAAC,4IAAY,EAAE,OAAO;YACnC,UAAU;YACV,QAAQ,oDAAyB;YACjC,UAAU;YACV,MAAM;YACN,QAAQ,KAAK,KAAK;QACpB;QAEA,4CAA4C;QAC5C,MAAM,KAAK,IAAA,uIAAW,EAAC;QACvB,IAAA,+IAAmB,EAAC;QAEpB,uBAAuB;QACvB,MAAM,IAAA,4IAAgB,EACpB;YACE,WAAW;YACX,UAAU;YACV,WAAW;YACX,SAAS;YACT,SAAS,CAAC,wBAAwB,EAAE,UAAU;YAC9C,gBAAgB;QAClB,GACA;QAGF,OAAO,yVAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;IAC3C,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qBAAqB;QACnC,OAAO,yVAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAwB,GACjC;YAAE,QAAQ;QAAI;IAElB;AACF;AAGO,eAAe;IACpB,IAAI;QACF,MAAM,cAAc,MAAM,IAAA,qVAAO;QACjC,MAAM,QAAQ,YAAY,GAAG,CAAC,4IAAY,GAAG;QAC7C,MAAM,UAAU,IAAA,6IAAa,EAAC;QAE9B,IAAI,CAAC,WAAW,QAAQ,IAAI,KAAK,SAAS;YACxC,OAAO,yVAAY,CAAC,IAAI,CAAC;gBAAE,iBAAiB;YAAM;QACpD;QAEA,OAAO,yVAAY,CAAC,IAAI,CAAC;YACvB,iBAAiB;YACjB,UAAU,QAAQ,OAAO;QAC3B;IACF,EAAE,OAAM;QACN,OAAO,yVAAY,CAAC,IAAI,CAAC;YAAE,iBAAiB;QAAM;IACpD;AACF;AAGO,eAAe,OAAO,OAAoB;IAC/C,IAAI;QACF,MAAM,cAAc,MAAM,IAAA,qVAAO;QACjC,MAAM,QAAQ,YAAY,GAAG,CAAC,4IAAY,GAAG;QAC7C,MAAM,UAAU,IAAA,6IAAa,EAAC;QAE9B,YAAY,MAAM,CAAC,4IAAY;QAE/B,aAAa;QACb,IAAI,SAAS;YACX,MAAM,IAAA,4IAAgB,EACpB;gBACE,WAAW;gBACX,UAAU;gBACV,WAAW;gBACX,SAAS,QAAQ,OAAO;gBACxB,SAAS,CAAC,cAAc,EAAE,QAAQ,OAAO,EAAE;gBAC3C,gBAAgB;YAClB,GACA;QAEJ;QAEA,OAAO,yVAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;IAC3C,EAAE,OAAM;QACN,OAAO,yVAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;IAC3C;AACF"}}]
}