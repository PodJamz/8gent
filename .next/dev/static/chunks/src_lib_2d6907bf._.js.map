{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/jamesspalding/OpenClaw-OS/src/lib/claw-ai/slash-command-registry.ts"],"sourcesContent":["/**\n * Slash Command Registry - Comprehensive command system for Claw AI Chat\n *\n * Exposes all tools, skills, dimensions, and context as / commands and @ references\n */\n\nimport {\n  Search,\n  Compass,\n  Calendar,\n  FileText,\n  Brain,\n  Code,\n  Layers,\n  Palette,\n  Music,\n  Terminal,\n  GitBranch,\n  MessageSquare,\n  Video,\n  Zap,\n  Settings,\n  HelpCircle,\n  Sparkles,\n  Target,\n  Clock,\n  LayoutGrid,\n  Table,\n  LineChart,\n  List,\n  Users,\n  BookOpen,\n  Shield,\n  Cpu,\n  Image,\n  Mic,\n  Play,\n  Globe,\n  Folder,\n  Database,\n  Bot,\n  Wand2,\n  PenTool,\n  Eye,\n  Accessibility,\n  Smartphone,\n  Move3D,\n  Boxes,\n  FlaskConical,\n  type LucideIcon,\n} from 'lucide-react';\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport type CommandCategory =\n  | 'navigation'\n  | 'tools'\n  | 'skills'\n  | 'dimensions'\n  | 'context'\n  | 'media'\n  | 'code'\n  | 'memory'\n  | 'product'\n  | 'quick';\n\nexport interface SlashCommand {\n  /** Command name without the leading slash */\n  name: string;\n  /** Aliases that also trigger this command */\n  aliases?: string[];\n  /** Human-readable label */\n  label: string;\n  /** Description shown in picker */\n  description: string;\n  /** Category for grouping */\n  category: CommandCategory;\n  /** Icon component */\n  icon: LucideIcon;\n  /** Color for the icon */\n  color: string;\n  /** If true, only available to owner */\n  ownerOnly?: boolean;\n  /** If the command takes a parameter, describe it */\n  parameter?: {\n    name: string;\n    description: string;\n    required?: boolean;\n    type: 'text' | 'select' | 'reference';\n    options?: string[];\n  };\n  /** The actual tool name to call (if different from name) */\n  toolName?: string;\n  /** For navigation commands, the destination */\n  destination?: string;\n  /** For context commands, the context type to insert */\n  contextType?: string;\n}\n\n// ============================================================================\n// Navigation Commands\n// ============================================================================\n\nexport const NAVIGATION_COMMANDS: SlashCommand[] = [\n  {\n    name: 'home',\n    aliases: ['start', 'main'],\n    label: 'Home',\n    description: 'Go to the home screen',\n    category: 'navigation',\n    icon: Compass,\n    color: '#f59e0b',\n    destination: '/',\n  },\n  {\n    name: 'chat',\n    label: 'Chat',\n    description: 'Open full chat interface',\n    category: 'navigation',\n    icon: MessageSquare,\n    color: '#3b82f6',\n    destination: '/chat',\n  },\n  {\n    name: 'canvas',\n    aliases: ['design-canvas'],\n    label: 'Design Canvas',\n    description: 'Open the infinite design canvas',\n    category: 'navigation',\n    icon: LayoutGrid,\n    color: '#10b981',\n    destination: '/canvas',\n  },\n  {\n    name: 'projects',\n    aliases: ['kanban', 'tasks'],\n    label: 'Projects',\n    description: 'View projects and kanban board',\n    category: 'navigation',\n    icon: Layers,\n    color: '#8b5cf6',\n    destination: '/projects',\n  },\n  {\n    name: 'design',\n    aliases: ['themes'],\n    label: 'Design Themes',\n    description: 'Explore 50+ design themes',\n    category: 'navigation',\n    icon: Palette,\n    color: '#ec4899',\n    destination: '/design',\n  },\n  {\n    name: 'resume',\n    aliases: ['cv', 'about'],\n    label: 'Resume',\n    description: 'View James\\'s resume',\n    category: 'navigation',\n    icon: FileText,\n    color: '#6366f1',\n    destination: '/resume',\n  },\n  {\n    name: 'music',\n    aliases: ['jamz', 'tracks'],\n    label: 'Music',\n    description: 'Listen to music and tracks',\n    category: 'navigation',\n    icon: Music,\n    color: '#ef4444',\n    destination: '/music',\n  },\n  {\n    name: 'video',\n    aliases: ['studio'],\n    label: 'Video Studio',\n    description: 'Create and edit videos',\n    category: 'navigation',\n    icon: Video,\n    color: '#f97316',\n    destination: '/video',\n  },\n  {\n    name: 'agent',\n    aliases: ['infinity', 'coding'],\n    label: 'Agent',\n    description: 'Open the coding agent',\n    category: 'navigation',\n    icon: Bot,\n    color: '#14b8a6',\n    destination: '/agent',\n    ownerOnly: true,\n  },\n  {\n    name: 'memory',\n    aliases: ['memories'],\n    label: 'Memory Control',\n    description: 'View and manage AI memories',\n    category: 'navigation',\n    icon: Brain,\n    color: '#a855f7',\n    destination: '/memory',\n    ownerOnly: true,\n  },\n  {\n    name: 'settings',\n    label: 'Settings',\n    description: 'Open settings',\n    category: 'navigation',\n    icon: Settings,\n    color: '#6b7280',\n    destination: '/settings',\n    ownerOnly: true,\n  },\n];\n\n// ============================================================================\n// Tool Commands (mapped from CLAW_AI_TOOLS)\n// ============================================================================\n\nexport const TOOL_COMMANDS: SlashCommand[] = [\n  // Search & Discovery\n  {\n    name: 'search',\n    aliases: ['find', 'lookup'],\n    label: 'Search Portfolio',\n    description: 'Search projects, skills, and experience',\n    category: 'tools',\n    icon: Search,\n    color: '#3b82f6',\n    toolName: 'search_portfolio',\n    parameter: {\n      name: 'query',\n      description: 'What to search for',\n      required: true,\n      type: 'text',\n    },\n  },\n  {\n    name: 'weather',\n    label: 'Weather',\n    description: 'Show weather widget',\n    category: 'tools',\n    icon: Globe,\n    color: '#0ea5e9',\n    toolName: 'show_weather',\n    parameter: {\n      name: 'location',\n      description: 'Location (default: San Francisco)',\n      type: 'text',\n    },\n  },\n  {\n    name: 'photos',\n    aliases: ['gallery', 'images'],\n    label: 'Photos',\n    description: 'Show photo gallery',\n    category: 'tools',\n    icon: Image,\n    color: '#f472b6',\n    toolName: 'show_photos',\n  },\n\n  // Scheduling\n  {\n    name: 'schedule',\n    aliases: ['book', 'meeting'],\n    label: 'Schedule Call',\n    description: 'Schedule a call with James',\n    category: 'tools',\n    icon: Calendar,\n    color: '#22c55e',\n    toolName: 'schedule_call',\n    parameter: {\n      name: 'topic',\n      description: 'Topic for the call',\n      type: 'text',\n    },\n  },\n  {\n    name: 'availability',\n    aliases: ['times', 'free'],\n    label: 'Check Availability',\n    description: 'See available meeting times',\n    category: 'tools',\n    icon: Clock,\n    color: '#22c55e',\n    toolName: 'get_available_times',\n    parameter: {\n      name: 'date',\n      description: 'Date to check (YYYY-MM-DD)',\n      type: 'text',\n    },\n  },\n\n  // Memory\n  {\n    name: 'remember',\n    aliases: ['recall'],\n    label: 'Remember',\n    description: 'Search AI memories',\n    category: 'memory',\n    icon: Brain,\n    color: '#a855f7',\n    toolName: 'remember',\n    parameter: {\n      name: 'query',\n      description: 'What to remember',\n      required: true,\n      type: 'text',\n    },\n  },\n  {\n    name: 'memorize',\n    aliases: ['store'],\n    label: 'Memorize',\n    description: 'Store a new memory',\n    category: 'memory',\n    icon: Brain,\n    color: '#a855f7',\n    toolName: 'memorize',\n    ownerOnly: true,\n    parameter: {\n      name: 'content',\n      description: 'Memory content',\n      required: true,\n      type: 'text',\n    },\n  },\n  {\n    name: 'learn',\n    label: 'Learn',\n    description: 'Teach AI a new fact',\n    category: 'memory',\n    icon: BookOpen,\n    color: '#a855f7',\n    toolName: 'learn',\n    ownerOnly: true,\n    parameter: {\n      name: 'knowledge',\n      description: 'What to learn',\n      required: true,\n      type: 'text',\n    },\n  },\n\n  // Product Lifecycle\n  {\n    name: 'project',\n    aliases: ['new-project'],\n    label: 'Create Project',\n    description: 'Create a new product project',\n    category: 'product',\n    icon: Layers,\n    color: '#8b5cf6',\n    toolName: 'create_project',\n    ownerOnly: true,\n    parameter: {\n      name: 'name',\n      description: 'Project name',\n      required: true,\n      type: 'text',\n    },\n  },\n  {\n    name: 'prd',\n    aliases: ['spec', 'requirements'],\n    label: 'Create PRD',\n    description: 'Create Product Requirements Document',\n    category: 'product',\n    icon: FileText,\n    color: '#ec4899',\n    toolName: 'create_prd',\n    ownerOnly: true,\n    parameter: {\n      name: 'title',\n      description: 'PRD title',\n      required: true,\n      type: 'text',\n    },\n  },\n  {\n    name: 'ticket',\n    aliases: ['story', 'task'],\n    label: 'Create Ticket',\n    description: 'Create BMAD user story ticket',\n    category: 'product',\n    icon: Target,\n    color: '#f59e0b',\n    toolName: 'create_ticket',\n    ownerOnly: true,\n    parameter: {\n      name: 'title',\n      description: 'Ticket title',\n      required: true,\n      type: 'text',\n    },\n  },\n  {\n    name: 'kanban',\n    aliases: ['board'],\n    label: 'Show Kanban',\n    description: 'Display kanban board',\n    category: 'product',\n    icon: LayoutGrid,\n    color: '#3b82f6',\n    toolName: 'show_kanban_tasks',\n    parameter: {\n      name: 'filter',\n      description: 'Status filter',\n      type: 'select',\n      options: ['all', 'todo', 'in-progress', 'done', 'backlog'],\n    },\n  },\n\n  // Code & Execution\n  {\n    name: 'clone',\n    aliases: ['repo'],\n    label: 'Clone Repository',\n    description: 'Clone a git repository',\n    category: 'code',\n    icon: GitBranch,\n    color: '#6366f1',\n    toolName: 'clone_repository',\n    ownerOnly: true,\n    parameter: {\n      name: 'url',\n      description: 'Repository URL',\n      required: true,\n      type: 'text',\n    },\n  },\n  {\n    name: 'run',\n    aliases: ['exec', 'cmd'],\n    label: 'Run Command',\n    description: 'Execute a shell command',\n    category: 'code',\n    icon: Terminal,\n    color: '#22c55e',\n    toolName: 'run_command',\n    ownerOnly: true,\n    parameter: {\n      name: 'command',\n      description: 'Command to run',\n      required: true,\n      type: 'text',\n    },\n  },\n  {\n    name: 'read',\n    aliases: ['cat', 'view'],\n    label: 'Read File',\n    description: 'Read a file\\'s contents',\n    category: 'code',\n    icon: FileText,\n    color: '#6366f1',\n    toolName: 'read_file',\n    ownerOnly: true,\n    parameter: {\n      name: 'path',\n      description: 'File path',\n      required: true,\n      type: 'text',\n    },\n  },\n  {\n    name: 'write',\n    aliases: ['save'],\n    label: 'Write File',\n    description: 'Write content to a file',\n    category: 'code',\n    icon: PenTool,\n    color: '#6366f1',\n    toolName: 'write_file',\n    ownerOnly: true,\n    parameter: {\n      name: 'path',\n      description: 'File path',\n      required: true,\n      type: 'text',\n    },\n  },\n  {\n    name: 'search-code',\n    aliases: ['grep'],\n    label: 'Search Codebase',\n    description: 'Search code with regex',\n    category: 'code',\n    icon: Code,\n    color: '#6366f1',\n    toolName: 'search_codebase',\n    ownerOnly: true,\n    parameter: {\n      name: 'pattern',\n      description: 'Search pattern',\n      required: true,\n      type: 'text',\n    },\n  },\n\n  // Media Generation\n  {\n    name: 'generate',\n    aliases: ['create', 'ai'],\n    label: 'Generate',\n    description: 'AI generation on canvas',\n    category: 'media',\n    icon: Sparkles,\n    color: '#f59e0b',\n    toolName: 'generate_on_canvas',\n    parameter: {\n      name: 'prompt',\n      description: 'Generation prompt',\n      required: true,\n      type: 'text',\n    },\n  },\n  {\n    name: 'video-create',\n    aliases: ['render'],\n    label: 'Create Video',\n    description: 'Create a video composition',\n    category: 'media',\n    icon: Video,\n    color: '#f97316',\n    toolName: 'create_video_composition',\n    ownerOnly: true,\n    parameter: {\n      name: 'name',\n      description: 'Video name',\n      required: true,\n      type: 'text',\n    },\n  },\n  {\n    name: 'tts',\n    aliases: ['speak', 'voice'],\n    label: 'Text to Speech',\n    description: 'Generate speech from text',\n    category: 'media',\n    icon: Mic,\n    color: '#22c55e',\n    toolName: 'generate_voice',\n    parameter: {\n      name: 'text',\n      description: 'Text to speak',\n      required: true,\n      type: 'text',\n    },\n  },\n\n  // Channels & Messaging\n  {\n    name: 'message',\n    aliases: ['send'],\n    label: 'Send Message',\n    description: 'Send a channel message',\n    category: 'tools',\n    icon: MessageSquare,\n    color: '#3b82f6',\n    toolName: 'send_channel_message',\n    ownerOnly: true,\n    parameter: {\n      name: 'content',\n      description: 'Message content',\n      required: true,\n      type: 'text',\n    },\n  },\n\n  // Utility\n  {\n    name: 'ui',\n    aliases: ['render'],\n    label: 'Render UI',\n    description: 'Render custom UI components',\n    category: 'tools',\n    icon: Boxes,\n    color: '#8b5cf6',\n    toolName: 'render_ui',\n  },\n  {\n    name: 'cron',\n    aliases: ['schedule-job'],\n    label: 'Create Cron Job',\n    description: 'Create a scheduled job',\n    category: 'tools',\n    icon: Clock,\n    color: '#f59e0b',\n    toolName: 'create_cron_job',\n    ownerOnly: true,\n    parameter: {\n      name: 'expression',\n      description: 'Cron expression',\n      required: true,\n      type: 'text',\n    },\n  },\n];\n\n// ============================================================================\n// Skill Commands (from .claude/skills/)\n// ============================================================================\n\nexport const SKILL_COMMANDS: SlashCommand[] = [\n  // Design Skills\n  {\n    name: 'skill-design',\n    aliases: ['design-excellence'],\n    label: 'Design Excellence',\n    description: 'High-impact interface design principles',\n    category: 'skills',\n    icon: Palette,\n    color: '#ec4899',\n    contextType: 'skill:design-excellence',\n  },\n  {\n    name: 'skill-ui',\n    aliases: ['ui-constraints'],\n    label: 'UI Constraints',\n    description: 'Opinionated UI guidelines (Tailwind, no gradients)',\n    category: 'skills',\n    icon: PenTool,\n    color: '#ec4899',\n    contextType: 'skill:ui',\n  },\n  {\n    name: 'skill-interface',\n    aliases: ['interface-craft'],\n    label: 'Interface Craft',\n    description: 'Intentional design: clarity, structure, beauty',\n    category: 'skills',\n    icon: Wand2,\n    color: '#ec4899',\n    contextType: 'skill:interface-craft',\n  },\n  {\n    name: 'skill-motion',\n    aliases: ['animation'],\n    label: 'Motion Design',\n    description: 'Animation principles: 100-500ms timing, easing',\n    category: 'skills',\n    icon: Play,\n    color: '#f97316',\n    contextType: 'skill:motion-design',\n  },\n  {\n    name: 'skill-ios',\n    aliases: ['ios-hig'],\n    label: 'iOS Excellence',\n    description: 'iOS HIG patterns: SF Pro, 8pt grid, haptics',\n    category: 'skills',\n    icon: Smartphone,\n    color: '#3b82f6',\n    contextType: 'skill:ios-excellence',\n  },\n  {\n    name: 'skill-a11y',\n    aliases: ['accessibility'],\n    label: 'Accessibility Review',\n    description: 'A11y QA: keyboard, screen reader, contrast',\n    category: 'skills',\n    icon: Accessibility,\n    color: '#22c55e',\n    contextType: 'skill:accessibility-review',\n  },\n\n  // Development Skills\n  {\n    name: 'skill-react',\n    aliases: ['vercel-best-practices'],\n    label: 'React Best Practices',\n    description: '45+ performance rules across 8 priority tiers',\n    category: 'skills',\n    icon: Code,\n    color: '#3b82f6',\n    contextType: 'skill:vercel-react-best-practices',\n  },\n  {\n    name: 'skill-threejs',\n    aliases: ['3d'],\n    label: 'Three.js Excellence',\n    description: '3D excellence: 7 gallery types, shaders',\n    category: 'skills',\n    icon: Move3D,\n    color: '#8b5cf6',\n    contextType: 'skill:threejs',\n  },\n  {\n    name: 'skill-browser',\n    aliases: ['automation'],\n    label: 'Browser Automation',\n    description: 'Navigation, clicks, forms, screenshots',\n    category: 'skills',\n    icon: Globe,\n    color: '#6366f1',\n    contextType: 'skill:agent-browser',\n  },\n  {\n    name: 'skill-clone',\n    aliases: ['extract'],\n    label: 'Clone React',\n    description: 'Visual component extraction from websites',\n    category: 'skills',\n    icon: Eye,\n    color: '#6366f1',\n    contextType: 'skill:clone-react',\n  },\n\n  // Security & Research\n  {\n    name: 'skill-security',\n    aliases: ['0din', 'red-team'],\n    label: 'Security Research',\n    description: 'AI safety & red teaming with JEF scoring',\n    category: 'skills',\n    icon: Shield,\n    color: '#ef4444',\n    contextType: 'skill:0din-security-research',\n    ownerOnly: true,\n  },\n  {\n    name: 'skill-science',\n    aliases: ['scientific'],\n    label: 'Scientific Skills',\n    description: 'K-Dense: 139 scientific skills',\n    category: 'skills',\n    icon: FlaskConical,\n    color: '#14b8a6',\n    contextType: 'skill:scientific-skills',\n  },\n\n  // Project Management\n  {\n    name: 'skill-pm',\n    aliases: ['project-management'],\n    label: 'Project Management',\n    description: 'GitHub workflow & Kanban methodology',\n    category: 'skills',\n    icon: Target,\n    color: '#f59e0b',\n    contextType: 'skill:project-management',\n  },\n  {\n    name: 'skill-web-design',\n    aliases: ['web-guidelines'],\n    label: 'Web Design Guidelines',\n    description: 'Web design standards and patterns',\n    category: 'skills',\n    icon: Globe,\n    color: '#ec4899',\n    contextType: 'skill:web-design-guidelines',\n  },\n  {\n    name: 'skill-remotion',\n    aliases: ['video-export'],\n    label: 'Remotion Video',\n    description: 'Video export integration',\n    category: 'skills',\n    icon: Video,\n    color: '#f97316',\n    contextType: 'skill:remotion-video-exports',\n  },\n  {\n    name: 'skill-actionbook',\n    aliases: ['web-automation'],\n    label: 'Actionbook Automation',\n    description: 'Web automation patterns',\n    category: 'skills',\n    icon: Zap,\n    color: '#a855f7',\n    contextType: 'skill:actionbook-web-automation',\n  },\n];\n\n// ============================================================================\n// Dimension Commands (ERV Arrangements)\n// ============================================================================\n\nexport const DIMENSION_COMMANDS: SlashCommand[] = [\n  {\n    name: 'dim-kanban',\n    label: 'Kanban View',\n    description: 'View data as kanban board with status columns',\n    category: 'dimensions',\n    icon: LayoutGrid,\n    color: '#3b82f6',\n    toolName: 'navigate_dimension',\n    contextType: 'dimension:kanban',\n  },\n  {\n    name: 'dim-timeline',\n    label: 'Timeline View',\n    description: 'View data chronologically on a timeline',\n    category: 'dimensions',\n    icon: Clock,\n    color: '#22c55e',\n    toolName: 'navigate_dimension',\n    contextType: 'dimension:timeline',\n  },\n  {\n    name: 'dim-graph',\n    label: 'Graph View',\n    description: 'View data as connected nodes',\n    category: 'dimensions',\n    icon: Cpu,\n    color: '#8b5cf6',\n    toolName: 'navigate_dimension',\n    contextType: 'dimension:graph',\n  },\n  {\n    name: 'dim-table',\n    label: 'Table View',\n    description: 'View data in a sortable table',\n    category: 'dimensions',\n    icon: Table,\n    color: '#6b7280',\n    toolName: 'navigate_dimension',\n    contextType: 'dimension:table',\n  },\n  {\n    name: 'dim-feed',\n    label: 'Feed View',\n    description: 'View data as a scrollable feed',\n    category: 'dimensions',\n    icon: List,\n    color: '#f59e0b',\n    toolName: 'navigate_dimension',\n    contextType: 'dimension:feed',\n  },\n  {\n    name: 'dim-calendar',\n    label: 'Calendar View',\n    description: 'View data on a calendar',\n    category: 'dimensions',\n    icon: Calendar,\n    color: '#ef4444',\n    toolName: 'navigate_dimension',\n    contextType: 'dimension:calendar',\n  },\n  {\n    name: 'dim-cards',\n    label: 'Cards View',\n    description: 'View data as visual cards',\n    category: 'dimensions',\n    icon: Boxes,\n    color: '#ec4899',\n    toolName: 'navigate_dimension',\n    contextType: 'dimension:cards',\n  },\n];\n\n// ============================================================================\n// Quick Action Commands\n// ============================================================================\n\nexport const QUICK_COMMANDS: SlashCommand[] = [\n  {\n    name: 'help',\n    aliases: ['?', 'commands'],\n    label: 'Help',\n    description: 'Show all available commands',\n    category: 'quick',\n    icon: HelpCircle,\n    color: '#6b7280',\n  },\n  {\n    name: 'clear',\n    aliases: ['reset'],\n    label: 'Clear Chat',\n    description: 'Clear the current conversation',\n    category: 'quick',\n    icon: Trash2,\n    color: '#ef4444',\n  },\n  {\n    name: 'voice',\n    aliases: ['tts-toggle'],\n    label: 'Toggle Voice',\n    description: 'Toggle voice responses on/off',\n    category: 'quick',\n    icon: Mic,\n    color: '#22c55e',\n  },\n  {\n    name: 'new',\n    aliases: ['new-chat'],\n    label: 'New Thread',\n    description: 'Start a new conversation',\n    category: 'quick',\n    icon: MessageSquare,\n    color: '#3b82f6',\n  },\n];\n\n// Import Trash2 for clear command\nimport { Trash2 } from 'lucide-react';\n\n// ============================================================================\n// Combined Registry\n// ============================================================================\n\nexport const ALL_SLASH_COMMANDS: SlashCommand[] = [\n  ...QUICK_COMMANDS,\n  ...NAVIGATION_COMMANDS,\n  ...TOOL_COMMANDS,\n  ...SKILL_COMMANDS,\n  ...DIMENSION_COMMANDS,\n];\n\n// ============================================================================\n// Helper Functions\n// ============================================================================\n\n/**\n * Search commands by query string\n */\nexport function searchCommands(\n  query: string,\n  options?: {\n    categories?: CommandCategory[];\n    includeOwnerOnly?: boolean;\n  }\n): SlashCommand[] {\n  const normalizedQuery = query.toLowerCase().replace(/^\\//, '');\n\n  let commands = ALL_SLASH_COMMANDS;\n\n  // Filter by owner-only\n  if (!options?.includeOwnerOnly) {\n    commands = commands.filter((cmd) => !cmd.ownerOnly);\n  }\n\n  // Filter by categories\n  if (options?.categories?.length) {\n    commands = commands.filter((cmd) => options.categories!.includes(cmd.category));\n  }\n\n  // No query? Return all matching commands\n  if (!normalizedQuery) {\n    return commands.slice(0, 20);\n  }\n\n  // Search by name, aliases, and label\n  return commands.filter((cmd) => {\n    const matchesName = cmd.name.toLowerCase().includes(normalizedQuery);\n    const matchesAlias = cmd.aliases?.some((a) => a.toLowerCase().includes(normalizedQuery));\n    const matchesLabel = cmd.label.toLowerCase().includes(normalizedQuery);\n    const matchesDescription = cmd.description.toLowerCase().includes(normalizedQuery);\n    return matchesName || matchesAlias || matchesLabel || matchesDescription;\n  });\n}\n\n/**\n * Get a command by exact name or alias\n */\nexport function getCommand(name: string): SlashCommand | undefined {\n  const normalizedName = name.toLowerCase().replace(/^\\//, '');\n  return ALL_SLASH_COMMANDS.find(\n    (cmd) =>\n      cmd.name === normalizedName || cmd.aliases?.includes(normalizedName)\n  );\n}\n\n/**\n * Get commands grouped by category\n */\nexport function getCommandsByCategory(\n  includeOwnerOnly = false\n): Record<CommandCategory, SlashCommand[]> {\n  const commands = includeOwnerOnly\n    ? ALL_SLASH_COMMANDS\n    : ALL_SLASH_COMMANDS.filter((cmd) => !cmd.ownerOnly);\n\n  return commands.reduce(\n    (acc, cmd) => {\n      if (!acc[cmd.category]) {\n        acc[cmd.category] = [];\n      }\n      acc[cmd.category].push(cmd);\n      return acc;\n    },\n    {} as Record<CommandCategory, SlashCommand[]>\n  );\n}\n\n/**\n * Category labels for display\n */\nexport const CATEGORY_LABELS: Record<CommandCategory, string> = {\n  quick: 'Quick Actions',\n  navigation: 'Navigation',\n  tools: 'Tools',\n  skills: 'Skills',\n  dimensions: 'Dimensions',\n  context: 'Context',\n  media: 'Media',\n  code: 'Code & Execution',\n  memory: 'Memory',\n  product: 'Product Lifecycle',\n};\n\n/**\n * Category colors for display\n */\nexport const CATEGORY_COLORS: Record<CommandCategory, string> = {\n  quick: '#6b7280',\n  navigation: '#f59e0b',\n  tools: '#3b82f6',\n  skills: '#8b5cf6',\n  dimensions: '#10b981',\n  context: '#ec4899',\n  media: '#f97316',\n  code: '#6366f1',\n  memory: '#a855f7',\n  product: '#22c55e',\n};\n\n/**\n * Format a command for display in the picker\n */\nexport function formatCommandPreview(cmd: SlashCommand): string {\n  let preview = `/${cmd.name}`;\n  if (cmd.parameter) {\n    preview += cmd.parameter.required\n      ? ` <${cmd.parameter.name}>`\n      : ` [${cmd.parameter.name}]`;\n  }\n  return preview;\n}\n\n/**\n * Parse a command string into command + arguments\n */\nexport function parseCommandString(input: string): {\n  command: SlashCommand | undefined;\n  args: string;\n} {\n  const match = input.match(/^\\/(\\S+)(?:\\s+(.*))?$/);\n  if (!match) {\n    return { command: undefined, args: '' };\n  }\n\n  const [, cmdName, args = ''] = match;\n  const command = getCommand(cmdName);\n\n  return { command, args: args.trim() };\n}\n\nexport default ALL_SLASH_COMMANDS;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1066, "column": 0}, "map": {"version":3,"sources":["file:///Users/jamesspalding/OpenClaw-OS/src/lib/episode/types.ts"],"sourcesContent":["// =============================================================================\n// Cartoon Episode Production System - Core Types\n// =============================================================================\n// \"Dad & Lad\" animated short episode pipeline\n// Music-first, beat-synced, style-consistent cartoon production\n// =============================================================================\n\n// -----------------------------------------------------------------------------\n// Beat Analysis Types\n// -----------------------------------------------------------------------------\n\nexport type BeatType = 'kick' | 'snare' | 'hihat' | 'crash' | 'other';\n\nexport interface Beat {\n  /** Time in milliseconds from start of track */\n  timeMs: number;\n  /** Classified percussion type */\n  type: BeatType;\n  /** Intensity 0-1 */\n  intensity: number;\n  /** Whether this is beat 1 of a measure */\n  isDownbeat: boolean;\n  /** Measure number (1-indexed) */\n  measure: number;\n  /** Beat position within measure (1-indexed) */\n  beatInMeasure: number;\n}\n\nexport type SongSectionType =\n  | 'intro'\n  | 'verse'\n  | 'prechorus'\n  | 'chorus'\n  | 'bridge'\n  | 'outro'\n  | 'break'\n  | 'solo';\n\nexport interface SongSection {\n  type: SongSectionType;\n  startMs: number;\n  endMs: number;\n  /** Human-readable label like \"verse1\", \"chorus2\" */\n  label: string;\n  /** Average energy level 0-1 */\n  energy: number;\n}\n\nexport interface EnergyPoint {\n  timeMs: number;\n  energy: number; // 0-1 normalized\n}\n\nexport interface BeatMap {\n  songId: string;\n  bpm: number;\n  timeSignature: string; // \"4/4\", \"3/4\", etc.\n  durationMs: number;\n  beats: Beat[];\n  sections: SongSection[];\n  energyCurve: EnergyPoint[];\n  /** Analysis metadata */\n  analysis: {\n    method: 'web-audio' | 'librosa' | 'madmom' | 'hybrid' | 'manual';\n    confidence: number; // 0-1\n    analyzedAt: string; // ISO date\n  };\n}\n\n// -----------------------------------------------------------------------------\n// Style Bible Types\n// -----------------------------------------------------------------------------\n\nexport interface CharacterSheet {\n  name: string;\n  description: string;\n  distinguishingFeatures: string[];\n  /** Emotion name â†’ visual description */\n  expressions: Record<string, string>;\n  referenceImages: string[];\n  /** Prompt fragment to invoke this character consistently */\n  promptFragment: string;\n}\n\nexport interface StyleBible {\n  id: string;\n  name: string;\n  artStyle: string;\n  colorPalette: {\n    primary: string[];\n    accent: string[];\n    mood: Record<string, string[]>;\n  };\n  characters: CharacterSheet[];\n  /** Prepended to every generation prompt */\n  promptPrefix: string;\n  /** Appended to every generation prompt */\n  promptSuffix: string;\n  negativePrompt: string;\n  referenceImages: string[];\n  consistency: {\n    environmentStyle: string;\n    lightingStyle: string;\n    lineWeight: string;\n  };\n}\n\n// -----------------------------------------------------------------------------\n// Episode Types\n// -----------------------------------------------------------------------------\n\nexport interface SongReference {\n  id: string;\n  title: string;\n  artist: string;\n  /** URL or path to audio file */\n  audioUrl: string;\n  durationMs: number;\n  beatMap?: BeatMap;\n}\n\nexport type EpisodeStatus =\n  | 'idea'\n  | 'scripted'\n  | 'storyboarded'\n  | 'generating'\n  | 'assembling'\n  | 'review'\n  | 'done';\n\nexport interface Episode {\n  id: string;\n  seriesId: string;\n  number: number;\n  title: string;\n  /** James's verbal/text description of what happens */\n  description: string;\n  song: SongReference;\n  scenes: Scene[];\n  spokenWord: SpokenWordSegment[];\n  status: EpisodeStatus;\n  createdAt: string;\n  updatedAt: string;\n}\n\nexport interface SpokenWordSegment {\n  id: string;\n  text: string;\n  /** When in the song this narration plays */\n  startMs: number;\n  endMs: number;\n  /** Voice to use for TTS */\n  voice?: string;\n  /** Pre-generated audio URL */\n  audioUrl?: string;\n}\n\n// -----------------------------------------------------------------------------\n// Scene Types\n// -----------------------------------------------------------------------------\n\nexport interface Scene {\n  id: string;\n  episodeId: string;\n  order: number;\n  title: string;\n  description: string;\n  /** Emotional tone */\n  emotion: string;\n  /** Which song section this scene maps to */\n  songSection: string;\n  beatWindow: {\n    startMs: number;\n    endMs: number;\n    beatCount: number;\n  };\n  syncPoints: SyncPoint[];\n  clips: GeneratedClip[];\n  transition: TransitionConfig;\n  /** Full prompt built from style bible + scene description */\n  generationPrompt: string;\n}\n\nexport interface SyncPoint {\n  /** Timestamp in song (ms) */\n  beatTimeMs: number;\n  /** Which percussion element to sync to */\n  beatType: BeatType | 'downbeat' | 'custom';\n  /** What should happen visually at this moment */\n  visualAction: string;\n  importance: 'must-hit' | 'nice-to-have' | 'optional';\n}\n\n// -----------------------------------------------------------------------------\n// Transition Types\n// -----------------------------------------------------------------------------\n\nexport type TransitionConfig =\n  | { type: 'cut'; on: 'kick' | 'snare' | 'downbeat' | 'any-beat' }\n  | { type: 'crossfade'; durationBeats: number }\n  | { type: 'whip-pan'; direction: 'left' | 'right' | 'up' | 'down' }\n  | { type: 'match-cut'; matchElement: string }\n  | { type: 'fade-black'; durationMs: number }\n  | { type: 'zoom-through'; target: string }\n  | { type: 'custom'; name: string; config: Record<string, unknown> };\n\n// Default: hard cut on the kick drum\nexport const DEFAULT_TRANSITION: TransitionConfig = { type: 'cut', on: 'kick' };\n\n// Transition presets for easy selection\nexport const TRANSITION_PRESETS: Record<string, TransitionConfig> = {\n  'cut-on-kick': { type: 'cut', on: 'kick' },\n  'cut-on-snare': { type: 'cut', on: 'snare' },\n  'cut-on-downbeat': { type: 'cut', on: 'downbeat' },\n  'smooth-crossfade': { type: 'crossfade', durationBeats: 2 },\n  'quick-crossfade': { type: 'crossfade', durationBeats: 1 },\n  'whip-left': { type: 'whip-pan', direction: 'left' },\n  'whip-right': { type: 'whip-pan', direction: 'right' },\n  'fade-to-black': { type: 'fade-black', durationMs: 500 },\n};\n\n// -----------------------------------------------------------------------------\n// Video Clip Types\n// -----------------------------------------------------------------------------\n\nexport type ClipStatus =\n  | 'queued'\n  | 'generating'\n  | 'ready'\n  | 'trimmed'\n  | 'approved'\n  | 'rejected';\n\nexport type VideoProvider = 'fal' | 'replicate' | 'local' | 'manual';\n\nexport interface GeneratedClip {\n  id: string;\n  sceneId: string;\n  /** URL to the generated/uploaded video */\n  sourceUrl: string;\n  durationMs: number;\n  /** Trim start relative to clip start (ms) */\n  trimStartMs: number;\n  /** Trim end relative to clip start (ms) */\n  trimEndMs: number;\n  provider: VideoProvider;\n  model: string;\n  prompt: string;\n  status: ClipStatus;\n  /** Take number - multiple attempts per scene */\n  take: number;\n}\n\n// -----------------------------------------------------------------------------\n// Series Types\n// -----------------------------------------------------------------------------\n\nexport interface EpisodeSeries {\n  id: string;\n  title: string;\n  description: string;\n  styleBible: StyleBible;\n  episodes: Episode[];\n  createdAt: string;\n  updatedAt: string;\n}\n\n// -----------------------------------------------------------------------------\n// Beat Analysis Configuration\n// -----------------------------------------------------------------------------\n\nexport interface BeatAnalysisConfig {\n  /** Which analysis method to use */\n  method: 'web-audio' | 'librosa' | 'madmom' | 'hybrid';\n  /** Minimum intensity threshold for onset detection (0-1) */\n  onsetThreshold: number;\n  /** Whether to attempt kick/snare classification */\n  classifyBeats: boolean;\n  /** Whether to detect song sections */\n  detectSections: boolean;\n  /** Frequency ranges for percussion classification (Hz) */\n  frequencyRanges: {\n    kick: [number, number];\n    snare: [number, number];\n    hihat: [number, number];\n  };\n}\n\nexport const DEFAULT_BEAT_ANALYSIS_CONFIG: BeatAnalysisConfig = {\n  method: 'web-audio',\n  onsetThreshold: 0.3,\n  classifyBeats: true,\n  detectSections: true,\n  frequencyRanges: {\n    kick: [20, 150],\n    snare: [150, 1000],\n    hihat: [3000, 16000],\n  },\n};\n\n// -----------------------------------------------------------------------------\n// Clip Trimming Configuration\n// -----------------------------------------------------------------------------\n\nexport interface ClipTrimConfig {\n  /** Snap clip boundaries to nearest beat */\n  snapToBeats: boolean;\n  /** Maximum distance (ms) to snap to a beat */\n  snapThresholdMs: number;\n  /** Add padding before/after trim (ms) */\n  paddingMs: number;\n  /** Minimum clip duration (ms) */\n  minDurationMs: number;\n  /** Maximum clip duration (ms) */\n  maxDurationMs: number;\n}\n\nexport const DEFAULT_CLIP_TRIM_CONFIG: ClipTrimConfig = {\n  snapToBeats: true,\n  snapThresholdMs: 100,\n  paddingMs: 0,\n  minDurationMs: 500,\n  maxDurationMs: 10000,\n};\n\n// -----------------------------------------------------------------------------\n// Episode Assembly Configuration\n// -----------------------------------------------------------------------------\n\nexport interface AssemblyConfig {\n  /** Output video resolution */\n  resolution: { width: number; height: number };\n  /** Frames per second */\n  fps: number;\n  /** Output format */\n  format: 'mp4' | 'webm';\n  /** Video codec */\n  codec: 'h264' | 'vp9';\n  /** Audio mix: song volume vs spoken word volume */\n  audioMix: {\n    songVolume: number; // 0-1\n    spokenWordVolume: number; // 0-1\n    duckSongDuringNarration: boolean;\n    duckAmountDb: number; // e.g., -6\n  };\n  /** Export preset */\n  preset?: 'youtube' | 'youtube-short' | 'instagram-reel' | 'tiktok' | '1080p' | '4k';\n}\n\nexport const DEFAULT_ASSEMBLY_CONFIG: AssemblyConfig = {\n  resolution: { width: 1080, height: 1920 }, // Vertical short\n  fps: 30,\n  format: 'mp4',\n  codec: 'h264',\n  audioMix: {\n    songVolume: 0.85,\n    spokenWordVolume: 1.0,\n    duckSongDuringNarration: true,\n    duckAmountDb: -6,\n  },\n  preset: 'youtube-short',\n};\n\nexport const ASSEMBLY_PRESETS: Record<string, Partial<AssemblyConfig>> = {\n  'youtube': { resolution: { width: 1920, height: 1080 }, fps: 30, preset: 'youtube' },\n  'youtube-short': { resolution: { width: 1080, height: 1920 }, fps: 30, preset: 'youtube-short' },\n  'instagram-reel': { resolution: { width: 1080, height: 1920 }, fps: 30, preset: 'instagram-reel' },\n  'tiktok': { resolution: { width: 1080, height: 1920 }, fps: 30, preset: 'tiktok' },\n  '1080p': { resolution: { width: 1920, height: 1080 }, fps: 30, preset: '1080p' },\n  '4k': { resolution: { width: 3840, height: 2160 }, fps: 30, preset: '4k' },\n};\n"],"names":[],"mappings":"AAAA,gFAAgF;AAChF,iDAAiD;AACjD,gFAAgF;AAChF,8CAA8C;AAC9C,gEAAgE;AAChE,gFAAgF;AAEhF,gFAAgF;AAChF,sBAAsB;AACtB,gFAAgF;;;;;;;;;;;;;;;AAsMzE,MAAM,qBAAuC;IAAE,MAAM;IAAO,IAAI;AAAO;AAGvE,MAAM,qBAAuD;IAClE,eAAe;QAAE,MAAM;QAAO,IAAI;IAAO;IACzC,gBAAgB;QAAE,MAAM;QAAO,IAAI;IAAQ;IAC3C,mBAAmB;QAAE,MAAM;QAAO,IAAI;IAAW;IACjD,oBAAoB;QAAE,MAAM;QAAa,eAAe;IAAE;IAC1D,mBAAmB;QAAE,MAAM;QAAa,eAAe;IAAE;IACzD,aAAa;QAAE,MAAM;QAAY,WAAW;IAAO;IACnD,cAAc;QAAE,MAAM;QAAY,WAAW;IAAQ;IACrD,iBAAiB;QAAE,MAAM;QAAc,YAAY;IAAI;AACzD;AAqEO,MAAM,+BAAmD;IAC9D,QAAQ;IACR,gBAAgB;IAChB,eAAe;IACf,gBAAgB;IAChB,iBAAiB;QACf,MAAM;YAAC;YAAI;SAAI;QACf,OAAO;YAAC;YAAK;SAAK;QAClB,OAAO;YAAC;YAAM;SAAM;IACtB;AACF;AAmBO,MAAM,2BAA2C;IACtD,aAAa;IACb,iBAAiB;IACjB,WAAW;IACX,eAAe;IACf,eAAe;AACjB;AA0BO,MAAM,0BAA0C;IACrD,YAAY;QAAE,OAAO;QAAM,QAAQ;IAAK;IACxC,KAAK;IACL,QAAQ;IACR,OAAO;IACP,UAAU;QACR,YAAY;QACZ,kBAAkB;QAClB,yBAAyB;QACzB,cAAc,CAAC;IACjB;IACA,QAAQ;AACV;AAEO,MAAM,mBAA4D;IACvE,WAAW;QAAE,YAAY;YAAE,OAAO;YAAM,QAAQ;QAAK;QAAG,KAAK;QAAI,QAAQ;IAAU;IACnF,iBAAiB;QAAE,YAAY;YAAE,OAAO;YAAM,QAAQ;QAAK;QAAG,KAAK;QAAI,QAAQ;IAAgB;IAC/F,kBAAkB;QAAE,YAAY;YAAE,OAAO;YAAM,QAAQ;QAAK;QAAG,KAAK;QAAI,QAAQ;IAAiB;IACjG,UAAU;QAAE,YAAY;YAAE,OAAO;YAAM,QAAQ;QAAK;QAAG,KAAK;QAAI,QAAQ;IAAS;IACjF,SAAS;QAAE,YAAY;YAAE,OAAO;YAAM,QAAQ;QAAK;QAAG,KAAK;QAAI,QAAQ;IAAQ;IAC/E,MAAM;QAAE,YAAY;YAAE,OAAO;YAAM,QAAQ;QAAK;QAAG,KAAK;QAAI,QAAQ;IAAK;AAC3E"}},
    {"offset": {"line": 1227, "column": 0}, "map": {"version":3,"sources":["file:///Users/jamesspalding/OpenClaw-OS/src/lib/episode/beat-analyzer.ts"],"sourcesContent":["// =============================================================================\n// Beat Analyzer - Audio Analysis for Episode Production\n// =============================================================================\n// Extracts beat timestamps, classifies percussion, detects song structure.\n// Supports Web Audio API (browser), Python via Lynkr (local), and hybrid.\n// =============================================================================\n\nimport type {\n  Beat,\n  BeatMap,\n  BeatType,\n  BeatAnalysisConfig,\n  EnergyPoint,\n  SongSection,\n  SongSectionType,\n  DEFAULT_BEAT_ANALYSIS_CONFIG,\n} from './types';\n\n// Re-export the default config\nexport { DEFAULT_BEAT_ANALYSIS_CONFIG } from './types';\n\n// -----------------------------------------------------------------------------\n// Web Audio API Beat Analysis (Browser-side)\n// -----------------------------------------------------------------------------\n\n/**\n * Analyze audio using Web Audio API for beat detection.\n * Works in the browser without any external dependencies.\n * Less accurate than Python-based approaches but instant.\n */\nexport async function analyzeBeatsWebAudio(\n  audioBuffer: AudioBuffer,\n  config: BeatAnalysisConfig = {\n    method: 'web-audio',\n    onsetThreshold: 0.3,\n    classifyBeats: true,\n    detectSections: true,\n    frequencyRanges: {\n      kick: [20, 150],\n      snare: [150, 1000],\n      hihat: [3000, 16000],\n    },\n  }\n): Promise<BeatMap> {\n  const sampleRate = audioBuffer.sampleRate;\n  const channelData = audioBuffer.getChannelData(0); // Mono or left channel\n  const durationMs = (audioBuffer.duration * 1000) | 0;\n\n  // Step 1: Compute onset detection function via spectral flux\n  const onsets = detectOnsets(channelData, sampleRate, config.onsetThreshold);\n\n  // Step 2: Estimate BPM from onset intervals\n  const bpm = estimateBPM(onsets, durationMs);\n\n  // Step 3: Build beat grid from BPM\n  const beatGrid = buildBeatGrid(bpm, durationMs);\n\n  // Step 4: Classify beats by frequency content (kick/snare/hihat)\n  const classifiedBeats = config.classifyBeats\n    ? classifyBeats(beatGrid, channelData, sampleRate, config.frequencyRanges)\n    : beatGrid;\n\n  // Step 5: Detect song sections by energy changes\n  const energyCurve = computeEnergyCurve(channelData, sampleRate);\n  const sections = config.detectSections\n    ? detectSections(energyCurve, classifiedBeats, durationMs)\n    : [];\n\n  return {\n    songId: '',\n    bpm,\n    timeSignature: '4/4',\n    durationMs,\n    beats: classifiedBeats,\n    sections,\n    energyCurve,\n    analysis: {\n      method: 'web-audio',\n      confidence: 0.7, // Web Audio is less precise\n      analyzedAt: new Date().toISOString(),\n    },\n  };\n}\n\n// -----------------------------------------------------------------------------\n// Onset Detection via Spectral Flux\n// -----------------------------------------------------------------------------\n\ninterface Onset {\n  timeMs: number;\n  intensity: number;\n}\n\n/**\n * Detect audio onsets using spectral flux.\n * Compares FFT frames to find moments where energy increases suddenly.\n */\nfunction detectOnsets(\n  channelData: Float32Array,\n  sampleRate: number,\n  threshold: number\n): Onset[] {\n  const frameSize = 1024;\n  const hopSize = 512;\n  const numFrames = Math.floor((channelData.length - frameSize) / hopSize);\n  const onsets: Onset[] = [];\n\n  let prevSpectrum: Float64Array | null = null;\n\n  for (let i = 0; i < numFrames; i++) {\n    const start = i * hopSize;\n    const frame = channelData.slice(start, start + frameSize);\n\n    // Apply Hanning window\n    const windowed = applyHanningWindow(frame);\n\n    // Compute magnitude spectrum (simplified FFT approximation using energy bands)\n    const spectrum = computeEnergyBands(windowed, sampleRate);\n\n    if (prevSpectrum) {\n      // Spectral flux: sum of positive differences between frames\n      let flux = 0;\n      for (let j = 0; j < spectrum.length; j++) {\n        const diff = spectrum[j] - prevSpectrum[j];\n        if (diff > 0) flux += diff;\n      }\n\n      // Normalize flux\n      const normalizedFlux = Math.min(flux / 10, 1);\n\n      if (normalizedFlux > threshold) {\n        const timeMs = ((start + frameSize / 2) / sampleRate) * 1000;\n        onsets.push({ timeMs, intensity: normalizedFlux });\n      }\n    }\n\n    prevSpectrum = spectrum;\n  }\n\n  // Merge onsets that are too close together (within 50ms)\n  return mergeCloseOnsets(onsets, 50);\n}\n\nfunction applyHanningWindow(frame: Float32Array): Float32Array {\n  const windowed = new Float32Array(frame.length);\n  for (let i = 0; i < frame.length; i++) {\n    const multiplier = 0.5 * (1 - Math.cos((2 * Math.PI * i) / (frame.length - 1)));\n    windowed[i] = frame[i] * multiplier;\n  }\n  return windowed;\n}\n\n/**\n * Simplified energy band computation.\n * Splits signal into frequency bands and computes energy per band.\n */\nfunction computeEnergyBands(frame: Float32Array, sampleRate: number): Float64Array {\n  const numBands = 16;\n  const bands = new Float64Array(numBands);\n  const bandSize = Math.floor(frame.length / numBands);\n\n  for (let b = 0; b < numBands; b++) {\n    let energy = 0;\n    for (let i = b * bandSize; i < (b + 1) * bandSize && i < frame.length; i++) {\n      energy += frame[i] * frame[i];\n    }\n    bands[b] = Math.sqrt(energy / bandSize);\n  }\n\n  return bands;\n}\n\nfunction mergeCloseOnsets(onsets: Onset[], minGapMs: number): Onset[] {\n  if (onsets.length === 0) return [];\n\n  const merged: Onset[] = [onsets[0]];\n  for (let i = 1; i < onsets.length; i++) {\n    const last = merged[merged.length - 1];\n    if (onsets[i].timeMs - last.timeMs < minGapMs) {\n      // Keep the stronger onset\n      if (onsets[i].intensity > last.intensity) {\n        merged[merged.length - 1] = onsets[i];\n      }\n    } else {\n      merged.push(onsets[i]);\n    }\n  }\n  return merged;\n}\n\n// -----------------------------------------------------------------------------\n// BPM Estimation\n// -----------------------------------------------------------------------------\n\n/**\n * Estimate BPM from onset intervals using autocorrelation of inter-onset intervals.\n */\nfunction estimateBPM(onsets: Onset[], durationMs: number): number {\n  if (onsets.length < 4) return 120; // Default fallback\n\n  // Calculate inter-onset intervals\n  const intervals: number[] = [];\n  for (let i = 1; i < onsets.length; i++) {\n    intervals.push(onsets[i].timeMs - onsets[i - 1].timeMs);\n  }\n\n  // Build histogram of intervals (quantized to 10ms bins)\n  // Focus on musically plausible range: 60-200 BPM â†’ 300-1000ms intervals\n  const minInterval = 300; // 200 BPM\n  const maxInterval = 1000; // 60 BPM\n  const binSize = 10;\n  const numBins = Math.ceil((maxInterval - minInterval) / binSize);\n  const histogram = new Float64Array(numBins);\n\n  for (const interval of intervals) {\n    if (interval >= minInterval && interval <= maxInterval) {\n      const bin = Math.floor((interval - minInterval) / binSize);\n      if (bin >= 0 && bin < numBins) {\n        histogram[bin] += 1;\n      }\n    }\n    // Also check half and double intervals (sub-beats, half-time)\n    const half = interval / 2;\n    if (half >= minInterval && half <= maxInterval) {\n      const bin = Math.floor((half - minInterval) / binSize);\n      if (bin >= 0 && bin < numBins) histogram[bin] += 0.5;\n    }\n    const dbl = interval * 2;\n    if (dbl >= minInterval && dbl <= maxInterval) {\n      const bin = Math.floor((dbl - minInterval) / binSize);\n      if (bin >= 0 && bin < numBins) histogram[bin] += 0.5;\n    }\n  }\n\n  // Find the peak bin\n  let maxBin = 0;\n  let maxCount = 0;\n  for (let i = 0; i < numBins; i++) {\n    if (histogram[i] > maxCount) {\n      maxCount = histogram[i];\n      maxBin = i;\n    }\n  }\n\n  const dominantIntervalMs = minInterval + maxBin * binSize + binSize / 2;\n  const bpm = Math.round((60000 / dominantIntervalMs) * 10) / 10;\n\n  // Clamp to reasonable range\n  return Math.max(60, Math.min(200, bpm));\n}\n\n// -----------------------------------------------------------------------------\n// Beat Grid Construction\n// -----------------------------------------------------------------------------\n\n/**\n * Build a regular beat grid from BPM, assuming 4/4 time.\n */\nfunction buildBeatGrid(bpm: number, durationMs: number): Beat[] {\n  const beatIntervalMs = 60000 / bpm;\n  const beats: Beat[] = [];\n  let measure = 1;\n  let beatInMeasure = 1;\n\n  for (let timeMs = 0; timeMs < durationMs; timeMs += beatIntervalMs) {\n    beats.push({\n      timeMs: Math.round(timeMs * 100) / 100,\n      type: 'other',\n      intensity: beatInMeasure === 1 ? 0.9 : beatInMeasure === 3 ? 0.7 : 0.5,\n      isDownbeat: beatInMeasure === 1,\n      measure,\n      beatInMeasure,\n    });\n\n    beatInMeasure++;\n    if (beatInMeasure > 4) {\n      beatInMeasure = 1;\n      measure++;\n    }\n  }\n\n  return beats;\n}\n\n// -----------------------------------------------------------------------------\n// Beat Classification by Frequency\n// -----------------------------------------------------------------------------\n\n/**\n * Classify beats as kick/snare/hihat by analyzing frequency content at each beat time.\n */\nfunction classifyBeats(\n  beats: Beat[],\n  channelData: Float32Array,\n  sampleRate: number,\n  frequencyRanges: { kick: [number, number]; snare: [number, number]; hihat: [number, number] }\n): Beat[] {\n  const windowSize = 1024;\n\n  return beats.map((beat) => {\n    const sampleIndex = Math.floor((beat.timeMs / 1000) * sampleRate);\n    const start = Math.max(0, sampleIndex - windowSize / 2);\n    const end = Math.min(channelData.length, start + windowSize);\n    const frame = channelData.slice(start, end);\n\n    if (frame.length < windowSize / 2) return beat;\n\n    // Compute energy in each frequency range\n    const kickEnergy = computeBandEnergy(frame, sampleRate, frequencyRanges.kick);\n    const snareEnergy = computeBandEnergy(frame, sampleRate, frequencyRanges.snare);\n    const hihatEnergy = computeBandEnergy(frame, sampleRate, frequencyRanges.hihat);\n\n    const maxEnergy = Math.max(kickEnergy, snareEnergy, hihatEnergy);\n    if (maxEnergy < 0.01) return beat;\n\n    let type: BeatType = 'other';\n    if (kickEnergy === maxEnergy) type = 'kick';\n    else if (snareEnergy === maxEnergy) type = 'snare';\n    else if (hihatEnergy === maxEnergy) type = 'hihat';\n\n    // In standard 4/4: beats 1,3 tend to be kick, beats 2,4 tend to be snare\n    // Use this as a prior to improve classification\n    if (beat.beatInMeasure === 1 || beat.beatInMeasure === 3) {\n      if (kickEnergy > snareEnergy * 0.5) type = 'kick';\n    } else if (beat.beatInMeasure === 2 || beat.beatInMeasure === 4) {\n      if (snareEnergy > kickEnergy * 0.5) type = 'snare';\n    }\n\n    return { ...beat, type, intensity: Math.min(maxEnergy * 10, 1) };\n  });\n}\n\n/**\n * Compute energy in a specific frequency band using time-domain bandpass approximation.\n */\nfunction computeBandEnergy(\n  frame: Float32Array,\n  sampleRate: number,\n  [lowHz, highHz]: [number, number]\n): number {\n  // Simple energy computation weighted by frequency band\n  // For proper implementation, we'd use FFT. This is an approximation\n  // that works for broad classification.\n  const lowBin = Math.floor((lowHz / sampleRate) * frame.length);\n  const highBin = Math.floor((highHz / sampleRate) * frame.length);\n\n  let energy = 0;\n  const bandStart = Math.max(0, lowBin);\n  const bandEnd = Math.min(frame.length, highBin);\n\n  for (let i = bandStart; i < bandEnd; i++) {\n    energy += frame[i] * frame[i];\n  }\n\n  return Math.sqrt(energy / Math.max(1, bandEnd - bandStart));\n}\n\n// -----------------------------------------------------------------------------\n// Energy Curve Computation\n// -----------------------------------------------------------------------------\n\n/**\n * Compute an energy curve over time for visualizing track dynamics.\n * Returns energy samples at ~10ms intervals.\n */\nfunction computeEnergyCurve(\n  channelData: Float32Array,\n  sampleRate: number\n): EnergyPoint[] {\n  const windowMs = 100; // 100ms windows\n  const hopMs = 50; // 50ms hop\n  const windowSamples = Math.floor((windowMs / 1000) * sampleRate);\n  const hopSamples = Math.floor((hopMs / 1000) * sampleRate);\n  const points: EnergyPoint[] = [];\n\n  let maxRMS = 0;\n\n  // First pass: compute all RMS values\n  const rmsValues: { timeMs: number; rms: number }[] = [];\n  for (let i = 0; i < channelData.length - windowSamples; i += hopSamples) {\n    let sum = 0;\n    for (let j = i; j < i + windowSamples; j++) {\n      sum += channelData[j] * channelData[j];\n    }\n    const rms = Math.sqrt(sum / windowSamples);\n    const timeMs = ((i + windowSamples / 2) / sampleRate) * 1000;\n    rmsValues.push({ timeMs, rms });\n    if (rms > maxRMS) maxRMS = rms;\n  }\n\n  // Second pass: normalize\n  for (const { timeMs, rms } of rmsValues) {\n    points.push({\n      timeMs: Math.round(timeMs),\n      energy: maxRMS > 0 ? rms / maxRMS : 0,\n    });\n  }\n\n  return points;\n}\n\n// -----------------------------------------------------------------------------\n// Song Section Detection\n// -----------------------------------------------------------------------------\n\n/**\n * Detect song sections (verse, chorus, bridge) from energy curve changes.\n * Uses energy transitions and structural repetition to identify boundaries.\n */\nfunction detectSections(\n  energyCurve: EnergyPoint[],\n  beats: Beat[],\n  durationMs: number\n): SongSection[] {\n  if (energyCurve.length === 0) return [];\n\n  // Smooth the energy curve\n  const smoothed = smoothEnergy(energyCurve, 20);\n\n  // Find significant energy transitions\n  const transitions = findEnergyTransitions(smoothed);\n\n  // Snap transitions to nearest downbeat\n  const snappedTransitions = transitions.map((t) => {\n    const nearest = beats.reduce((best, beat) => {\n      if (!beat.isDownbeat) return best;\n      return Math.abs(beat.timeMs - t) < Math.abs(best - t) ? beat.timeMs : best;\n    }, t);\n    return nearest;\n  });\n\n  // Build sections from transitions\n  const boundaries = [0, ...snappedTransitions, durationMs];\n  const sections: SongSection[] = [];\n\n  // Track section type counts for labeling\n  const typeCounts: Record<string, number> = {};\n\n  for (let i = 0; i < boundaries.length - 1; i++) {\n    const startMs = boundaries[i];\n    const endMs = boundaries[i + 1];\n\n    // Get average energy for this section\n    const sectionEnergy = smoothed\n      .filter((p) => p.timeMs >= startMs && p.timeMs <= endMs)\n      .reduce((sum, p) => sum + p.energy, 0);\n    const avgEnergy =\n      sectionEnergy /\n      Math.max(\n        1,\n        smoothed.filter((p) => p.timeMs >= startMs && p.timeMs <= endMs).length\n      );\n\n    // Classify section type by position and energy\n    const type = classifySectionType(i, boundaries.length - 1, avgEnergy, endMs - startMs);\n\n    typeCounts[type] = (typeCounts[type] || 0) + 1;\n    const label = `${type}${typeCounts[type] > 1 ? typeCounts[type] : ''}`;\n\n    sections.push({\n      type,\n      startMs: Math.round(startMs),\n      endMs: Math.round(endMs),\n      label,\n      energy: Math.round(avgEnergy * 100) / 100,\n    });\n  }\n\n  return sections;\n}\n\nfunction smoothEnergy(curve: EnergyPoint[], windowSize: number): EnergyPoint[] {\n  return curve.map((point, i) => {\n    const start = Math.max(0, i - windowSize);\n    const end = Math.min(curve.length, i + windowSize + 1);\n    let sum = 0;\n    for (let j = start; j < end; j++) sum += curve[j].energy;\n    return { timeMs: point.timeMs, energy: sum / (end - start) };\n  });\n}\n\nfunction findEnergyTransitions(smoothed: EnergyPoint[]): number[] {\n  const transitions: number[] = [];\n  const changeThreshold = 0.15; // 15% energy change = new section\n\n  for (let i = 1; i < smoothed.length; i++) {\n    const change = Math.abs(smoothed[i].energy - smoothed[i - 1].energy);\n    if (change > changeThreshold) {\n      // Don't add transitions too close together (min 4 seconds apart)\n      const lastTransition = transitions[transitions.length - 1];\n      if (!lastTransition || smoothed[i].timeMs - lastTransition > 4000) {\n        transitions.push(smoothed[i].timeMs);\n      }\n    }\n  }\n\n  return transitions;\n}\n\nfunction classifySectionType(\n  index: number,\n  totalSections: number,\n  energy: number,\n  durationMs: number\n): SongSectionType {\n  // First section with low energy = intro\n  if (index === 0 && energy < 0.4 && durationMs < 15000) return 'intro';\n\n  // Last section with decreasing energy = outro\n  if (index === totalSections - 1 && energy < 0.5 && durationMs < 15000) return 'outro';\n\n  // High energy sections = chorus\n  if (energy > 0.7) return 'chorus';\n\n  // Medium energy = verse\n  if (energy > 0.3) return 'verse';\n\n  // Low energy in the middle = bridge or break\n  if (energy <= 0.3) {\n    return durationMs < 8000 ? 'break' : 'bridge';\n  }\n\n  return 'verse';\n}\n\n// -----------------------------------------------------------------------------\n// Lynkr/Python Beat Analysis (via API)\n// -----------------------------------------------------------------------------\n\ninterface LynkrBeatResponse {\n  bpm: number;\n  beats: Array<{\n    time: number;\n    type: string;\n    intensity: number;\n  }>;\n  sections: Array<{\n    type: string;\n    start: number;\n    end: number;\n    label: string;\n  }>;\n  downbeats: number[];\n}\n\n/**\n * Analyze audio using Python (librosa/madmom) via Lynkr proxy.\n * Much more accurate than Web Audio API but requires local infrastructure.\n */\nexport async function analyzeBeatsLynkr(\n  audioUrl: string,\n  lynkrUrl: string,\n  apiKey: string\n): Promise<BeatMap> {\n  const response = await fetch(`${lynkrUrl}/v1/audio/analyze`, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      Authorization: `Bearer ${apiKey}`,\n    },\n    body: JSON.stringify({\n      audio_url: audioUrl,\n      analysis_type: 'full', // beats + sections + energy\n      backend: 'madmom', // or 'librosa'\n    }),\n  });\n\n  if (!response.ok) {\n    throw new Error(`Lynkr beat analysis failed: ${response.status} ${response.statusText}`);\n  }\n\n  const data = (await response.json()) as LynkrBeatResponse;\n\n  // Convert Lynkr response to our BeatMap format\n  const beats: Beat[] = data.beats.map((b, i) => {\n    const beatInMeasure = (i % 4) + 1;\n    const measure = Math.floor(i / 4) + 1;\n    return {\n      timeMs: b.time * 1000,\n      type: (b.type as BeatType) || 'other',\n      intensity: b.intensity,\n      isDownbeat: data.downbeats.includes(b.time) || beatInMeasure === 1,\n      measure,\n      beatInMeasure,\n    };\n  });\n\n  const sections: SongSection[] = data.sections.map((s) => ({\n    type: s.type as SongSectionType,\n    startMs: s.start * 1000,\n    endMs: s.end * 1000,\n    label: s.label,\n    energy: 0.5, // Will be computed from audio\n  }));\n\n  const lastBeat = beats[beats.length - 1];\n\n  return {\n    songId: '',\n    bpm: data.bpm,\n    timeSignature: '4/4',\n    durationMs: lastBeat ? lastBeat.timeMs + 60000 / data.bpm : 0,\n    beats,\n    sections,\n    energyCurve: [], // Computed separately\n    analysis: {\n      method: 'madmom',\n      confidence: 0.9,\n      analyzedAt: new Date().toISOString(),\n    },\n  };\n}\n\n// -----------------------------------------------------------------------------\n// Utility Functions\n// -----------------------------------------------------------------------------\n\n/**\n * Find the nearest beat to a given timestamp.\n */\nexport function findNearestBeat(beats: Beat[], timeMs: number): Beat | null {\n  if (beats.length === 0) return null;\n\n  let nearest = beats[0];\n  let minDist = Math.abs(beats[0].timeMs - timeMs);\n\n  for (const beat of beats) {\n    const dist = Math.abs(beat.timeMs - timeMs);\n    if (dist < minDist) {\n      minDist = dist;\n      nearest = beat;\n    }\n  }\n\n  return nearest;\n}\n\n/**\n * Get all beats of a specific type within a time range.\n */\nexport function getBeatsInRange(\n  beats: Beat[],\n  startMs: number,\n  endMs: number,\n  type?: BeatType\n): Beat[] {\n  return beats.filter(\n    (b) =>\n      b.timeMs >= startMs &&\n      b.timeMs <= endMs &&\n      (type === undefined || b.type === type)\n  );\n}\n\n/**\n * Get downbeats (first beat of each measure) within a range.\n */\nexport function getDownbeatsInRange(\n  beats: Beat[],\n  startMs: number,\n  endMs: number\n): Beat[] {\n  return beats.filter((b) => b.timeMs >= startMs && b.timeMs <= endMs && b.isDownbeat);\n}\n\n/**\n * Calculate the time between beats at a given BPM.\n */\nexport function beatIntervalMs(bpm: number): number {\n  return 60000 / bpm;\n}\n\n/**\n * Snap a timestamp to the nearest beat grid position.\n */\nexport function snapToGrid(timeMs: number, bpm: number, thresholdMs: number = 50): number {\n  const interval = beatIntervalMs(bpm);\n  const nearestBeat = Math.round(timeMs / interval) * interval;\n  return Math.abs(nearestBeat - timeMs) <= thresholdMs ? nearestBeat : timeMs;\n}\n\n/**\n * Convert a BeatMap to a simplified array of beat timestamps for quick use.\n */\nexport function beatTimestamps(beatMap: BeatMap, type?: BeatType): number[] {\n  const filtered = type ? beatMap.beats.filter((b) => b.type === type) : beatMap.beats;\n  return filtered.map((b) => b.timeMs);\n}\n\n/**\n * Merge a manual annotation into an existing beat map.\n * Used when James corrects beat classifications.\n */\nexport function annotateBeat(\n  beatMap: BeatMap,\n  timeMs: number,\n  type: BeatType\n): BeatMap {\n  const nearest = findNearestBeat(beatMap.beats, timeMs);\n  if (!nearest) return beatMap;\n\n  const updatedBeats = beatMap.beats.map((b) =>\n    b.timeMs === nearest.timeMs ? { ...b, type } : b\n  );\n\n  return {\n    ...beatMap,\n    beats: updatedBeats,\n    analysis: {\n      ...beatMap.analysis,\n      method: 'hybrid',\n    },\n  };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1752, "column": 0}, "map": {"version":3,"sources":["file:///Users/jamesspalding/OpenClaw-OS/src/lib/canvas/diagram-utils.ts"],"sourcesContent":["/**\n * Canvas Diagram Utilities\n * \n * Conversion between canvas nodes/edges, Mermaid syntax, JSON export format,\n * and SVG generation. Modeled after Excalidraw's data layer.\n */\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport interface CanvasNodeData {\n  id: string;\n  type: string;\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n  content: string;\n  style?: Record<string, unknown>;\n}\n\nexport interface CanvasEdgeData {\n  id: string;\n  source: string;\n  target: string;\n  type: string;\n  label?: string;\n}\n\nexport interface DrawingElementData {\n  id: string;\n  type: string;\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n  points?: { x: number; y: number }[];\n  strokeColor: string;\n  backgroundColor: string;\n  fillStyle: string;\n  strokeWidth: number;\n  strokeStyle: string;\n  opacity: number;\n  roughness: number;\n  text?: string;\n  fontSize?: number;\n  startArrowhead?: string | null;\n  endArrowhead?: string | null;\n  rotation?: number;\n}\n\nexport interface CanvasExportData {\n  type: \"openclaw-canvas\";\n  version: 2;\n  name: string;\n  createdAt: string;\n  nodes: CanvasNodeData[];\n  edges: CanvasEdgeData[];\n  drawingElements: DrawingElementData[];\n  viewport: { x: number; y: number; zoom: number };\n}\n\n// ============================================================================\n// Canvas to Mermaid\n// ============================================================================\n\nexport function canvasToMermaid(\n  nodes: CanvasNodeData[],\n  edges: CanvasEdgeData[]\n): string {\n  const lines: string[] = [\"flowchart TD\"];\n  const nodeMap = new Map<string, string>();\n\n  // Map node IDs to simple labels\n  nodes.forEach((node, i) => {\n    const label = node.content?.replace(/[[\\]{}()|]/g, \"\") || `Node${i}`;\n    const shortId = `N${i}`;\n    nodeMap.set(node.id, shortId);\n\n    // Determine shape syntax based on type\n    switch (node.type) {\n      case \"flow-decision\":\n        lines.push(`    ${shortId}{${label}}`);\n        break;\n      case \"flow-start\":\n      case \"flow-end\":\n        lines.push(`    ${shortId}([${label}])`);\n        break;\n      case \"flow-process\":\n        lines.push(`    ${shortId}[${label}]`);\n        break;\n      case \"flow-data\":\n        lines.push(`    ${shortId}[/${label}/]`);\n        break;\n      case \"flow-subprocess\":\n        lines.push(`    ${shortId}[[${label}]]`);\n        break;\n      case \"arch-database\":\n        lines.push(`    ${shortId}[(${label})]`);\n        break;\n      case \"arch-service\":\n      case \"arch-api\":\n        lines.push(`    ${shortId}[${label}]`);\n        break;\n      case \"arch-client\":\n        lines.push(`    ${shortId}(${label})`);\n        break;\n      case \"arch-queue\":\n        lines.push(`    ${shortId}>>${label}]`);\n        break;\n      case \"arch-cloud\":\n        lines.push(`    ${shortId}{{${label}}}`);\n        break;\n      default:\n        // Generic rectangle for unknown types\n        lines.push(`    ${shortId}[\"${label}\"]`);\n    }\n  });\n\n  // Add edges\n  edges.forEach((edge) => {\n    const source = nodeMap.get(edge.source);\n    const target = nodeMap.get(edge.target);\n    if (source && target) {\n      if (edge.label) {\n        lines.push(`    ${source} -->|${edge.label}| ${target}`);\n      } else {\n        lines.push(`    ${source} --> ${target}`);\n      }\n    }\n  });\n\n  return lines.join(\"\\n\");\n}\n\n// ============================================================================\n// Mermaid to Canvas Nodes\n// ============================================================================\n\ninterface MermaidParseResult {\n  nodes: CanvasNodeData[];\n  edges: CanvasEdgeData[];\n}\n\nexport async function mermaidToCanvas(\n  definition: string,\n  startX: number = 0,\n  startY: number = 0\n): Promise<MermaidParseResult> {\n  const nodes: CanvasNodeData[] = [];\n  const edges: CanvasEdgeData[] = [];\n  const nodeIdMap = new Map<string, string>();\n\n  // Parse Mermaid syntax manually for basic flowcharts\n  const lines = definition.split(\"\\n\").map(l => l.trim()).filter(l => l && !l.startsWith(\"%%\"));\n\n  // Skip the graph/flowchart declaration\n  const contentLines = lines.filter(l => !l.match(/^(graph|flowchart|sequenceDiagram|classDiagram|stateDiagram)\\s/i));\n\n  let nodeIndex = 0;\n  const SPACING_X = 250;\n  const SPACING_Y = 150;\n  const COLS = 3;\n\n  for (const line of contentLines) {\n    // Parse node definitions with shapes\n    // Patterns: A[text], A(text), A{text}, A([text]), A[[text]], A[(text)], A{{text}}\n    const nodePatterns = [\n      /(\\w+)\\(\\[([^\\]]*)\\]\\)/g,   // ([text]) - stadium\n      /(\\w+)\\[\\[([^\\]]*)\\]\\]/g,   // [[text]] - subprocess\n      /(\\w+)\\[\\(([^)]*)\\)\\]/g,    // [(text)] - cylinder\n      /(\\w+)\\{\\{([^}]*)\\}\\}/g,    // {{text}} - hexagon\n      /(\\w+)\\{([^}]*)\\}/g,        // {text} - diamond\n      /(\\w+)\\[\\/([^/]*)\\/\\]/g,    // [/text/] - parallelogram\n      /(\\w+)\\(([^)]*)\\)/g,        // (text) - round\n      /(\\w+)\\[\"([^\"]*)\"\\]/g,      // [\"text\"] - quoted\n      /(\\w+)\\[([^\\]]*)\\]/g,       // [text] - rectangle\n    ];\n\n    for (const pattern of nodePatterns) {\n      pattern.lastIndex = 0;\n      let match;\n      while ((match = pattern.exec(line)) !== null) {\n        const id = match[1];\n        const text = match[2];\n        if (!nodeIdMap.has(id)) {\n          const col = nodeIndex % COLS;\n          const row = Math.floor(nodeIndex / COLS);\n          const canvasId = `node-mermaid-${Date.now()}-${nodeIndex}`;\n\n          // Determine type from shape\n          let type = \"flow-process\";\n          if (pattern.source.includes(\"\\\\(\\\\[\")) type = \"flow-start\";\n          else if (pattern.source.includes(\"\\\\{\\\\{\")) type = \"arch-cloud\";\n          else if (pattern.source.includes(\"\\\\{\")) type = \"flow-decision\";\n          else if (pattern.source.includes(\"\\\\[\\\\(\")) type = \"arch-database\";\n          else if (pattern.source.includes(\"\\\\[\\\\[\")) type = \"flow-subprocess\";\n          else if (pattern.source.includes(\"\\\\/\")) type = \"flow-data\";\n          else if (pattern.source.includes(\"\\\\(\")) type = \"flow-start\";\n\n          nodes.push({\n            id: canvasId,\n            type,\n            x: startX + col * SPACING_X,\n            y: startY + row * SPACING_Y,\n            width: 180,\n            height: 80,\n            content: text,\n            style: { fill: getTypeColor(type) },\n          });\n          nodeIdMap.set(id, canvasId);\n          nodeIndex++;\n        }\n      }\n    }\n\n    // Parse edges: A --> B, A -->|label| B, A --- B, A -.-> B, A ==> B\n    const edgePattern = /(\\w+)\\s*(-+\\.?->?|=+>|--+)\\s*(?:\\|([^|]*)\\|\\s*)?(\\w+)/g;\n    let edgeMatch;\n    while ((edgeMatch = edgePattern.exec(line)) !== null) {\n      const sourceId = edgeMatch[1];\n      const label = edgeMatch[3] || undefined;\n      const targetId = edgeMatch[4];\n\n      // Ensure both nodes exist\n      if (!nodeIdMap.has(sourceId)) {\n        const col = nodeIndex % COLS;\n        const row = Math.floor(nodeIndex / COLS);\n        const canvasId = `node-mermaid-${Date.now()}-${nodeIndex}`;\n        nodes.push({\n          id: canvasId, type: \"flow-process\",\n          x: startX + col * SPACING_X, y: startY + row * SPACING_Y,\n          width: 180, height: 80, content: sourceId,\n          style: { fill: \"#3b82f6\" },\n        });\n        nodeIdMap.set(sourceId, canvasId);\n        nodeIndex++;\n      }\n      if (!nodeIdMap.has(targetId)) {\n        const col = nodeIndex % COLS;\n        const row = Math.floor(nodeIndex / COLS);\n        const canvasId = `node-mermaid-${Date.now()}-${nodeIndex}`;\n        nodes.push({\n          id: canvasId, type: \"flow-process\",\n          x: startX + col * SPACING_X, y: startY + row * SPACING_Y,\n          width: 180, height: 80, content: targetId,\n          style: { fill: \"#3b82f6\" },\n        });\n        nodeIdMap.set(targetId, canvasId);\n        nodeIndex++;\n      }\n\n      const sourceCanvasId = nodeIdMap.get(sourceId)!;\n      const targetCanvasId = nodeIdMap.get(targetId)!;\n\n      edges.push({\n        id: `edge-mermaid-${Date.now()}-${edges.length}`,\n        source: sourceCanvasId,\n        target: targetCanvasId,\n        type: \"arrow\",\n        label,\n      });\n    }\n  }\n\n  // Auto-layout: arrange nodes in a top-down tree\n  if (edges.length > 0) {\n    autoLayoutTree(nodes, edges, startX, startY);\n  }\n\n  return { nodes, edges };\n}\n\n// ============================================================================\n// Auto Layout\n// ============================================================================\n\nfunction autoLayoutTree(\n  nodes: CanvasNodeData[],\n  edges: CanvasEdgeData[],\n  startX: number,\n  startY: number\n) {\n  // Build adjacency list\n  const children = new Map<string, string[]>();\n  const hasParent = new Set<string>();\n\n  for (const edge of edges) {\n    if (!children.has(edge.source)) children.set(edge.source, []);\n    children.get(edge.source)!.push(edge.target);\n    hasParent.add(edge.target);\n  }\n\n  // Find roots (nodes with no incoming edges)\n  const roots = nodes.filter(n => !hasParent.has(n.id)).map(n => n.id);\n  if (roots.length === 0 && nodes.length > 0) roots.push(nodes[0].id);\n\n  const levels = new Map<string, number>();\n  const queue = roots.map(id => ({ id, level: 0 }));\n  const visited = new Set<string>();\n\n  while (queue.length > 0) {\n    const { id, level } = queue.shift()!;\n    if (visited.has(id)) continue;\n    visited.add(id);\n    levels.set(id, level);\n\n    const kids = children.get(id) || [];\n    for (const kid of kids) {\n      queue.push({ id: kid, level: level + 1 });\n    }\n  }\n\n  // Group by level\n  const levelGroups = new Map<number, string[]>();\n  for (const [id, level] of levels) {\n    if (!levelGroups.has(level)) levelGroups.set(level, []);\n    levelGroups.get(level)!.push(id);\n  }\n\n  // Position nodes\n  const SPACING_X = 250;\n  const SPACING_Y = 150;\n\n  for (const [level, ids] of levelGroups) {\n    const totalWidth = (ids.length - 1) * SPACING_X;\n    const offsetX = -totalWidth / 2;\n\n    ids.forEach((id, i) => {\n      const node = nodes.find(n => n.id === id);\n      if (node) {\n        node.x = startX + offsetX + i * SPACING_X;\n        node.y = startY + level * SPACING_Y;\n      }\n    });\n  }\n}\n\nfunction getTypeColor(type: string): string {\n  const colors: Record<string, string> = {\n    \"flow-start\": \"#22c55e\",\n    \"flow-end\": \"#ef4444\",\n    \"flow-decision\": \"#f59e0b\",\n    \"flow-process\": \"#3b82f6\",\n    \"flow-data\": \"#8b5cf6\",\n    \"flow-subprocess\": \"#06b6d4\",\n    \"arch-database\": \"#6366f1\",\n    \"arch-service\": \"#3b82f6\",\n    \"arch-api\": \"#10b981\",\n    \"arch-client\": \"#f97316\",\n    \"arch-cloud\": \"#8b5cf6\",\n    \"arch-queue\": \"#ec4899\",\n  };\n  return colors[type] || \"#3b82f6\";\n}\n\n// ============================================================================\n// Serialize / Deserialize Canvas\n// ============================================================================\n\nexport function serializeCanvas(\n  name: string,\n  nodes: CanvasNodeData[],\n  edges: CanvasEdgeData[],\n  drawingElements: DrawingElementData[] = [],\n  viewport: { x: number; y: number; zoom: number }\n): string {\n  const data: CanvasExportData = {\n    type: \"openclaw-canvas\",\n    version: 2,\n    name,\n    createdAt: new Date().toISOString(),\n    nodes,\n    edges,\n    drawingElements,\n    viewport,\n  };\n  return JSON.stringify(data, null, 2);\n}\n\nexport function deserializeCanvas(json: string): CanvasExportData | null {\n  try {\n    const data = JSON.parse(json);\n    if (data.type !== \"openclaw-canvas\") {\n      console.warn(\"Unknown canvas format, attempting import anyway\");\n    }\n    return {\n      type: \"openclaw-canvas\",\n      version: data.version || 1,\n      name: data.name || \"Imported Canvas\",\n      createdAt: data.createdAt || new Date().toISOString(),\n      nodes: Array.isArray(data.nodes) ? data.nodes : Array.isArray(data.elements) ? data.elements : [],\n      edges: Array.isArray(data.edges) ? data.edges : [],\n      drawingElements: Array.isArray(data.drawingElements) ? data.drawingElements : [],\n      viewport: data.viewport || { x: 0, y: 0, zoom: 1 },\n    };\n  } catch (e) {\n    console.error(\"Failed to deserialize canvas:\", e);\n    return null;\n  }\n}\n\n// ============================================================================\n// Canvas to SVG\n// ============================================================================\n\nexport function canvasToSVG(\n  nodes: CanvasNodeData[],\n  edges: CanvasEdgeData[],\n  drawingElements: DrawingElementData[] = [],\n  options: { background?: string; padding?: number } = {}\n): string {\n  const { background = \"#ffffff\", padding = 40 } = options;\n\n  // Calculate bounds\n  let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;\n\n  for (const node of nodes) {\n    minX = Math.min(minX, node.x);\n    minY = Math.min(minY, node.y);\n    maxX = Math.max(maxX, node.x + node.width);\n    maxY = Math.max(maxY, node.y + node.height);\n  }\n\n  for (const el of drawingElements) {\n    minX = Math.min(minX, el.x);\n    minY = Math.min(minY, el.y);\n    maxX = Math.max(maxX, el.x + el.width);\n    maxY = Math.max(maxY, el.y + el.height);\n  }\n\n  if (minX === Infinity) { minX = 0; minY = 0; maxX = 400; maxY = 300; }\n\n  const width = maxX - minX + padding * 2;\n  const height = maxY - minY + padding * 2;\n  const offsetX = -minX + padding;\n  const offsetY = -minY + padding;\n\n  const parts: string[] = [];\n  parts.push(`<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"${width}\" height=\"${height}\" viewBox=\"0 0 ${width} ${height}\">`);\n  parts.push(`  <rect width=\"100%\" height=\"100%\" fill=\"${escapeXml(background)}\" />`);\n  parts.push(`  <g transform=\"translate(${offsetX}, ${offsetY})\">`);\n\n  // Render edges\n  parts.push(`    <defs><marker id=\"arrowhead\" markerWidth=\"10\" markerHeight=\"7\" refX=\"10\" refY=\"3.5\" orient=\"auto\"><polygon points=\"0 0, 10 3.5, 0 7\" fill=\"#6b7280\" /></marker></defs>`);\n\n  for (const edge of edges) {\n    const src = nodes.find(n => n.id === edge.source);\n    const tgt = nodes.find(n => n.id === edge.target);\n    if (src && tgt) {\n      const x1 = src.x + src.width / 2;\n      const y1 = src.y + src.height / 2;\n      const x2 = tgt.x + tgt.width / 2;\n      const y2 = tgt.y + tgt.height / 2;\n      parts.push(`    <line x1=\"${x1}\" y1=\"${y1}\" x2=\"${x2}\" y2=\"${y2}\" stroke=\"#6b7280\" stroke-width=\"2\" marker-end=\"url(#arrowhead)\" />`);\n      if (edge.label) {\n        const mx = (x1 + x2) / 2;\n        const my = (y1 + y2) / 2;\n        parts.push(`    <text x=\"${mx}\" y=\"${my - 8}\" text-anchor=\"middle\" font-size=\"12\" fill=\"#6b7280\">${escapeXml(edge.label)}</text>`);\n      }\n    }\n  }\n\n  // Render nodes\n  for (const node of nodes) {\n    const fill = (node.style?.fill as string) || \"#3b82f6\";\n    const label = node.content || \"\";\n\n    if (node.type === \"flow-decision\") {\n      const cx = node.x + node.width / 2;\n      const cy = node.y + node.height / 2;\n      parts.push(`    <polygon points=\"${cx},${node.y} ${node.x + node.width},${cy} ${cx},${node.y + node.height} ${node.x},${cy}\" fill=\"${escapeXml(fill)}\" stroke=\"#1e1e1e\" stroke-width=\"1.5\" />`);\n    } else if (node.type === \"flow-start\" || node.type === \"flow-end\") {\n      parts.push(`    <rect x=\"${node.x}\" y=\"${node.y}\" width=\"${node.width}\" height=\"${node.height}\" rx=\"${node.height / 2}\" fill=\"${escapeXml(fill)}\" stroke=\"#1e1e1e\" stroke-width=\"1.5\" />`);\n    } else if (node.type === \"arch-database\") {\n      parts.push(`    <ellipse cx=\"${node.x + node.width / 2}\" cy=\"${node.y + 12}\" rx=\"${node.width / 2}\" ry=\"12\" fill=\"${escapeXml(fill)}\" stroke=\"#1e1e1e\" stroke-width=\"1.5\" />`);\n      parts.push(`    <rect x=\"${node.x}\" y=\"${node.y + 12}\" width=\"${node.width}\" height=\"${node.height - 24}\" fill=\"${escapeXml(fill)}\" stroke=\"#1e1e1e\" stroke-width=\"1.5\" />`);\n      parts.push(`    <ellipse cx=\"${node.x + node.width / 2}\" cy=\"${node.y + node.height - 12}\" rx=\"${node.width / 2}\" ry=\"12\" fill=\"${escapeXml(fill)}\" stroke=\"#1e1e1e\" stroke-width=\"1.5\" />`);\n    } else {\n      parts.push(`    <rect x=\"${node.x}\" y=\"${node.y}\" width=\"${node.width}\" height=\"${node.height}\" rx=\"8\" fill=\"${escapeXml(fill)}\" stroke=\"#1e1e1e\" stroke-width=\"1.5\" />`);\n    }\n\n    parts.push(`    <text x=\"${node.x + node.width / 2}\" y=\"${node.y + node.height / 2}\" text-anchor=\"middle\" dominant-baseline=\"middle\" font-size=\"14\" fill=\"white\" font-family=\"system-ui, sans-serif\">${escapeXml(label)}</text>`);\n  }\n\n  // Render drawing elements\n  for (const el of drawingElements) {\n    const stroke = escapeXml(el.strokeColor || \"#1e1e1e\");\n    const sw = el.strokeWidth || 2;\n    const fill = el.fillStyle === \"solid\" ? escapeXml(el.backgroundColor || \"none\") : \"none\";\n    const dasharray = el.strokeStyle === \"dashed\" ? ' stroke-dasharray=\"12,6\"' : el.strokeStyle === \"dotted\" ? ' stroke-dasharray=\"3,6\"' : \"\";\n\n    if (el.type === \"rectangle\") {\n      parts.push(`    <rect x=\"${el.x}\" y=\"${el.y}\" width=\"${el.width}\" height=\"${el.height}\" fill=\"${fill}\" stroke=\"${stroke}\" stroke-width=\"${sw}\"${dasharray} opacity=\"${(el.opacity || 100) / 100}\" />`);\n    } else if (el.type === \"ellipse\") {\n      parts.push(`    <ellipse cx=\"${el.x + el.width / 2}\" cy=\"${el.y + el.height / 2}\" rx=\"${el.width / 2}\" ry=\"${el.height / 2}\" fill=\"${fill}\" stroke=\"${stroke}\" stroke-width=\"${sw}\"${dasharray} opacity=\"${(el.opacity || 100) / 100}\" />`);\n    } else if (el.type === \"diamond\") {\n      const cx = el.x + el.width / 2;\n      const cy = el.y + el.height / 2;\n      parts.push(`    <polygon points=\"${cx},${el.y} ${el.x + el.width},${cy} ${cx},${el.y + el.height} ${el.x},${cy}\" fill=\"${fill}\" stroke=\"${stroke}\" stroke-width=\"${sw}\"${dasharray} />`);\n    } else if ((el.type === \"line\" || el.type === \"arrow\" || el.type === \"freedraw\") && el.points) {\n      const pts = el.points.map(p => `${el.x + p.x},${el.y + p.y}`).join(\" \");\n      parts.push(`    <polyline points=\"${pts}\" fill=\"none\" stroke=\"${stroke}\" stroke-width=\"${sw}\"${dasharray} />`);\n    }\n  }\n\n  parts.push(\"  </g>\");\n  parts.push(\"</svg>\");\n  return parts.join(\"\\n\");\n}\n\nfunction escapeXml(s: string): string {\n  return s.replace(/&/g, \"&amp;\").replace(/</g, \"&lt;\").replace(/>/g, \"&gt;\").replace(/\"/g, \"&quot;\");\n}\n\n// ============================================================================\n// AI Diagram Prompt Builder\n// ============================================================================\n\nexport function buildDiagramPrompt(description: string): string {\n  return `Generate a Mermaid diagram based on this description. Return ONLY the Mermaid syntax, no explanation or markdown fences.\n\nDescription: ${description}\n\nRules:\n- Use \"flowchart TD\" for top-down flow diagrams\n- Use \"flowchart LR\" for left-right flow diagrams\n- Use descriptive node labels\n- Use appropriate shapes: [rect], (round), {diamond}, ([stadium]), [[subprocess]]\n- Add edge labels where meaningful\n- Keep it clean and readable\n- Maximum 15 nodes for clarity`;\n}\n\n// ============================================================================\n// Example Mermaid Templates\n// ============================================================================\n\nexport const MERMAID_TEMPLATES: Record<string, { label: string; code: string }> = {\n  flowchart: {\n    label: \"Flowchart\",\n    code: `flowchart TD\n    A([Start]) --> B[Process Data]\n    B --> C{Valid?}\n    C -->|Yes| D[Save to DB]\n    C -->|No| E[Show Error]\n    D --> F([End])\n    E --> B`,\n  },\n  sequence: {\n    label: \"Sequence Diagram\",\n    code: `sequenceDiagram\n    participant U as User\n    participant S as Server\n    participant DB as Database\n    U->>S: Request Data\n    S->>DB: Query\n    DB-->>S: Results\n    S-->>U: Response`,\n  },\n  architecture: {\n    label: \"Architecture\",\n    code: `flowchart LR\n    Client[Browser Client] --> API[API Gateway]\n    API --> Auth[Auth Service]\n    API --> Core[Core Service]\n    Core --> DB[(PostgreSQL)]\n    Core --> Cache[(Redis)]\n    Core --> Queue[Message Queue]\n    Queue --> Worker[Worker Service]`,\n  },\n  state: {\n    label: \"State Machine\",\n    code: `stateDiagram-v2\n    [*] --> Idle\n    Idle --> Loading: fetch\n    Loading --> Success: resolve\n    Loading --> Error: reject\n    Success --> Idle: reset\n    Error --> Loading: retry\n    Error --> Idle: dismiss`,\n  },\n  er: {\n    label: \"ER Diagram\",\n    code: `erDiagram\n    USER ||--o{ POST : writes\n    USER ||--o{ COMMENT : makes\n    POST ||--o{ COMMENT : has\n    POST }o--|| CATEGORY : belongs_to\n    USER {\n      int id\n      string name\n      string email\n    }\n    POST {\n      int id\n      string title\n      text content\n    }`,\n  },\n  gitgraph: {\n    label: \"Git Graph\",\n    code: `gitGraph\n    commit\n    branch develop\n    checkout develop\n    commit\n    commit\n    checkout main\n    merge develop\n    commit\n    branch feature\n    checkout feature\n    commit\n    checkout develop\n    merge feature\n    checkout main\n    merge develop`,\n  },\n};\n"],"names":[],"mappings":"AAAA;;;;;CAKC,GAED,+EAA+E;AAC/E,QAAQ;AACR,+EAA+E;;;;;;;;;;;;;;;;;AA0DxE,SAAS,gBACd,KAAuB,EACvB,KAAuB;IAEvB,MAAM,QAAkB;QAAC;KAAe;IACxC,MAAM,UAAU,IAAI;IAEpB,gCAAgC;IAChC,MAAM,OAAO,CAAC,CAAC,MAAM;QACnB,MAAM,QAAQ,KAAK,OAAO,EAAE,QAAQ,eAAe,OAAO,CAAC,IAAI,EAAE,GAAG;QACpE,MAAM,UAAU,CAAC,CAAC,EAAE,GAAG;QACvB,QAAQ,GAAG,CAAC,KAAK,EAAE,EAAE;QAErB,uCAAuC;QACvC,OAAQ,KAAK,IAAI;YACf,KAAK;gBACH,MAAM,IAAI,CAAC,CAAC,IAAI,EAAE,QAAQ,CAAC,EAAE,MAAM,CAAC,CAAC;gBACrC;YACF,KAAK;YACL,KAAK;gBACH,MAAM,IAAI,CAAC,CAAC,IAAI,EAAE,QAAQ,EAAE,EAAE,MAAM,EAAE,CAAC;gBACvC;YACF,KAAK;gBACH,MAAM,IAAI,CAAC,CAAC,IAAI,EAAE,QAAQ,CAAC,EAAE,MAAM,CAAC,CAAC;gBACrC;YACF,KAAK;gBACH,MAAM,IAAI,CAAC,CAAC,IAAI,EAAE,QAAQ,EAAE,EAAE,MAAM,EAAE,CAAC;gBACvC;YACF,KAAK;gBACH,MAAM,IAAI,CAAC,CAAC,IAAI,EAAE,QAAQ,EAAE,EAAE,MAAM,EAAE,CAAC;gBACvC;YACF,KAAK;gBACH,MAAM,IAAI,CAAC,CAAC,IAAI,EAAE,QAAQ,EAAE,EAAE,MAAM,EAAE,CAAC;gBACvC;YACF,KAAK;YACL,KAAK;gBACH,MAAM,IAAI,CAAC,CAAC,IAAI,EAAE,QAAQ,CAAC,EAAE,MAAM,CAAC,CAAC;gBACrC;YACF,KAAK;gBACH,MAAM,IAAI,CAAC,CAAC,IAAI,EAAE,QAAQ,CAAC,EAAE,MAAM,CAAC,CAAC;gBACrC;YACF,KAAK;gBACH,MAAM,IAAI,CAAC,CAAC,IAAI,EAAE,QAAQ,EAAE,EAAE,MAAM,CAAC,CAAC;gBACtC;YACF,KAAK;gBACH,MAAM,IAAI,CAAC,CAAC,IAAI,EAAE,QAAQ,EAAE,EAAE,MAAM,EAAE,CAAC;gBACvC;YACF;gBACE,sCAAsC;gBACtC,MAAM,IAAI,CAAC,CAAC,IAAI,EAAE,QAAQ,EAAE,EAAE,MAAM,EAAE,CAAC;QAC3C;IACF;IAEA,YAAY;IACZ,MAAM,OAAO,CAAC,CAAC;QACb,MAAM,SAAS,QAAQ,GAAG,CAAC,KAAK,MAAM;QACtC,MAAM,SAAS,QAAQ,GAAG,CAAC,KAAK,MAAM;QACtC,IAAI,UAAU,QAAQ;YACpB,IAAI,KAAK,KAAK,EAAE;gBACd,MAAM,IAAI,CAAC,CAAC,IAAI,EAAE,OAAO,KAAK,EAAE,KAAK,KAAK,CAAC,EAAE,EAAE,QAAQ;YACzD,OAAO;gBACL,MAAM,IAAI,CAAC,CAAC,IAAI,EAAE,OAAO,KAAK,EAAE,QAAQ;YAC1C;QACF;IACF;IAEA,OAAO,MAAM,IAAI,CAAC;AACpB;AAWO,eAAe,gBACpB,UAAkB,EAClB,SAAiB,CAAC,EAClB,SAAiB,CAAC;IAElB,MAAM,QAA0B,EAAE;IAClC,MAAM,QAA0B,EAAE;IAClC,MAAM,YAAY,IAAI;IAEtB,qDAAqD;IACrD,MAAM,QAAQ,WAAW,KAAK,CAAC,MAAM,GAAG,CAAC,CAAA,IAAK,EAAE,IAAI,IAAI,MAAM,CAAC,CAAA,IAAK,KAAK,CAAC,EAAE,UAAU,CAAC;IAEvF,uCAAuC;IACvC,MAAM,eAAe,MAAM,MAAM,CAAC,CAAA,IAAK,CAAC,EAAE,KAAK,CAAC;IAEhD,IAAI,YAAY;IAChB,MAAM,YAAY;IAClB,MAAM,YAAY;IAClB,MAAM,OAAO;IAEb,KAAK,MAAM,QAAQ,aAAc;QAC/B,qCAAqC;QACrC,kFAAkF;QAClF,MAAM,eAAe;YACnB;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;SACD;QAED,KAAK,MAAM,WAAW,aAAc;YAClC,QAAQ,SAAS,GAAG;YACpB,IAAI;YACJ,MAAO,CAAC,QAAQ,QAAQ,IAAI,CAAC,KAAK,MAAM,KAAM;gBAC5C,MAAM,KAAK,KAAK,CAAC,EAAE;gBACnB,MAAM,OAAO,KAAK,CAAC,EAAE;gBACrB,IAAI,CAAC,UAAU,GAAG,CAAC,KAAK;oBACtB,MAAM,MAAM,YAAY;oBACxB,MAAM,MAAM,KAAK,KAAK,CAAC,YAAY;oBACnC,MAAM,WAAW,CAAC,aAAa,EAAE,KAAK,GAAG,GAAG,CAAC,EAAE,WAAW;oBAE1D,4BAA4B;oBAC5B,IAAI,OAAO;oBACX,IAAI,QAAQ,MAAM,CAAC,QAAQ,CAAC,WAAW,OAAO;yBACzC,IAAI,QAAQ,MAAM,CAAC,QAAQ,CAAC,WAAW,OAAO;yBAC9C,IAAI,QAAQ,MAAM,CAAC,QAAQ,CAAC,QAAQ,OAAO;yBAC3C,IAAI,QAAQ,MAAM,CAAC,QAAQ,CAAC,WAAW,OAAO;yBAC9C,IAAI,QAAQ,MAAM,CAAC,QAAQ,CAAC,WAAW,OAAO;yBAC9C,IAAI,QAAQ,MAAM,CAAC,QAAQ,CAAC,QAAQ,OAAO;yBAC3C,IAAI,QAAQ,MAAM,CAAC,QAAQ,CAAC,QAAQ,OAAO;oBAEhD,MAAM,IAAI,CAAC;wBACT,IAAI;wBACJ;wBACA,GAAG,SAAS,MAAM;wBAClB,GAAG,SAAS,MAAM;wBAClB,OAAO;wBACP,QAAQ;wBACR,SAAS;wBACT,OAAO;4BAAE,MAAM,aAAa;wBAAM;oBACpC;oBACA,UAAU,GAAG,CAAC,IAAI;oBAClB;gBACF;YACF;QACF;QAEA,mEAAmE;QACnE,MAAM,cAAc;QACpB,IAAI;QACJ,MAAO,CAAC,YAAY,YAAY,IAAI,CAAC,KAAK,MAAM,KAAM;YACpD,MAAM,WAAW,SAAS,CAAC,EAAE;YAC7B,MAAM,QAAQ,SAAS,CAAC,EAAE,IAAI;YAC9B,MAAM,WAAW,SAAS,CAAC,EAAE;YAE7B,0BAA0B;YAC1B,IAAI,CAAC,UAAU,GAAG,CAAC,WAAW;gBAC5B,MAAM,MAAM,YAAY;gBACxB,MAAM,MAAM,KAAK,KAAK,CAAC,YAAY;gBACnC,MAAM,WAAW,CAAC,aAAa,EAAE,KAAK,GAAG,GAAG,CAAC,EAAE,WAAW;gBAC1D,MAAM,IAAI,CAAC;oBACT,IAAI;oBAAU,MAAM;oBACpB,GAAG,SAAS,MAAM;oBAAW,GAAG,SAAS,MAAM;oBAC/C,OAAO;oBAAK,QAAQ;oBAAI,SAAS;oBACjC,OAAO;wBAAE,MAAM;oBAAU;gBAC3B;gBACA,UAAU,GAAG,CAAC,UAAU;gBACxB;YACF;YACA,IAAI,CAAC,UAAU,GAAG,CAAC,WAAW;gBAC5B,MAAM,MAAM,YAAY;gBACxB,MAAM,MAAM,KAAK,KAAK,CAAC,YAAY;gBACnC,MAAM,WAAW,CAAC,aAAa,EAAE,KAAK,GAAG,GAAG,CAAC,EAAE,WAAW;gBAC1D,MAAM,IAAI,CAAC;oBACT,IAAI;oBAAU,MAAM;oBACpB,GAAG,SAAS,MAAM;oBAAW,GAAG,SAAS,MAAM;oBAC/C,OAAO;oBAAK,QAAQ;oBAAI,SAAS;oBACjC,OAAO;wBAAE,MAAM;oBAAU;gBAC3B;gBACA,UAAU,GAAG,CAAC,UAAU;gBACxB;YACF;YAEA,MAAM,iBAAiB,UAAU,GAAG,CAAC;YACrC,MAAM,iBAAiB,UAAU,GAAG,CAAC;YAErC,MAAM,IAAI,CAAC;gBACT,IAAI,CAAC,aAAa,EAAE,KAAK,GAAG,GAAG,CAAC,EAAE,MAAM,MAAM,EAAE;gBAChD,QAAQ;gBACR,QAAQ;gBACR,MAAM;gBACN;YACF;QACF;IACF;IAEA,gDAAgD;IAChD,IAAI,MAAM,MAAM,GAAG,GAAG;QACpB,eAAe,OAAO,OAAO,QAAQ;IACvC;IAEA,OAAO;QAAE;QAAO;IAAM;AACxB;AAEA,+EAA+E;AAC/E,cAAc;AACd,+EAA+E;AAE/E,SAAS,eACP,KAAuB,EACvB,KAAuB,EACvB,MAAc,EACd,MAAc;IAEd,uBAAuB;IACvB,MAAM,WAAW,IAAI;IACrB,MAAM,YAAY,IAAI;IAEtB,KAAK,MAAM,QAAQ,MAAO;QACxB,IAAI,CAAC,SAAS,GAAG,CAAC,KAAK,MAAM,GAAG,SAAS,GAAG,CAAC,KAAK,MAAM,EAAE,EAAE;QAC5D,SAAS,GAAG,CAAC,KAAK,MAAM,EAAG,IAAI,CAAC,KAAK,MAAM;QAC3C,UAAU,GAAG,CAAC,KAAK,MAAM;IAC3B;IAEA,4CAA4C;IAC5C,MAAM,QAAQ,MAAM,MAAM,CAAC,CAAA,IAAK,CAAC,UAAU,GAAG,CAAC,EAAE,EAAE,GAAG,GAAG,CAAC,CAAA,IAAK,EAAE,EAAE;IACnE,IAAI,MAAM,MAAM,KAAK,KAAK,MAAM,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC,EAAE;IAElE,MAAM,SAAS,IAAI;IACnB,MAAM,QAAQ,MAAM,GAAG,CAAC,CAAA,KAAM,CAAC;YAAE;YAAI,OAAO;QAAE,CAAC;IAC/C,MAAM,UAAU,IAAI;IAEpB,MAAO,MAAM,MAAM,GAAG,EAAG;QACvB,MAAM,EAAE,EAAE,EAAE,KAAK,EAAE,GAAG,MAAM,KAAK;QACjC,IAAI,QAAQ,GAAG,CAAC,KAAK;QACrB,QAAQ,GAAG,CAAC;QACZ,OAAO,GAAG,CAAC,IAAI;QAEf,MAAM,OAAO,SAAS,GAAG,CAAC,OAAO,EAAE;QACnC,KAAK,MAAM,OAAO,KAAM;YACtB,MAAM,IAAI,CAAC;gBAAE,IAAI;gBAAK,OAAO,QAAQ;YAAE;QACzC;IACF;IAEA,iBAAiB;IACjB,MAAM,cAAc,IAAI;IACxB,KAAK,MAAM,CAAC,IAAI,MAAM,IAAI,OAAQ;QAChC,IAAI,CAAC,YAAY,GAAG,CAAC,QAAQ,YAAY,GAAG,CAAC,OAAO,EAAE;QACtD,YAAY,GAAG,CAAC,OAAQ,IAAI,CAAC;IAC/B;IAEA,iBAAiB;IACjB,MAAM,YAAY;IAClB,MAAM,YAAY;IAElB,KAAK,MAAM,CAAC,OAAO,IAAI,IAAI,YAAa;QACtC,MAAM,aAAa,CAAC,IAAI,MAAM,GAAG,CAAC,IAAI;QACtC,MAAM,UAAU,CAAC,aAAa;QAE9B,IAAI,OAAO,CAAC,CAAC,IAAI;YACf,MAAM,OAAO,MAAM,IAAI,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK;YACtC,IAAI,MAAM;gBACR,KAAK,CAAC,GAAG,SAAS,UAAU,IAAI;gBAChC,KAAK,CAAC,GAAG,SAAS,QAAQ;YAC5B;QACF;IACF;AACF;AAEA,SAAS,aAAa,IAAY;IAChC,MAAM,SAAiC;QACrC,cAAc;QACd,YAAY;QACZ,iBAAiB;QACjB,gBAAgB;QAChB,aAAa;QACb,mBAAmB;QACnB,iBAAiB;QACjB,gBAAgB;QAChB,YAAY;QACZ,eAAe;QACf,cAAc;QACd,cAAc;IAChB;IACA,OAAO,MAAM,CAAC,KAAK,IAAI;AACzB;AAMO,SAAS,gBACd,IAAY,EACZ,KAAuB,EACvB,KAAuB,EACvB,kBAAwC,EAAE,EAC1C,QAAgD;IAEhD,MAAM,OAAyB;QAC7B,MAAM;QACN,SAAS;QACT;QACA,WAAW,IAAI,OAAO,WAAW;QACjC;QACA;QACA;QACA;IACF;IACA,OAAO,KAAK,SAAS,CAAC,MAAM,MAAM;AACpC;AAEO,SAAS,kBAAkB,IAAY;IAC5C,IAAI;QACF,MAAM,OAAO,KAAK,KAAK,CAAC;QACxB,IAAI,KAAK,IAAI,KAAK,mBAAmB;YACnC,QAAQ,IAAI,CAAC;QACf;QACA,OAAO;YACL,MAAM;YACN,SAAS,KAAK,OAAO,IAAI;YACzB,MAAM,KAAK,IAAI,IAAI;YACnB,WAAW,KAAK,SAAS,IAAI,IAAI,OAAO,WAAW;YACnD,OAAO,MAAM,OAAO,CAAC,KAAK,KAAK,IAAI,KAAK,KAAK,GAAG,MAAM,OAAO,CAAC,KAAK,QAAQ,IAAI,KAAK,QAAQ,GAAG,EAAE;YACjG,OAAO,MAAM,OAAO,CAAC,KAAK,KAAK,IAAI,KAAK,KAAK,GAAG,EAAE;YAClD,iBAAiB,MAAM,OAAO,CAAC,KAAK,eAAe,IAAI,KAAK,eAAe,GAAG,EAAE;YAChF,UAAU,KAAK,QAAQ,IAAI;gBAAE,GAAG;gBAAG,GAAG;gBAAG,MAAM;YAAE;QACnD;IACF,EAAE,OAAO,GAAG;QACV,QAAQ,KAAK,CAAC,iCAAiC;QAC/C,OAAO;IACT;AACF;AAMO,SAAS,YACd,KAAuB,EACvB,KAAuB,EACvB,kBAAwC,EAAE,EAC1C,UAAqD,CAAC,CAAC;IAEvD,MAAM,EAAE,aAAa,SAAS,EAAE,UAAU,EAAE,EAAE,GAAG;IAEjD,mBAAmB;IACnB,IAAI,OAAO,UAAU,OAAO,UAAU,OAAO,CAAC,UAAU,OAAO,CAAC;IAEhE,KAAK,MAAM,QAAQ,MAAO;QACxB,OAAO,KAAK,GAAG,CAAC,MAAM,KAAK,CAAC;QAC5B,OAAO,KAAK,GAAG,CAAC,MAAM,KAAK,CAAC;QAC5B,OAAO,KAAK,GAAG,CAAC,MAAM,KAAK,CAAC,GAAG,KAAK,KAAK;QACzC,OAAO,KAAK,GAAG,CAAC,MAAM,KAAK,CAAC,GAAG,KAAK,MAAM;IAC5C;IAEA,KAAK,MAAM,MAAM,gBAAiB;QAChC,OAAO,KAAK,GAAG,CAAC,MAAM,GAAG,CAAC;QAC1B,OAAO,KAAK,GAAG,CAAC,MAAM,GAAG,CAAC;QAC1B,OAAO,KAAK,GAAG,CAAC,MAAM,GAAG,CAAC,GAAG,GAAG,KAAK;QACrC,OAAO,KAAK,GAAG,CAAC,MAAM,GAAG,CAAC,GAAG,GAAG,MAAM;IACxC;IAEA,IAAI,SAAS,UAAU;QAAE,OAAO;QAAG,OAAO;QAAG,OAAO;QAAK,OAAO;IAAK;IAErE,MAAM,QAAQ,OAAO,OAAO,UAAU;IACtC,MAAM,SAAS,OAAO,OAAO,UAAU;IACvC,MAAM,UAAU,CAAC,OAAO;IACxB,MAAM,UAAU,CAAC,OAAO;IAExB,MAAM,QAAkB,EAAE;IAC1B,MAAM,IAAI,CAAC,CAAC,+CAA+C,EAAE,MAAM,UAAU,EAAE,OAAO,eAAe,EAAE,MAAM,CAAC,EAAE,OAAO,EAAE,CAAC;IAC1H,MAAM,IAAI,CAAC,CAAC,yCAAyC,EAAE,UAAU,YAAY,IAAI,CAAC;IAClF,MAAM,IAAI,CAAC,CAAC,0BAA0B,EAAE,QAAQ,EAAE,EAAE,QAAQ,GAAG,CAAC;IAEhE,eAAe;IACf,MAAM,IAAI,CAAC,CAAC,0KAA0K,CAAC;IAEvL,KAAK,MAAM,QAAQ,MAAO;QACxB,MAAM,MAAM,MAAM,IAAI,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK,KAAK,MAAM;QAChD,MAAM,MAAM,MAAM,IAAI,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK,KAAK,MAAM;QAChD,IAAI,OAAO,KAAK;YACd,MAAM,KAAK,IAAI,CAAC,GAAG,IAAI,KAAK,GAAG;YAC/B,MAAM,KAAK,IAAI,CAAC,GAAG,IAAI,MAAM,GAAG;YAChC,MAAM,KAAK,IAAI,CAAC,GAAG,IAAI,KAAK,GAAG;YAC/B,MAAM,KAAK,IAAI,CAAC,GAAG,IAAI,MAAM,GAAG;YAChC,MAAM,IAAI,CAAC,CAAC,cAAc,EAAE,GAAG,MAAM,EAAE,GAAG,MAAM,EAAE,GAAG,MAAM,EAAE,GAAG,mEAAmE,CAAC;YACpI,IAAI,KAAK,KAAK,EAAE;gBACd,MAAM,KAAK,CAAC,KAAK,EAAE,IAAI;gBACvB,MAAM,KAAK,CAAC,KAAK,EAAE,IAAI;gBACvB,MAAM,IAAI,CAAC,CAAC,aAAa,EAAE,GAAG,KAAK,EAAE,KAAK,EAAE,qDAAqD,EAAE,UAAU,KAAK,KAAK,EAAE,OAAO,CAAC;YACnI;QACF;IACF;IAEA,eAAe;IACf,KAAK,MAAM,QAAQ,MAAO;QACxB,MAAM,OAAO,AAAC,KAAK,KAAK,EAAE,QAAmB;QAC7C,MAAM,QAAQ,KAAK,OAAO,IAAI;QAE9B,IAAI,KAAK,IAAI,KAAK,iBAAiB;YACjC,MAAM,KAAK,KAAK,CAAC,GAAG,KAAK,KAAK,GAAG;YACjC,MAAM,KAAK,KAAK,CAAC,GAAG,KAAK,MAAM,GAAG;YAClC,MAAM,IAAI,CAAC,CAAC,qBAAqB,EAAE,GAAG,CAAC,EAAE,KAAK,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,GAAG,KAAK,KAAK,CAAC,CAAC,EAAE,GAAG,CAAC,EAAE,GAAG,CAAC,EAAE,KAAK,CAAC,GAAG,KAAK,MAAM,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC,CAAC,EAAE,GAAG,QAAQ,EAAE,UAAU,MAAM,wCAAwC,CAAC;QAChM,OAAO,IAAI,KAAK,IAAI,KAAK,gBAAgB,KAAK,IAAI,KAAK,YAAY;YACjE,MAAM,IAAI,CAAC,CAAC,aAAa,EAAE,KAAK,CAAC,CAAC,KAAK,EAAE,KAAK,CAAC,CAAC,SAAS,EAAE,KAAK,KAAK,CAAC,UAAU,EAAE,KAAK,MAAM,CAAC,MAAM,EAAE,KAAK,MAAM,GAAG,EAAE,QAAQ,EAAE,UAAU,MAAM,wCAAwC,CAAC;QAC3L,OAAO,IAAI,KAAK,IAAI,KAAK,iBAAiB;YACxC,MAAM,IAAI,CAAC,CAAC,iBAAiB,EAAE,KAAK,CAAC,GAAG,KAAK,KAAK,GAAG,EAAE,MAAM,EAAE,KAAK,CAAC,GAAG,GAAG,MAAM,EAAE,KAAK,KAAK,GAAG,EAAE,gBAAgB,EAAE,UAAU,MAAM,wCAAwC,CAAC;YAC7K,MAAM,IAAI,CAAC,CAAC,aAAa,EAAE,KAAK,CAAC,CAAC,KAAK,EAAE,KAAK,CAAC,GAAG,GAAG,SAAS,EAAE,KAAK,KAAK,CAAC,UAAU,EAAE,KAAK,MAAM,GAAG,GAAG,QAAQ,EAAE,UAAU,MAAM,wCAAwC,CAAC;YAC3K,MAAM,IAAI,CAAC,CAAC,iBAAiB,EAAE,KAAK,CAAC,GAAG,KAAK,KAAK,GAAG,EAAE,MAAM,EAAE,KAAK,CAAC,GAAG,KAAK,MAAM,GAAG,GAAG,MAAM,EAAE,KAAK,KAAK,GAAG,EAAE,gBAAgB,EAAE,UAAU,MAAM,wCAAwC,CAAC;QAC7L,OAAO;YACL,MAAM,IAAI,CAAC,CAAC,aAAa,EAAE,KAAK,CAAC,CAAC,KAAK,EAAE,KAAK,CAAC,CAAC,SAAS,EAAE,KAAK,KAAK,CAAC,UAAU,EAAE,KAAK,MAAM,CAAC,eAAe,EAAE,UAAU,MAAM,wCAAwC,CAAC;QAC1K;QAEA,MAAM,IAAI,CAAC,CAAC,aAAa,EAAE,KAAK,CAAC,GAAG,KAAK,KAAK,GAAG,EAAE,KAAK,EAAE,KAAK,CAAC,GAAG,KAAK,MAAM,GAAG,EAAE,kHAAkH,EAAE,UAAU,OAAO,OAAO,CAAC;IAClO;IAEA,0BAA0B;IAC1B,KAAK,MAAM,MAAM,gBAAiB;QAChC,MAAM,SAAS,UAAU,GAAG,WAAW,IAAI;QAC3C,MAAM,KAAK,GAAG,WAAW,IAAI;QAC7B,MAAM,OAAO,GAAG,SAAS,KAAK,UAAU,UAAU,GAAG,eAAe,IAAI,UAAU;QAClF,MAAM,YAAY,GAAG,WAAW,KAAK,WAAW,6BAA6B,GAAG,WAAW,KAAK,WAAW,4BAA4B;QAEvI,IAAI,GAAG,IAAI,KAAK,aAAa;YAC3B,MAAM,IAAI,CAAC,CAAC,aAAa,EAAE,GAAG,CAAC,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC,SAAS,EAAE,GAAG,KAAK,CAAC,UAAU,EAAE,GAAG,MAAM,CAAC,QAAQ,EAAE,KAAK,UAAU,EAAE,OAAO,gBAAgB,EAAE,GAAG,CAAC,EAAE,UAAU,UAAU,EAAE,CAAC,GAAG,OAAO,IAAI,GAAG,IAAI,IAAI,IAAI,CAAC;QACvM,OAAO,IAAI,GAAG,IAAI,KAAK,WAAW;YAChC,MAAM,IAAI,CAAC,CAAC,iBAAiB,EAAE,GAAG,CAAC,GAAG,GAAG,KAAK,GAAG,EAAE,MAAM,EAAE,GAAG,CAAC,GAAG,GAAG,MAAM,GAAG,EAAE,MAAM,EAAE,GAAG,KAAK,GAAG,EAAE,MAAM,EAAE,GAAG,MAAM,GAAG,EAAE,QAAQ,EAAE,KAAK,UAAU,EAAE,OAAO,gBAAgB,EAAE,GAAG,CAAC,EAAE,UAAU,UAAU,EAAE,CAAC,GAAG,OAAO,IAAI,GAAG,IAAI,IAAI,IAAI,CAAC;QAC5O,OAAO,IAAI,GAAG,IAAI,KAAK,WAAW;YAChC,MAAM,KAAK,GAAG,CAAC,GAAG,GAAG,KAAK,GAAG;YAC7B,MAAM,KAAK,GAAG,CAAC,GAAG,GAAG,MAAM,GAAG;YAC9B,MAAM,IAAI,CAAC,CAAC,qBAAqB,EAAE,GAAG,CAAC,EAAE,GAAG,CAAC,CAAC,CAAC,EAAE,GAAG,CAAC,GAAG,GAAG,KAAK,CAAC,CAAC,EAAE,GAAG,CAAC,EAAE,GAAG,CAAC,EAAE,GAAG,CAAC,GAAG,GAAG,MAAM,CAAC,CAAC,EAAE,GAAG,CAAC,CAAC,CAAC,EAAE,GAAG,QAAQ,EAAE,KAAK,UAAU,EAAE,OAAO,gBAAgB,EAAE,GAAG,CAAC,EAAE,UAAU,GAAG,CAAC;QACzL,OAAO,IAAI,CAAC,GAAG,IAAI,KAAK,UAAU,GAAG,IAAI,KAAK,WAAW,GAAG,IAAI,KAAK,UAAU,KAAK,GAAG,MAAM,EAAE;YAC7F,MAAM,MAAM,GAAG,MAAM,CAAC,GAAG,CAAC,CAAA,IAAK,GAAG,GAAG,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC,EAAE,GAAG,CAAC,GAAG,EAAE,CAAC,EAAE,EAAE,IAAI,CAAC;YACnE,MAAM,IAAI,CAAC,CAAC,sBAAsB,EAAE,IAAI,sBAAsB,EAAE,OAAO,gBAAgB,EAAE,GAAG,CAAC,EAAE,UAAU,GAAG,CAAC;QAC/G;IACF;IAEA,MAAM,IAAI,CAAC;IACX,MAAM,IAAI,CAAC;IACX,OAAO,MAAM,IAAI,CAAC;AACpB;AAEA,SAAS,UAAU,CAAS;IAC1B,OAAO,EAAE,OAAO,CAAC,MAAM,SAAS,OAAO,CAAC,MAAM,QAAQ,OAAO,CAAC,MAAM,QAAQ,OAAO,CAAC,MAAM;AAC5F;AAMO,SAAS,mBAAmB,WAAmB;IACpD,OAAO,CAAC;;aAEG,EAAE,YAAY;;;;;;;;;8BASG,CAAC;AAC/B;AAMO,MAAM,oBAAqE;IAChF,WAAW;QACT,OAAO;QACP,MAAM,CAAC;;;;;;WAMA,CAAC;IACV;IACA,UAAU;QACR,OAAO;QACP,MAAM,CAAC;;;;;;;oBAOS,CAAC;IACnB;IACA,cAAc;QACZ,OAAO;QACP,MAAM,CAAC;;;;;;;oCAOyB,CAAC;IACnC;IACA,OAAO;QACL,OAAO;QACP,MAAM,CAAC;;;;;;;2BAOgB,CAAC;IAC1B;IACA,IAAI;QACF,OAAO;QACP,MAAM,CAAC;;;;;;;;;;;;;;KAcN,CAAC;IACJ;IACA,UAAU;QACR,OAAO;QACP,MAAM,CAAC;;;;;;;;;;;;;;;iBAeM,CAAC;IAChB;AACF"}}]
}