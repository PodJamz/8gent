module.exports=[449650,e=>{"use strict";var t=e.i(457375),n=e.i(174015),r=e.i(116384),a=e.i(63831),o=e.i(868001),i=e.i(842780),s=e.i(763077),l=e.i(502964),c=e.i(993216),d=e.i(783900),u=e.i(295731),p=e.i(726839),m=e.i(775778),f=e.i(40992),y=e.i(432128),h=e.i(193695);e.i(44807);var g=e.i(989978),w=e.i(683107),R=e.i(527567),S=e.i(98689),x=e.i(929091),v=e.i(879389),O=e.i(572067);e.i(163859);var _=e.i(979317),N=e.i(192650);let C={windowMs:6e4,maxRequests:20};function E(e,t,n,r){(async()=>{try{let a=(0,N.getMemoryManager)();await a.processInteraction(e,{userMessage:t,aiResponse:n,toolsUsed:r},void 0),console.log("[Stream RLM] Stored interaction for owner")}catch(e){console.error("[Stream RLM] Failed to store interaction:",e)}})()}async function k(){try{let{userId:e}=await (0,O.auth)();if(e)return{accessLevel:"owner",userId:e};let t=await (0,w.cookies)(),n=t.get(ADMIN_COOKIE)?.value;if(n){let e=verifySession(n);if(e&&"admin"===e.type){let t=`admin-${e.subject}`;return{accessLevel:"owner",userId:t}}}return{accessLevel:"visitor",userId:null}}catch{return{accessLevel:"visitor",userId:null}}}async function T(e){return{primaryProvider:"cloud"}}async function A(e){try{let t,n=(0,v.getClientIp)(e),r=(0,v.checkRateLimit)(`chat-stream:${n}`,C);if(!r.allowed)return new Response(JSON.stringify({error:"Rate limit exceeded. Please wait before making more requests.",retryAfter:Math.ceil((r.resetAt-Date.now())/1e3)}),{status:429,headers:{"Content-Type":"application/json","Retry-After":String(Math.ceil((r.resetAt-Date.now())/1e3))}});let{messages:a,model:o="default",themeContext:i,enableTools:s=!1}=await e.json();if(!a||!Array.isArray(a))return new Response(JSON.stringify({error:"Messages array is required"}),{status:400,headers:{"Content-Type":"application/json"}});let{accessLevel:l,userId:c}=await k(),d=await T(l),u="claude"===o||"opus"===o||"sonnet"===o,p=process.env.ANTHROPIC_API_KEY,m=process.env.OPENAI_API_KEY,f=CLAW_AI_SYSTEM_PROMPT;R.THEME_CONTEXTS[o]&&(f+=R.THEME_CONTEXTS[o]),i&&(f+=`

## Current Design Context
${i}`);let y="",h=a.filter(e=>"user"===e.role).pop()?.content||"";if("owner"===l&&c)try{let e=(0,N.getMemoryManager)(),t=await e.loadRelevantMemories(c,h,{limit:10});t.contextSummary&&(y=`

## Memory Context (Eternal Window)
${t.contextSummary}`,f+=y,console.log("[Stream RLM] Loaded memory context for owner"))}catch(e){console.error("[Stream RLM] Failed to load memories:",e)}if(s){let e=getToolsForAccessLevel(l);t=(0,S.toOpenAITools)(e)}if("lynkr"===d.primaryProvider&&d.lynkrTunnelUrl&&d.lynkrApiKey)return console.log("[Stream] Using Lynkr provider via tunnel"),await b(a,f,d,l,c,h);if(u&&p)return await q(a,f,p,o,t,l,c,h);if(m)return await P(a,f,m,t,l,c,h);return new Response(JSON.stringify({error:"No API key configured"}),{status:500,headers:{"Content-Type":"application/json"}})}catch(e){return console.error("Chat stream API error:",e),new Response(JSON.stringify({error:"Internal server error"}),{status:500,headers:{"Content-Type":"application/json"}})}}async function b(e,t,n,r,a,o){let i=new TextEncoder,s=new ReadableStream({async start(s){let l="";try{if(!n.lynkrTunnelUrl||!n.lynkrApiKey){s.enqueue(i.encode(`data: ${JSON.stringify({error:"Lynkr not configured"})}

`)),s.close();return}let c=(0,_.getLynkrClient)({baseUrl:n.lynkrTunnelUrl,apiKey:n.lynkrApiKey,defaultModel:n.lynkrDefaultModel??"gpt-oss:20b",timeout:n.ollamaTimeout??3e4,skipSsrfValidation:!0}),d=e.map(e=>({role:e.role,content:e.content}));for await(let e of(console.log("[Lynkr Stream] Starting stream to:",n.lynkrTunnelUrl),c.chatStream({messages:d,system:t,model:n.lynkrDefaultModel??"gpt-oss:20b",max_tokens:4096,temperature:.7}))){console.log("[Lynkr Stream] Chunk:",JSON.stringify(e).slice(0,200));let t=e.delta;if("content_block_delta"===e.type&&t?.type==="text_delta"){let e=t.text;l+=e,s.enqueue(i.encode(`data: ${JSON.stringify({content:e})}

`))}else if("content_block_delta"===e.type&&t?.type==="thinking_delta"){let e=t.thinking;s.enqueue(i.encode(`data: ${JSON.stringify({thinking:e})}

`))}else e.content&&"string"==typeof e.content?(l+=e.content,s.enqueue(i.encode(`data: ${JSON.stringify({content:e.content})}

`))):e.thinking&&"string"==typeof e.thinking?s.enqueue(i.encode(`data: ${JSON.stringify({thinking:e.thinking})}

`)):e.response&&"string"==typeof e.response?(l+=e.response,s.enqueue(i.encode(`data: ${JSON.stringify({content:e.response})}

`))):e.text&&"string"==typeof e.text&&(l+=e.text,s.enqueue(i.encode(`data: ${JSON.stringify({content:e.text})}

`)))}"owner"===r&&a&&l&&E(a,o,l,[]),s.enqueue(i.encode("data: [DONE]\n\n")),s.close()}catch(t){console.error("[Lynkr Stream] Error:",t);let e=t instanceof Error?t.message:"Lynkr streaming failed";s.enqueue(i.encode(`data: ${JSON.stringify({error:e})}

`)),s.close()}}});return new Response(s,{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}})}async function P(e,t,n,r,a,o,i){let s=new TextEncoder;return new Response(new ReadableStream({async start(l){let c="",d=[],u=[{role:"system",content:t},...e.map(e=>({role:"user"===e.role?"user":"assistant",content:e.content}))],p=!0,m=0;for(;p&&m<10;){m++;let e=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({model:"gpt-4o",messages:u,max_tokens:2048,temperature:.7,stream:!0,...r&&r.length>0?{tools:r,tool_choice:"auto"}:{}})});if(!e.ok){console.error("OpenAI API error:",await e.text()),l.enqueue(s.encode(`data: ${JSON.stringify({error:"API error"})}

`));break}let t=e.body?.getReader();if(!t)break;let f=new TextDecoder,y="",h=[],g="";for(;;){let{done:e,value:n}=await t.read();if(e)break;let r=(y+=f.decode(n,{stream:!0})).split("\n");for(let e of(y=r.pop()||"",r))if(e.startsWith("data: ")){let t=e.slice(6);if("[DONE]"===t)continue;try{let e=JSON.parse(t),n=e.choices?.[0]?.delta,r=e.choices?.[0]?.finish_reason;if(n?.content&&(g+=n.content,c+=n.content,l.enqueue(s.encode(`data: ${JSON.stringify({content:n.content})}

`))),n?.tool_calls)for(let e of n.tool_calls)void 0!==e.index&&(h[e.index]||(h[e.index]={id:"",name:"",arguments:""}),e.id&&(h[e.index].id=e.id),e.function?.name&&(h[e.index].name=e.function.name),e.function?.arguments&&(h[e.index].arguments+=e.function.arguments));if("tool_calls"===r&&h.length>0){let e=h.map(e=>({name:e.name,arguments:e.arguments})),{permitted:t,denied:n}=filterToolCalls(e,a);for(let e of n)l.enqueue(s.encode(`data: ${JSON.stringify({toolDenied:{name:e.name,reason:"Access denied for your role"}})}

`));let r=[];for(let e of h)if(t.some(t=>t.name===e.name)){l.enqueue(s.encode(`data: ${JSON.stringify({toolCall:{id:e.id,name:e.name,status:"executing"}})}

`));try{let t=JSON.parse(e.arguments||"{}"),n={name:e.name,arguments:t},i=await (0,x.executeTool)(n,{userId:o,accessLevel:a});d.push(e.name),r.push({tool_call_id:e.id,role:"tool",content:JSON.stringify(i)}),l.enqueue(s.encode(`data: ${JSON.stringify({toolResult:{id:e.id,name:e.name,result:i}})}

`))}catch(n){let t=n instanceof Error?n.message:"Tool execution failed";r.push({tool_call_id:e.id,role:"tool",content:JSON.stringify({error:t})}),l.enqueue(s.encode(`data: ${JSON.stringify({toolError:{id:e.id,name:e.name,error:t}})}

`))}}for(let e of(u.push({role:"assistant",content:g||null,tool_calls:h.map(e=>({id:e.id,type:"function",function:{name:e.name,arguments:e.arguments}}))}),r))u.push(e);h=[],g=""}else"stop"===r&&("owner"===a&&o&&c&&E(o,i,c,d),p=!1)}catch{}}}}l.enqueue(s.encode("data: [DONE]\n\n")),l.close()}}),{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}})}async function q(e,t,n,r,a,o,i,s){let l=new TextEncoder,c=a?.map(e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters}));return new Response(new ReadableStream({async start(a){let d="",u=[],p=e.map(e=>({role:"user"===e.role?"user":"assistant",content:e.content})),m=!0,f=0;for(;m&&f<10;){f++;let e=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":n,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:"opus"===r?"claude-3-opus-20240229":"claude-3-5-sonnet-20241022",max_tokens:2048,system:t,messages:p,stream:!0,...c&&c.length>0?{tools:c}:{}})});if(!e.ok){console.error("Anthropic API error:",await e.text()),a.enqueue(l.encode(`data: ${JSON.stringify({error:"API error"})}

`));break}let y=e.body?.getReader();if(!y)break;let h=new TextDecoder,g="",w=null,R=[],S=!1,v="";for(;;){let{done:e,value:t}=await y.read();if(e)break;let n=(g+=h.decode(t,{stream:!0})).split("\n");for(let e of(g=n.pop()||"",n))if(e.startsWith("data: ")){let t=e.slice(6);if("[DONE]"===t)continue;try{let e=JSON.parse(t);if("content_block_delta"===e.type&&(e.delta?.type==="text_delta"&&e.delta?.text?(v+=e.delta.text,d+=e.delta.text,a.enqueue(l.encode(`data: ${JSON.stringify({content:e.delta.text})}

`))):e.delta?.type==="input_json_delta"&&w&&(w.input+=e.delta.partial_json||"")),"content_block_start"===e.type&&e.content_block?.type==="tool_use"&&(w={id:e.content_block.id,name:e.content_block.name,input:""},S=!0),"content_block_stop"===e.type&&w){let{permitted:e,denied:t}=filterToolCalls([{name:w.name,arguments:w.input}],o);if(t.length>0)a.enqueue(l.encode(`data: ${JSON.stringify({toolDenied:{name:w.name,reason:"Access denied"}})}

`)),R.push({type:"tool_result",tool_use_id:w.id,content:JSON.stringify({error:"Access denied"})});else{a.enqueue(l.encode(`data: ${JSON.stringify({toolCall:{id:w.id,name:w.name,status:"executing"}})}

`));try{let e=JSON.parse(w.input||"{}"),t={name:w.name,arguments:e},n=await (0,x.executeTool)(t,{userId:i,accessLevel:o});u.push(w.name),R.push({type:"tool_result",tool_use_id:w.id,content:JSON.stringify(n)}),a.enqueue(l.encode(`data: ${JSON.stringify({toolResult:{id:w.id,name:w.name,result:n}})}

`))}catch(t){let e=t instanceof Error?t.message:"Tool execution failed";R.push({type:"tool_result",tool_use_id:w.id,content:JSON.stringify({error:e})}),a.enqueue(l.encode(`data: ${JSON.stringify({toolError:{id:w.id,name:w.name,error:e}})}

`))}}w=null}"message_stop"===e.type&&(S&&R.length>0?(p.push({role:"assistant",content:[...v?[{type:"text",text:v}]:[]]}),p.push({role:"user",content:R}),R=[],S=!1,v=""):("owner"===o&&i&&d&&E(i,s,d,u),m=!1))}catch{}}}}a.enqueue(l.encode("data: [DONE]\n\n")),a.close()}}),{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}})}e.s(["POST",()=>A,"dynamic",0,"force-dynamic","maxDuration",0,30,"runtime",0,"nodejs"],355417);var I=e.i(355417);let J=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/chat/stream/route",pathname:"/api/chat/stream",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/chat/stream/route.ts",nextConfigOutput:"",userland:I}),{workAsyncStorage:M,workUnitAsyncStorage:$,serverHooks:D}=J;function L(){return(0,r.patchFetch)({workAsyncStorage:M,workUnitAsyncStorage:$})}async function U(e,t,r){J.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/chat/stream/route";w=w.replace(/\/index$/,"")||"/";let R=await J.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:S,params:x,nextConfig:v,parsedUrl:O,isDraftMode:_,prerenderManifest:N,routerServerContext:C,isOnDemandRevalidate:E,revalidateOnlyGenerated:k,resolvedPathname:T,clientReferenceManifest:A,serverActionsManifest:b}=R,P=(0,s.normalizeAppPath)(w),q=!!(N.dynamicRoutes[P]||N.routes[T]),I=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,O,!1):t.end("This page could not be found"),null);if(q&&!_){let e=!!N.routes[T],t=N.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await I();throw new h.NoFallbackError}}let M=null;!q||J.isDev||_||(M="/index"===(M=T)?"/":M);let $=!0===J.isDev||!q,D=q&&!$;b&&A&&(0,i.setManifestsSingleton)({page:w,clientReferenceManifest:A,serverActionsManifest:b});let L=e.method||"GET",U=(0,o.getTracer)(),H=U.getActiveScopeSpan(),j={params:x,prerenderManifest:N,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:$,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,r,a)=>J.onRequestError(e,t,r,a,C)},sharedContext:{buildId:S}},K=new l.NodeNextRequest(e),F=new l.NodeNextResponse(t),B=c.NextRequestAdapter.fromNodeNextRequest(K,(0,c.signalFromNodeResponse)(t));try{let i=async e=>J.handle(B,j).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=U.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=n.get("next.route");if(r){let t=`${L} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${L} ${w}`)}),s=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var o,l;let c=async({previousCacheEntry:n})=>{try{if(!s&&E&&k&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await i(a);e.fetchMetrics=j.renderOpts.fetchMetrics;let l=j.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let c=j.renderOpts.collectedTags;if(!q)return await (0,p.sendResponse)(K,F,o,j.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(o.headers);c&&(t[y.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==j.renderOpts.collectedRevalidate&&!(j.renderOpts.collectedRevalidate>=y.INFINITE_CACHE)&&j.renderOpts.collectedRevalidate,r=void 0===j.renderOpts.collectedExpire||j.renderOpts.collectedExpire>=y.INFINITE_CACHE?void 0:j.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:r}}}}catch(t){throw(null==n?void 0:n.isStale)&&await J.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:E})},!1,C),t}},d=await J.handleResponse({req:e,nextConfig:v,cacheKey:M,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:E,revalidateOnlyGenerated:k,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:s});if(!q)return null;if((null==d||null==(o=d.value)?void 0:o.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",E?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),_&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let h=(0,m.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&q||h.delete(y.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||h.get("Cache-Control")||h.set("Cache-Control",(0,f.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(K,F,new Response(d.value.body,{headers:h,status:d.value.status||200})),null};H?await l(H):await U.withPropagatedContext(e.headers,()=>U.trace(d.BaseServerSpan.handleRequest,{spanName:`${L} ${w}`,kind:o.SpanKind.SERVER,attributes:{"http.method":L,"http.target":e.url}},l))}catch(t){if(t instanceof h.NoFallbackError||await J.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:E})},!1,C),q)throw t;return await (0,p.sendResponse)(K,F,new Response(null,{status:500})),null}}e.s(["handler",()=>U,"patchFetch",()=>L,"routeModule",()=>J,"serverHooks",()=>D,"workAsyncStorage",()=>M,"workUnitAsyncStorage",()=>$],449650)}];

//# sourceMappingURL=5d253_next_dist_esm_build_templates_app-route_f64596a7.js.map