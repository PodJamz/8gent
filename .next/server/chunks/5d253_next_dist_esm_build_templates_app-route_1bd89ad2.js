module.exports=[261386,e=>{"use strict";var t=e.i(457375),r=e.i(174015),n=e.i(116384),a=e.i(63831),o=e.i(868001),i=e.i(842780),s=e.i(763077),l=e.i(502964),u=e.i(993216),d=e.i(783900),c=e.i(295731),p=e.i(726839),g=e.i(775778),m=e.i(40992),h=e.i(432128),f=e.i(193695);e.i(44807);var w=e.i(989978),R=e.i(39334),v=e.i(848920),y=e.i(488782),E=e.i(879389);function x(){let e=process.env.TELEGRAM_BOT_TOKEN;if(!e)throw Error("TELEGRAM_BOT_TOKEN not configured");return e}async function T(e,t,r){let n=x();try{let a=await fetch(`https://api.telegram.org/bot${n}/sendMessage`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:e,text:t,reply_to_message_id:r,parse_mode:"Markdown"})});if(!a.ok){let e=await a.text();return console.error("Telegram send error:",e),!1}return!0}catch(e){return console.error("Telegram send failed:",e),!1}}async function _(e){let t=x();try{let r=await fetch(`https://api.telegram.org/bot${t}/getFile?file_id=${e}`);if(!r.ok)return null;let n=await r.json();if(n.ok&&n.result?.file_path)return`https://api.telegram.org/file/bot${t}/${n.result.file_path}`;return null}catch{return null}}async function k(e){let t=process.env.NEXT_PUBLIC_APP_URL||"http://localhost:3000";try{if(!function(e){try{let t=new URL(e);return["api.telegram.org"].some(e=>t.hostname===e||t.hostname.endsWith("."+e))}catch{return!1}}(e))return console.error("Attempted to download audio from unauthorized domain:",e),null;let r=await fetch(e);if(!r.ok)return console.error("Failed to download audio from Telegram"),null;let n=await r.blob(),a=new FormData;a.append("audio",n,"voice.ogg");let o=await fetch(`${t}/api/whisper`,{method:"POST",body:a});if(!o.ok)return console.error("Whisper API error:",await o.text()),null;return(await o.json()).text||null}catch(e){return console.error("Transcription error:",e),null}}async function C(e,t,r){let n=process.env.NEXT_PUBLIC_APP_URL||"http://localhost:3000";try{let a=await fetch(`${n}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:[...r,{role:"user",content:function(e,t=5e3){return e.replace(/ignore previous instructions/gi,"[filtered]").replace(/system prompt/gi,"[filtered]").replace(/\[INST\]/gi,"[filtered]").replace(/<\|im_start\|>/gi,"[filtered]").replace(/\[SYSTEM\]/gi,"[filtered]").replace(/assistant:/gi,"[filtered]").slice(0,t)}(t)}],userId:e,channel:"telegram"})});if(!a.ok){let e=await a.text();return console.error("Claw AI error:",e),"I'm having trouble processing that right now. Please try again."}let o=await a.json();return o.content||o.message||"I couldn't generate a response."}catch(e){return console.error("AI processing error:",e),"Sorry, I encountered an error. Please try again."}}async function N(e,t,r){return(await e.query(y.api.channels.getRecentMessages,{integrationId:t,limit:r})).reverse().map(e=>({role:"inbound"===e.direction?"user":"assistant",content:e.content}))}async function I(e){let t=Date.now(),r=(0,E.getClientIp)(e),n=(0,E.checkRateLimit)(`webhook:telegram:${r}`,{windowMs:6e4,maxRequests:20});if(!n.allowed)return console.warn(`[Telegram] Rate limit exceeded for IP: ${r}`),R.NextResponse.json({error:"Too many requests"},{status:429,headers:{"Retry-After":String(Math.ceil((n.resetAt-Date.now())/1e3)),"X-RateLimit-Limit":"20","X-RateLimit-Remaining":String(n.remaining),"X-RateLimit-Reset":String(Math.floor(n.resetAt/1e3))}});try{let r,n,a=await e.json(),o=function(){let e=process.env.NEXT_PUBLIC_CONVEX_URL;if(!e)throw Error("NEXT_PUBLIC_CONVEX_URL not configured");return new v.ConvexHttpClient(e)}(),i=a.message||a.edited_message;if(!i||!i.from)return R.NextResponse.json({ok:!0,skipped:"no message or sender"});if(i.from.is_bot)return R.NextResponse.json({ok:!0,skipped:"bot message"});let s=String(i.from.id);i.from.username||(i.from.first_name,i.from.last_name&&i.from.last_name);let l=await o.query(y.api.channels.getIntegrationByPlatformUser,{platform:"telegram",platformUserId:s});if(!l)return console.log(`No integration found for Telegram user: ${s}`),await T(i.chat.id,"Hi! I'm Claw AI. To chat with me, please connect your Telegram account at openclaw.io/settings/channels"),R.NextResponse.json({ok:!0,skipped:"no integration"});if(!l.settings.enabled)return R.NextResponse.json({ok:!0,skipped:"integration disabled"});if(void 0!==l.settings.quietHoursStart&&void 0!==l.settings.quietHoursEnd){let e=new Date().getHours(),{quietHoursStart:t,quietHoursEnd:r}=l.settings;if(t<r){if(e>=t||e<r)return R.NextResponse.json({ok:!0,skipped:"quiet hours"})}else if(e>=t&&e<r)return R.NextResponse.json({ok:!0,skipped:"quiet hours"})}let u=i.text||i.caption||"",d="text";if(i.voice&&(d="voice",u=(r=await _(i.voice.file_id)||void 0)?(n=await k(r)||void 0)?n:"[Voice message - transcription failed]":"[Voice message - could not retrieve audio]"),i.photo&&i.photo.length>0){d="image";let e=i.photo[i.photo.length-1];r=await _(e.file_id)||void 0,u||(u="[Image received]")}if(i.document&&(d="document",r=await _(i.document.file_id)||void 0,u||(u=`[Document: ${i.document.file_name||"unnamed"}]`)),!u)return R.NextResponse.json({ok:!0,skipped:"no content"});if(l.settings.commandPrefix){if(u.startsWith(l.settings.commandPrefix))u=u.slice(l.settings.commandPrefix.length).trim();else if(!l.settings.autoReply)return R.NextResponse.json({ok:!0,skipped:"no command prefix"})}let{messageId:c}=await o.mutation(y.api.channels.logInboundMessage,{integrationId:l.integrationId,userId:l.userId,platform:"telegram",platformMessageId:String(i.message_id),messageType:d,content:u,mediaUrl:r,transcription:n,platformTimestamp:1e3*i.date});await o.mutation(y.api.channels.updateMessageStatus,{messageId:c,status:"processing"});let p=await N(o,l.integrationId,l.settings.contextLimit),g=await C(l.userId,u,p),m=Date.now()-t;await o.mutation(y.api.channels.updateMessageStatus,{messageId:c,status:"responded",aiResponse:g,processingTimeMs:m});let h=await T(i.chat.id,g,i.message_id);return await o.mutation(y.api.channels.logOutboundMessage,{integrationId:l.integrationId,userId:l.userId,platform:"telegram",messageType:"text",content:g,processingTimeMs:m}),R.NextResponse.json({ok:!0,sent:h,processingTimeMs:m})}catch(e){return console.error("Telegram webhook error:",e),R.NextResponse.json({ok:!1,error:e instanceof Error?e.message:"Webhook processing failed"},{status:500})}}async function b(){return R.NextResponse.json({status:"ok",webhook:"telegram",timestamp:new Date().toISOString()})}e.s(["GET",()=>b,"POST",()=>I],469632);var P=e.i(469632);let A=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/webhooks/telegram/route",pathname:"/api/webhooks/telegram",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/webhooks/telegram/route.ts",nextConfigOutput:"",userland:P}),{workAsyncStorage:S,workUnitAsyncStorage:O,serverHooks:M}=A;function U(){return(0,n.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:O})}async function j(e,t,n){A.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/webhooks/telegram/route";R=R.replace(/\/index$/,"")||"/";let v=await A.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:y,params:E,nextConfig:x,parsedUrl:T,isDraftMode:_,prerenderManifest:k,routerServerContext:C,isOnDemandRevalidate:N,revalidateOnlyGenerated:I,resolvedPathname:b,clientReferenceManifest:P,serverActionsManifest:S}=v,O=(0,s.normalizeAppPath)(R),M=!!(k.dynamicRoutes[O]||k.routes[b]),U=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,T,!1):t.end("This page could not be found"),null);if(M&&!_){let e=!!k.routes[b],t=k.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await U();throw new f.NoFallbackError}}let j=null;!M||A.isDev||_||(j="/index"===(j=b)?"/":j);let q=!0===A.isDev||!M,H=M&&!q;S&&P&&(0,i.setManifestsSingleton)({page:R,clientReferenceManifest:P,serverActionsManifest:S});let L=e.method||"GET",D=(0,o.getTracer)(),$=D.getActiveScopeSpan(),B={params:E,prerenderManifest:k,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n,a)=>A.onRequestError(e,t,n,a,C)},sharedContext:{buildId:y}},X=new l.NodeNextRequest(e),F=new l.NodeNextResponse(t),K=u.NextRequestAdapter.fromNodeNextRequest(X,(0,u.signalFromNodeResponse)(t));try{let i=async e=>A.handle(K,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=D.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${L} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${L} ${R}`)}),s=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var o,l;let u=async({previousCacheEntry:r})=>{try{if(!s&&N&&I&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await i(a);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let u=B.renderOpts.collectedTags;if(!M)return await (0,p.sendResponse)(X,F,o,B.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(o.headers);u&&(t[h.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,n=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:N})},!1,C),t}},d=await A.handleResponse({req:e,nextConfig:x,cacheKey:j,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:k,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:I,responseGenerator:u,waitUntil:n.waitUntil,isMinimalMode:s});if(!M)return null;if((null==d||null==(o=d.value)?void 0:o.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",N?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),_&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let f=(0,g.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&M||f.delete(h.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||f.get("Cache-Control")||f.set("Cache-Control",(0,m.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(X,F,new Response(d.value.body,{headers:f,status:d.value.status||200})),null};$?await l($):await D.withPropagatedContext(e.headers,()=>D.trace(d.BaseServerSpan.handleRequest,{spanName:`${L} ${R}`,kind:o.SpanKind.SERVER,attributes:{"http.method":L,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:N})},!1,C),M)throw t;return await (0,p.sendResponse)(X,F,new Response(null,{status:500})),null}}e.s(["handler",()=>j,"patchFetch",()=>U,"routeModule",()=>A,"serverHooks",()=>M,"workAsyncStorage",()=>S,"workUnitAsyncStorage",()=>O],261386)}];

//# sourceMappingURL=5d253_next_dist_esm_build_templates_app-route_1bd89ad2.js.map