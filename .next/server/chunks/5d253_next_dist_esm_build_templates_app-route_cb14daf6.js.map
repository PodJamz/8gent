{"version":3,"sources":["../../../node_modules/.pnpm/next%4016.1.2_%40babel%2Bcore%407.29.0_%40opentelemetry%2Bapi%401.9.0_react-dom%4019.2.3_react%4019.2.3__react%4019.2.3/node_modules/next/dist/esm/build/templates/app-route.js","../../../src/app/api/chat/route.ts","../../../src/lib/claw-ai/soul-layers.ts"],"sourcesContent":["import { AppRouteRouteModule } from \"next/dist/esm/server/route-modules/app-route/module.compiled\";\nimport { RouteKind } from \"next/dist/esm/server/route-kind\";\nimport { patchFetch as _patchFetch } from \"next/dist/esm/server/lib/patch-fetch\";\nimport { addRequestMeta, getRequestMeta } from \"next/dist/esm/server/request-meta\";\nimport { getTracer, SpanKind } from \"next/dist/esm/server/lib/trace/tracer\";\nimport { setManifestsSingleton } from \"next/dist/esm/server/app-render/manifests-singleton\";\nimport { normalizeAppPath } from \"next/dist/esm/shared/lib/router/utils/app-paths\";\nimport { NodeNextRequest, NodeNextResponse } from \"next/dist/esm/server/base-http/node\";\nimport { NextRequestAdapter, signalFromNodeResponse } from \"next/dist/esm/server/web/spec-extension/adapters/next-request\";\nimport { BaseServerSpan } from \"next/dist/esm/server/lib/trace/constants\";\nimport { getRevalidateReason } from \"next/dist/esm/server/instrumentation/utils\";\nimport { sendResponse } from \"next/dist/esm/server/send-response\";\nimport { fromNodeOutgoingHttpHeaders, toNodeOutgoingHttpHeaders } from \"next/dist/esm/server/web/utils\";\nimport { getCacheControlHeader } from \"next/dist/esm/server/lib/cache-control\";\nimport { INFINITE_CACHE, NEXT_CACHE_TAGS_HEADER } from \"next/dist/esm/lib/constants\";\nimport { NoFallbackError } from \"next/dist/esm/shared/lib/no-fallback-error.external\";\nimport { CachedRouteKind } from \"next/dist/esm/server/response-cache\";\nimport * as userland from \"INNER_APP_ROUTE\";\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new AppRouteRouteModule({\n    definition: {\n        kind: RouteKind.APP_ROUTE,\n        page: \"/api/chat/route\",\n        pathname: \"/api/chat\",\n        filename: \"route\",\n        bundlePath: \"\"\n    },\n    distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n    relativeProjectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n    resolvedPagePath: \"[project]/src/app/api/chat/route.ts\",\n    nextConfigOutput,\n    userland\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { workAsyncStorage, workUnitAsyncStorage, serverHooks } = routeModule;\nfunction patchFetch() {\n    return _patchFetch({\n        workAsyncStorage,\n        workUnitAsyncStorage\n    });\n}\nexport { routeModule, workAsyncStorage, workUnitAsyncStorage, serverHooks, patchFetch,  };\nexport async function handler(req, res, ctx) {\n    if (routeModule.isDev) {\n        addRequestMeta(req, 'devRequestTimingInternalsEnd', process.hrtime.bigint());\n    }\n    let srcPage = \"/api/chat/route\";\n    // turbopack doesn't normalize `/index` in the page name\n    // so we need to to process dynamic routes properly\n    // TODO: fix turbopack providing differing value from webpack\n    if (process.env.TURBOPACK) {\n        srcPage = srcPage.replace(/\\/index$/, '') || '/';\n    } else if (srcPage === '/index') {\n        // we always normalize /index specifically\n        srcPage = '/';\n    }\n    const multiZoneDraftMode = process.env.__NEXT_MULTI_ZONE_DRAFT_MODE;\n    const prepareResult = await routeModule.prepare(req, res, {\n        srcPage,\n        multiZoneDraftMode\n    });\n    if (!prepareResult) {\n        res.statusCode = 400;\n        res.end('Bad Request');\n        ctx.waitUntil == null ? void 0 : ctx.waitUntil.call(ctx, Promise.resolve());\n        return null;\n    }\n    const { buildId, params, nextConfig, parsedUrl, isDraftMode, prerenderManifest, routerServerContext, isOnDemandRevalidate, revalidateOnlyGenerated, resolvedPathname, clientReferenceManifest, serverActionsManifest } = prepareResult;\n    const normalizedSrcPage = normalizeAppPath(srcPage);\n    let isIsr = Boolean(prerenderManifest.dynamicRoutes[normalizedSrcPage] || prerenderManifest.routes[resolvedPathname]);\n    const render404 = async ()=>{\n        // TODO: should route-module itself handle rendering the 404\n        if (routerServerContext == null ? void 0 : routerServerContext.render404) {\n            await routerServerContext.render404(req, res, parsedUrl, false);\n        } else {\n            res.end('This page could not be found');\n        }\n        return null;\n    };\n    if (isIsr && !isDraftMode) {\n        const isPrerendered = Boolean(prerenderManifest.routes[resolvedPathname]);\n        const prerenderInfo = prerenderManifest.dynamicRoutes[normalizedSrcPage];\n        if (prerenderInfo) {\n            if (prerenderInfo.fallback === false && !isPrerendered) {\n                if (nextConfig.experimental.adapterPath) {\n                    return await render404();\n                }\n                throw new NoFallbackError();\n            }\n        }\n    }\n    let cacheKey = null;\n    if (isIsr && !routeModule.isDev && !isDraftMode) {\n        cacheKey = resolvedPathname;\n        // ensure /index and / is normalized to one key\n        cacheKey = cacheKey === '/index' ? '/' : cacheKey;\n    }\n    const supportsDynamicResponse = // If we're in development, we always support dynamic HTML\n    routeModule.isDev === true || // If this is not SSG or does not have static paths, then it supports\n    // dynamic HTML.\n    !isIsr;\n    // This is a revalidation request if the request is for a static\n    // page and it is not being resumed from a postponed render and\n    // it is not a dynamic RSC request then it is a revalidation\n    // request.\n    const isStaticGeneration = isIsr && !supportsDynamicResponse;\n    // Before rendering (which initializes component tree modules), we have to\n    // set the reference manifests to our global store so Server Action's\n    // encryption util can access to them at the top level of the page module.\n    if (serverActionsManifest && clientReferenceManifest) {\n        setManifestsSingleton({\n            page: srcPage,\n            clientReferenceManifest,\n            serverActionsManifest\n        });\n    }\n    const method = req.method || 'GET';\n    const tracer = getTracer();\n    const activeSpan = tracer.getActiveScopeSpan();\n    const context = {\n        params,\n        prerenderManifest,\n        renderOpts: {\n            experimental: {\n                authInterrupts: Boolean(nextConfig.experimental.authInterrupts)\n            },\n            cacheComponents: Boolean(nextConfig.cacheComponents),\n            supportsDynamicResponse,\n            incrementalCache: getRequestMeta(req, 'incrementalCache'),\n            cacheLifeProfiles: nextConfig.cacheLife,\n            waitUntil: ctx.waitUntil,\n            onClose: (cb)=>{\n                res.on('close', cb);\n            },\n            onAfterTaskError: undefined,\n            onInstrumentationRequestError: (error, _request, errorContext, silenceLog)=>routeModule.onRequestError(req, error, errorContext, silenceLog, routerServerContext)\n        },\n        sharedContext: {\n            buildId\n        }\n    };\n    const nodeNextReq = new NodeNextRequest(req);\n    const nodeNextRes = new NodeNextResponse(res);\n    const nextReq = NextRequestAdapter.fromNodeNextRequest(nodeNextReq, signalFromNodeResponse(res));\n    try {\n        const invokeRouteModule = async (span)=>{\n            return routeModule.handle(nextReq, context).finally(()=>{\n                if (!span) return;\n                span.setAttributes({\n                    'http.status_code': res.statusCode,\n                    'next.rsc': false\n                });\n                const rootSpanAttributes = tracer.getRootSpanAttributes();\n                // We were unable to get attributes, probably OTEL is not enabled\n                if (!rootSpanAttributes) {\n                    return;\n                }\n                if (rootSpanAttributes.get('next.span_type') !== BaseServerSpan.handleRequest) {\n                    console.warn(`Unexpected root span type '${rootSpanAttributes.get('next.span_type')}'. Please report this Next.js issue https://github.com/vercel/next.js`);\n                    return;\n                }\n                const route = rootSpanAttributes.get('next.route');\n                if (route) {\n                    const name = `${method} ${route}`;\n                    span.setAttributes({\n                        'next.route': route,\n                        'http.route': route,\n                        'next.span_name': name\n                    });\n                    span.updateName(name);\n                } else {\n                    span.updateName(`${method} ${srcPage}`);\n                }\n            });\n        };\n        const isMinimalMode = Boolean(process.env.MINIMAL_MODE || getRequestMeta(req, 'minimalMode'));\n        const handleResponse = async (currentSpan)=>{\n            var _cacheEntry_value;\n            const responseGenerator = async ({ previousCacheEntry })=>{\n                try {\n                    if (!isMinimalMode && isOnDemandRevalidate && revalidateOnlyGenerated && !previousCacheEntry) {\n                        res.statusCode = 404;\n                        // on-demand revalidate always sets this header\n                        res.setHeader('x-nextjs-cache', 'REVALIDATED');\n                        res.end('This page could not be found');\n                        return null;\n                    }\n                    const response = await invokeRouteModule(currentSpan);\n                    req.fetchMetrics = context.renderOpts.fetchMetrics;\n                    let pendingWaitUntil = context.renderOpts.pendingWaitUntil;\n                    // Attempt using provided waitUntil if available\n                    // if it's not we fallback to sendResponse's handling\n                    if (pendingWaitUntil) {\n                        if (ctx.waitUntil) {\n                            ctx.waitUntil(pendingWaitUntil);\n                            pendingWaitUntil = undefined;\n                        }\n                    }\n                    const cacheTags = context.renderOpts.collectedTags;\n                    // If the request is for a static response, we can cache it so long\n                    // as it's not edge.\n                    if (isIsr) {\n                        const blob = await response.blob();\n                        // Copy the headers from the response.\n                        const headers = toNodeOutgoingHttpHeaders(response.headers);\n                        if (cacheTags) {\n                            headers[NEXT_CACHE_TAGS_HEADER] = cacheTags;\n                        }\n                        if (!headers['content-type'] && blob.type) {\n                            headers['content-type'] = blob.type;\n                        }\n                        const revalidate = typeof context.renderOpts.collectedRevalidate === 'undefined' || context.renderOpts.collectedRevalidate >= INFINITE_CACHE ? false : context.renderOpts.collectedRevalidate;\n                        const expire = typeof context.renderOpts.collectedExpire === 'undefined' || context.renderOpts.collectedExpire >= INFINITE_CACHE ? undefined : context.renderOpts.collectedExpire;\n                        // Create the cache entry for the response.\n                        const cacheEntry = {\n                            value: {\n                                kind: CachedRouteKind.APP_ROUTE,\n                                status: response.status,\n                                body: Buffer.from(await blob.arrayBuffer()),\n                                headers\n                            },\n                            cacheControl: {\n                                revalidate,\n                                expire\n                            }\n                        };\n                        return cacheEntry;\n                    } else {\n                        // send response without caching if not ISR\n                        await sendResponse(nodeNextReq, nodeNextRes, response, context.renderOpts.pendingWaitUntil);\n                        return null;\n                    }\n                } catch (err) {\n                    // if this is a background revalidate we need to report\n                    // the request error here as it won't be bubbled\n                    if (previousCacheEntry == null ? void 0 : previousCacheEntry.isStale) {\n                        const silenceLog = false;\n                        await routeModule.onRequestError(req, err, {\n                            routerKind: 'App Router',\n                            routePath: srcPage,\n                            routeType: 'route',\n                            revalidateReason: getRevalidateReason({\n                                isStaticGeneration,\n                                isOnDemandRevalidate\n                            })\n                        }, silenceLog, routerServerContext);\n                    }\n                    throw err;\n                }\n            };\n            const cacheEntry = await routeModule.handleResponse({\n                req,\n                nextConfig,\n                cacheKey,\n                routeKind: RouteKind.APP_ROUTE,\n                isFallback: false,\n                prerenderManifest,\n                isRoutePPREnabled: false,\n                isOnDemandRevalidate,\n                revalidateOnlyGenerated,\n                responseGenerator,\n                waitUntil: ctx.waitUntil,\n                isMinimalMode\n            });\n            // we don't create a cacheEntry for ISR\n            if (!isIsr) {\n                return null;\n            }\n            if ((cacheEntry == null ? void 0 : (_cacheEntry_value = cacheEntry.value) == null ? void 0 : _cacheEntry_value.kind) !== CachedRouteKind.APP_ROUTE) {\n                var _cacheEntry_value1;\n                throw Object.defineProperty(new Error(`Invariant: app-route received invalid cache entry ${cacheEntry == null ? void 0 : (_cacheEntry_value1 = cacheEntry.value) == null ? void 0 : _cacheEntry_value1.kind}`), \"__NEXT_ERROR_CODE\", {\n                    value: \"E701\",\n                    enumerable: false,\n                    configurable: true\n                });\n            }\n            if (!isMinimalMode) {\n                res.setHeader('x-nextjs-cache', isOnDemandRevalidate ? 'REVALIDATED' : cacheEntry.isMiss ? 'MISS' : cacheEntry.isStale ? 'STALE' : 'HIT');\n            }\n            // Draft mode should never be cached\n            if (isDraftMode) {\n                res.setHeader('Cache-Control', 'private, no-cache, no-store, max-age=0, must-revalidate');\n            }\n            const headers = fromNodeOutgoingHttpHeaders(cacheEntry.value.headers);\n            if (!(isMinimalMode && isIsr)) {\n                headers.delete(NEXT_CACHE_TAGS_HEADER);\n            }\n            // If cache control is already set on the response we don't\n            // override it to allow users to customize it via next.config\n            if (cacheEntry.cacheControl && !res.getHeader('Cache-Control') && !headers.get('Cache-Control')) {\n                headers.set('Cache-Control', getCacheControlHeader(cacheEntry.cacheControl));\n            }\n            await sendResponse(nodeNextReq, nodeNextRes, // @ts-expect-error - Argument of type 'Buffer<ArrayBufferLike>' is not assignable to parameter of type 'BodyInit | null | undefined'.\n            new Response(cacheEntry.value.body, {\n                headers,\n                status: cacheEntry.value.status || 200\n            }));\n            return null;\n        };\n        // TODO: activeSpan code path is for when wrapped by\n        // next-server can be removed when this is no longer used\n        if (activeSpan) {\n            await handleResponse(activeSpan);\n        } else {\n            await tracer.withPropagatedContext(req.headers, ()=>tracer.trace(BaseServerSpan.handleRequest, {\n                    spanName: `${method} ${srcPage}`,\n                    kind: SpanKind.SERVER,\n                    attributes: {\n                        'http.method': method,\n                        'http.target': req.url\n                    }\n                }, handleResponse));\n        }\n    } catch (err) {\n        if (!(err instanceof NoFallbackError)) {\n            const silenceLog = false;\n            await routeModule.onRequestError(req, err, {\n                routerKind: 'App Router',\n                routePath: normalizedSrcPage,\n                routeType: 'route',\n                revalidateReason: getRevalidateReason({\n                    isStaticGeneration,\n                    isOnDemandRevalidate\n                })\n            }, silenceLog, routerServerContext);\n        }\n        // rethrow so that we can handle serving error page\n        // If this is during static generation, throw the error again.\n        if (isIsr) throw err;\n        // Otherwise, send a 500 response.\n        await sendResponse(nodeNextReq, nodeNextRes, new Response(null, {\n            status: 500\n        }));\n        return null;\n    }\n}\n\n//# sourceMappingURL=app-route.js.map\n","import { NextRequest, NextResponse } from 'next/server';\nimport { cookies } from 'next/headers';\nimport { assembleSoulPrompt, getLoadedLayers } from '@/lib/claw-ai/soul-layers';\nimport { parseToolCalls, ToolCall, toOpenAITools } from '@/lib/claw-ai/tools';\nimport { executeTool, formatToolResults } from '@/lib/claw-ai/tool-executor';\nimport { MemoryManager } from '@/lib/memory';\nimport { verifySession, ADMIN_COOKIE } from '@/lib/passcodeAuth';\nimport { checkRateLimit, getClientIp } from '@/lib/security';\nimport {\n  AccessLevel,\n  getToolsForAccessLevel,\n  filterToolCalls,\n  describeAccessLevel,\n} from '@/lib/claw-ai/access-control';\nimport { OllamaClient, type OllamaChatRequest, type OllamaMessage } from '@/lib/ollama';\nimport { getLynkrClient, type LynkrMessage } from '@/lib/lynkr';\nimport { auth } from '@/lib/openclaw/auth-server';\n\n// Rate limits: authenticated users get higher limits\nconst PUBLIC_RATE_LIMIT = { windowMs: 60 * 1000, maxRequests: 10 };\nconst AUTH_RATE_LIMIT = { windowMs: 60 * 1000, maxRequests: 60 };\n\n// Local LLM timeout (30 seconds) before fallback to cloud\nconst LOCAL_LLM_TIMEOUT = 30000;\n\ninterface ChatMessage {\n  role: 'user' | 'assistant' | 'system';\n  content: string;\n}\n\ninterface AIProviderSettings {\n  primaryProvider: 'cloud' | 'local' | 'lynkr';\n  fallbackProvider?: 'cloud' | 'local' | 'lynkr' | 'none';\n  ollamaBaseUrl?: string;\n  ollamaDefaultModel?: string;\n  ollamaTimeout?: number;\n  // Lynkr settings (for local models from anywhere)\n  lynkrEnabled?: boolean;\n  lynkrTunnelUrl?: string;\n  lynkrApiKey?: string;\n  lynkrDefaultModel?: string;\n}\n\ninterface ProviderResult {\n  content: string;\n  provider: 'openai' | 'ollama' | 'lynkr';\n  model: string;\n  fallbackUsed: boolean;\n  fallbackReason?: string;\n}\n\n// User identity is now the AccessLevel type from access-control.ts\n// Owner userId should come from authenticated session, not hardcoded\n\n// Initialize memory manager\nconst memoryManager = new MemoryManager();\n\n/**\n * Determine user identity from session\n * Returns AccessLevel and userId from the actual session\n */\nasync function getUserIdentity(): Promise<{ accessLevel: AccessLevel; userId: string | null }> {\n  try {\n    // First check for Clerk authentication (primary auth)\n    const { userId: clerkUserId } = await auth();\n\n    if (clerkUserId) {\n      // Assume owner for now in OpenClaw OS single-user mode\n      return { accessLevel: 'owner', userId: clerkUserId };\n    }\n\n    // Fallback: Check for legacy admin cookie (passcode auth)\n    const cookieStore = await cookies();\n    const adminToken = cookieStore.get(ADMIN_COOKIE)?.value;\n\n    if (adminToken) {\n      const session = verifySession(adminToken);\n      if (session && session.type === 'admin') {\n        const userId = `admin-${session.subject}`;\n        return { accessLevel: 'owner', userId };\n      }\n    }\n\n    return { accessLevel: 'visitor', userId: null };\n  } catch (e) {\n    console.error('[Auth] Error determining user identity:', e);\n    return { accessLevel: 'visitor', userId: null };\n  }\n}\n\n/**\n * Fetch AI provider settings\n * Only fetches for owner; returns default cloud settings for others\n */\nasync function getAIProviderSettings(accessLevel: AccessLevel): Promise<AIProviderSettings> {\n  // Default to cloud for non-owners\n  if (accessLevel !== 'owner') {\n    return { primaryProvider: 'cloud' };\n  }\n\n  // Use environment variables for default settings in OpenClaw OS\n  return {\n    primaryProvider: 'cloud', // Default to cloud for reliability\n    // Could load from localStorage passed in headers or similar if needed\n  };\n}\n\n/**\n * Call Ollama for local LLM inference\n */\nasync function callOllama(\n  messages: Array<{ role: string; content: string }>,\n  systemPrompt: string,\n  settings: AIProviderSettings\n): Promise<string> {\n  const client = new OllamaClient({\n    baseUrl: settings.ollamaBaseUrl ?? process.env.OLLAMA_BASE_URL ?? 'http://localhost:11434',\n    timeout: settings.ollamaTimeout ?? LOCAL_LLM_TIMEOUT,\n    defaultModel: settings.ollamaDefaultModel ?? process.env.OLLAMA_DEFAULT_MODEL ?? 'gpt-oss:20b',\n  });\n\n  // Convert messages to Ollama format\n  const ollamaMessages: OllamaMessage[] = [\n    { role: 'system', content: systemPrompt },\n    ...messages.map((m) => ({\n      role: m.role as 'system' | 'user' | 'assistant',\n      content: m.content,\n    })),\n  ];\n\n  const response = await client.chat({\n    model: settings.ollamaDefaultModel ?? 'gpt-oss:20b',\n    messages: ollamaMessages,\n  });\n\n  return response.message.content;\n}\n\n/**\n * Call Lynkr for local LLM inference via tunnel (works from anywhere)\n * Uses the Cloudflare tunnel to route to local Ollama\n */\nasync function callLynkr(\n  messages: Array<{ role: string; content: string }>,\n  systemPrompt: string,\n  settings: AIProviderSettings\n): Promise<string> {\n  // Validate Lynkr settings\n  if (!settings.lynkrTunnelUrl) {\n    throw new Error('Lynkr tunnel URL not configured');\n  }\n  if (!settings.lynkrApiKey) {\n    throw new Error('Lynkr API key not configured');\n  }\n\n  console.log(`[Lynkr] Connecting via tunnel: ${settings.lynkrTunnelUrl}`);\n\n  const client = getLynkrClient({\n    baseUrl: settings.lynkrTunnelUrl,\n    apiKey: settings.lynkrApiKey,\n    defaultModel: settings.lynkrDefaultModel ?? 'gpt-oss:20b',\n    timeout: settings.ollamaTimeout ?? LOCAL_LLM_TIMEOUT,\n    // Skip validation for tunnel URLs (they're external)\n    skipSsrfValidation: true,\n  });\n\n  // Convert messages to Lynkr/Anthropic format\n  const lynkrMessages: LynkrMessage[] = messages.map((m) => ({\n    role: m.role as 'user' | 'assistant',\n    content: m.content,\n  }));\n\n  const response = await client.chat({\n    messages: lynkrMessages,\n    system: systemPrompt,\n    model: settings.lynkrDefaultModel ?? 'gpt-oss:20b',\n    max_tokens: 4096,\n    temperature: 0.7,\n  });\n\n  // Extract text content from the response\n  const textContent = response.content.find((c) => c.type === 'text');\n  if (!textContent || textContent.type !== 'text') {\n    throw new Error('Lynkr response did not contain text content');\n  }\n\n  console.log(`[Lynkr] Response received, model: ${response.model}`);\n  return textContent.text;\n}\n\n/**\n * Call OpenAI for cloud LLM inference\n */\nasync function callOpenAI(\n  messages: Array<{ role: string; content: string }>,\n  systemPrompt: string,\n  tools?: unknown[]\n): Promise<{ content: string; toolCalls?: unknown[] }> {\n  const apiKey = process.env.OPENAI_API_KEY;\n  if (!apiKey) {\n    throw new Error('OpenAI API key not configured');\n  }\n\n  const openAIMessages = [\n    { role: 'system' as const, content: systemPrompt },\n    ...messages.map((m) => ({\n      role: m.role === 'user' ? ('user' as const) : ('assistant' as const),\n      content: m.content,\n    })),\n  ];\n\n  const response = await fetch('https://api.openai.com/v1/chat/completions', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      Authorization: `Bearer ${apiKey}`,\n    },\n    body: JSON.stringify({\n      model: 'gpt-4o',\n      messages: openAIMessages,\n      tools: tools && tools.length > 0 ? tools : undefined,\n      tool_choice: tools && tools.length > 0 ? 'auto' : undefined,\n      max_tokens: 1000,\n      temperature: 0.7,\n    }),\n  });\n\n  if (!response.ok) {\n    const error = await response.json();\n    throw new Error(`OpenAI API error: ${JSON.stringify(error)}`);\n  }\n\n  const data = await response.json();\n  const assistantMessage = data.choices[0]?.message;\n\n  return {\n    content: assistantMessage?.content || '',\n    toolCalls: assistantMessage?.tool_calls,\n  };\n}\n\n/**\n * Route to the appropriate AI provider with fallback support\n */\nasync function routeToProvider(\n  messages: Array<{ role: string; content: string }>,\n  systemPrompt: string,\n  settings: AIProviderSettings,\n  tools?: unknown[]\n): Promise<ProviderResult> {\n  console.log('[routeToProvider] Settings received:', {\n    primaryProvider: settings.primaryProvider,\n    lynkrTunnelUrl: settings.lynkrTunnelUrl ? 'SET' : 'NOT SET',\n    lynkrApiKey: settings.lynkrApiKey ? 'SET' : 'NOT SET',\n  });\n\n  // If primary is cloud, use OpenAI directly\n  if (settings.primaryProvider === 'cloud') {\n    try {\n      const result = await callOpenAI(messages, systemPrompt, tools);\n      return {\n        content: result.content,\n        provider: 'openai',\n        model: 'gpt-4o',\n        fallbackUsed: false,\n      };\n    } catch (error) {\n      // Cloud failed with no fallback\n      throw error;\n    }\n  }\n\n  // If primary is lynkr, use Lynkr via tunnel (local models from anywhere)\n  if (settings.primaryProvider === 'lynkr') {\n    try {\n      console.log('[AI Provider] Using Lynkr (local models via tunnel)...');\n      const content = await callLynkr(messages, systemPrompt, settings);\n      return {\n        content,\n        provider: 'lynkr',\n        model: settings.lynkrDefaultModel ?? 'gpt-oss:20b',\n        fallbackUsed: false,\n      };\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n      console.warn('[AI Provider] Lynkr failed:', errorMessage);\n\n      // Check if fallback is explicitly enabled to 'cloud'\n      if (settings.fallbackProvider === 'cloud') {\n        console.log('[AI Provider] Falling back to cloud (OpenAI)...');\n        try {\n          const result = await callOpenAI(messages, systemPrompt, tools);\n          return {\n            content: result.content,\n            provider: 'openai',\n            model: 'gpt-4o',\n            fallbackUsed: true,\n            fallbackReason: `Lynkr failed: ${errorMessage}`,\n          };\n        } catch (fallbackError) {\n          throw new Error(`Both Lynkr and cloud providers failed. Lynkr: ${errorMessage}, Cloud: ${fallbackError}`);\n        }\n      }\n\n      // No fallback enabled - throw the Lynkr error directly\n      throw new Error(`Lynkr failed: ${errorMessage}`);\n    }\n  }\n\n  // Primary is local (Ollama direct connection)\n  try {\n    console.log('[AI Provider] Using local Ollama (direct)...');\n    const content = await callOllama(messages, systemPrompt, settings);\n    return {\n      content,\n      provider: 'ollama',\n      model: settings.ollamaDefaultModel ?? 'gpt-oss:20b',\n      fallbackUsed: false,\n    };\n  } catch (error) {\n    const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n    console.warn('[AI Provider] Ollama failed:', errorMessage);\n\n    // Check if fallback is explicitly enabled to 'cloud'\n    if (settings.fallbackProvider === 'cloud') {\n      console.log('[AI Provider] Falling back to cloud (OpenAI)...');\n      try {\n        const result = await callOpenAI(messages, systemPrompt, tools);\n        return {\n          content: result.content,\n          provider: 'openai',\n          model: 'gpt-4o',\n          fallbackUsed: true,\n          fallbackReason: `Local LLM failed: ${errorMessage}`,\n        };\n      } catch (fallbackError) {\n        throw new Error(`Both local and cloud providers failed. Local: ${errorMessage}, Cloud: ${fallbackError}`);\n      }\n    }\n\n    // No fallback enabled - throw the Ollama error directly\n    throw new Error(`Local LLM failed: ${errorMessage}`);\n  }\n}\n\n/**\n * App context payload type (used by soul-layers.ts for prompt assembly)\n */\ninterface AppContextPayload {\n  appId: string;\n  appName: string;\n  route: string;\n  description: string;\n  contextHints: string[];\n}\n\n// Identity context is now handled by soul-layers.ts\n// Each access tier loads different prompt layers (base / professional / private)\n\ninterface ToolCallResponse {\n  tool_calls?: Array<{\n    id: string;\n    type: 'function';\n    function: {\n      name: string;\n      arguments: string;\n    };\n  }>;\n}\n\n// TPMJS tool definitions for OpenAI function calling\nconst TPMJS_TOOL_DEFINITIONS = [\n  {\n    name: 'search_tpmjs_tools',\n    description: 'Search the TPMJS registry for available tools. Use this to find tools that can help with specific tasks like web scraping, image processing, data transformation, etc.',\n    parameters: {\n      type: 'object' as const,\n      properties: {\n        query: {\n          type: 'string' as const,\n          description: 'Search query to find relevant tools (e.g., \"web scraping\", \"image resize\", \"json transform\")',\n        },\n        category: {\n          type: 'string' as const,\n          description: 'Optional category filter (e.g., \"web-scraping\", \"image-processing\", \"ai-models\")',\n        },\n        limit: {\n          type: 'number' as const,\n          description: 'Maximum number of results to return (default: 10)',\n        },\n      },\n      required: ['query'] as string[],\n    },\n  },\n  {\n    name: 'execute_tpmjs_tool',\n    description: 'Execute a tool from the TPMJS registry. First use search_tpmjs_tools to find the right tool, then execute it with the required parameters.',\n    parameters: {\n      type: 'object' as const,\n      properties: {\n        toolId: {\n          type: 'string' as const,\n          description: 'The tool ID in format \"packageName::toolName\" (e.g., \"web-scraper::fetch_page\")',\n        },\n        params: {\n          type: 'object' as const,\n          description: 'Parameters to pass to the tool (varies by tool)',\n        },\n        env: {\n          type: 'object' as const,\n          description: 'Optional environment variables for the tool execution',\n        },\n      },\n      required: ['toolId', 'params'] as string[],\n    },\n  },\n  {\n    name: 'check_tpmjs_executor',\n    description: 'Check the health and status of the TPMJS executor service. Use this to verify the executor is available before running tools.',\n    parameters: {\n      type: 'object' as const,\n      properties: {} as Record<string, { type: string; description: string }>,\n      required: [] as string[],\n    },\n  },\n];\n\ninterface SelectedTool {\n  name: string;\n  provider: 'legacy' | 'tpmjs';\n}\n\n/**\n * Execute a TPMJS tool by name\n * This bridges the AI function calling to the TPMJS client\n */\nasync function executeTPMJSTool(\n  toolName: string,\n  args: Record<string, unknown>\n): Promise<unknown> {\n  // Dynamic import to avoid loading TPMJS client unless needed\n  const { getTPMJSClient } = await import('@/lib/tpmjs/client');\n  const client = getTPMJSClient();\n\n  switch (toolName) {\n    case 'search_tpmjs_tools': {\n      const result = await client.searchTools(\n        args.query as string,\n        {\n          category: args.category as string | undefined,\n          limit: args.limit as number | undefined,\n        }\n      );\n      return {\n        tools: result.tools.map(t => ({\n          id: t.toolId || `${t.packageName}::${t.toolName}`,\n          name: t.name || t.toolName,\n          description: t.description,\n          category: t.category,\n          qualityScore: t.qualityScore,\n        })),\n        total: result.total,\n      };\n    }\n\n    case 'execute_tpmjs_tool': {\n      const result = await client.executeTool(\n        args.toolId as string,\n        args.params as Record<string, unknown>,\n        args.env as Record<string, string> | undefined\n      );\n      return result;\n    }\n\n    case 'check_tpmjs_executor': {\n      const health = await client.checkExecutorHealth();\n      return health;\n    }\n\n    default:\n      throw new Error(`Unknown TPMJS tool: ${toolName}`);\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const { messages, model, theme, projectId, appContext, channel, accessLevel: requestAccessLevel, enableTools, selectedTools } = await request.json() as {\n      messages: ChatMessage[];\n      model?: string;\n      theme?: string;\n      projectId?: string;\n      appContext?: AppContextPayload;\n      channel?: string;\n      accessLevel?: string;\n      enableTools?: boolean;\n      selectedTools?: SelectedTool[];\n    };\n\n    if (!messages || !Array.isArray(messages)) {\n      return NextResponse.json(\n        { error: 'Messages array is required' },\n        { status: 400 }\n      );\n    }\n\n    // Determine user identity from session\n    let { accessLevel, userId } = await getUserIdentity();\n\n    // Allow channel-specific access level override (e.g., WhatsApp contacts)\n    // Only trust this if it's from a server-side channel integration\n    if (channel === 'whatsapp' && requestAccessLevel) {\n      accessLevel = requestAccessLevel as AccessLevel;\n      console.log(`[Chat API] Using WhatsApp contact access level: ${accessLevel}`);\n    }\n\n    // SECURITY: Rate limiting based on access level\n    const clientIp = getClientIp(request);\n    const rateLimitConfig = accessLevel === 'owner' ? AUTH_RATE_LIMIT : PUBLIC_RATE_LIMIT;\n    const rateLimit = checkRateLimit(`chat:${clientIp}`, rateLimitConfig);\n\n    if (!rateLimit.allowed) {\n      return NextResponse.json(\n        {\n          error: 'Rate limit exceeded. Please wait before making more requests.',\n          retryAfter: Math.ceil((rateLimit.resetAt - Date.now()) / 1000)\n        },\n        {\n          status: 429,\n          headers: {\n            'Retry-After': String(Math.ceil((rateLimit.resetAt - Date.now()) / 1000))\n          }\n        }\n      );\n    }\n\n    // Fetch AI provider settings (owner only; visitors always get cloud)\n    const providerSettings = await getAIProviderSettings(accessLevel);\n\n    // IMPORTANT: Lynkr only works when accessed directly (browser → tunnel → local Mac)\n    // It does NOT work from Vercel serverless (Vercel → tunnel → local Mac is blocked)\n    // So in production (Vercel), we must use cloud even if Lynkr is primary\n    const isVercelProduction = process.env.VERCEL === '1';\n    const lynkrUnavailableInProduction = isVercelProduction && providerSettings.primaryProvider === 'lynkr';\n\n    if (lynkrUnavailableInProduction) {\n      console.log('[AI Provider] Lynkr unavailable from Vercel - using cloud instead');\n    }\n\n    // Determine if we need cloud for tool calling\n    // Hybrid approach: Use local for conversation, cloud only when tools are actually needed\n    const isLocalPreferred = !lynkrUnavailableInProduction &&\n      (providerSettings.primaryProvider === 'local' || providerSettings.primaryProvider === 'lynkr');\n\n    // Keywords that indicate tool usage is likely needed\n    const toolTriggerKeywords = [\n      'generate music', 'create music', 'make music', 'create a song', 'make a track',\n      'cowrite', 'co-write', 'generate_music', 'cowrite_music',\n      'schedule', 'book a meeting', 'calendar',\n      'navigate to', 'go to', 'open',\n      'remember', 'memorize', 'recall',\n      'create project', 'create ticket', 'create prd',\n      'show kanban', 'list projects',\n    ];\n\n    const lastMessage = messages[messages.length - 1]?.content?.toLowerCase() || '';\n    const needsToolSupport = enableTools && toolTriggerKeywords.some(kw => lastMessage.includes(kw));\n\n    // Use local UNLESS tools are explicitly needed\n    const useLocalProvider = isLocalPreferred && !needsToolSupport;\n\n    if (needsToolSupport && isLocalPreferred) {\n      console.log(`[Chat API] Switching to cloud for tool support (trigger detected in: \"${lastMessage.substring(0, 50)}...\")`);\n    }\n\n    // For cloud provider, ensure API key is configured\n    if (!useLocalProvider) {\n      const apiKey = process.env.OPENAI_API_KEY;\n      if (!apiKey) {\n        return NextResponse.json(\n          { error: 'OpenAI API key not configured' },\n          { status: 500 }\n        );\n      }\n    }\n\n    // Get the last user message for memory search\n    const lastUserMessage = messages.filter((m: ChatMessage) => m.role === 'user').pop();\n    const userQuery = lastUserMessage?.content || '';\n\n    // Load relevant memories ONLY for owner\n    let memoryContext = '';\n    if (accessLevel === 'owner' && userId) {\n      try {\n        const memories = await memoryManager.loadRelevantMemories(\n          userId,\n          userQuery,\n          { projectId: projectId as string | undefined, limit: 10 }\n        );\n        if (memories.contextSummary) {\n          memoryContext = `\\n\\n## Memory Context\\n${memories.contextSummary}`;\n        }\n      } catch (error) {\n        console.error('Failed to load memories:', error);\n        // Continue without memory context\n      }\n    }\n\n    // Build TPMJS tools context if any are selected\n    const selectedTpmjsToolNames = selectedTools?.filter(t => t.provider === 'tpmjs').map(t => t.name) || [];\n    const tpmjsContextStr = selectedTpmjsToolNames.length > 0\n      ? `\\n\\n## TPMJS Tools Available\\nThe user has enabled the following TPMJS registry tools for this session:\\n${selectedTpmjsToolNames.map(name => {\n        const def = TPMJS_TOOL_DEFINITIONS.find(t => t.name === name);\n        return def ? `- **${name}**: ${def.description}` : `- ${name}`;\n      }).join('\\n')}\\n\\nYou can use these tools to extend your capabilities. For example, use search_tpmjs_tools to find specialized tools in the registry, then execute_tpmjs_tool to run them.`\n      : '';\n\n    // Build provider context string\n    const providerContextStr = useLocalProvider\n      ? `\\n\\n## Provider Context\\nYou are currently running on LOCAL inference (${providerSettings.primaryProvider === 'lynkr' ? 'Lynkr tunnel to Ollama' : 'Ollama direct'} with ${providerSettings.lynkrDefaultModel ?? providerSettings.ollamaDefaultModel ?? 'gpt-oss:20b'}). This means your responses stay on your machine with zero cloud cost. In local mode, have natural conversations, answer questions, help with ideas. If the user wants to execute an action (generate music, schedule, navigate), encourage them to be specific so you can help - the system will automatically switch to cloud for tool execution when needed.${tpmjsContextStr}`\n      : `\\n\\n## Provider Context\\nYou are running on CLOUD inference (OpenAI GPT-4o). Full tool calling and capabilities are available. Use your tools when appropriate - especially cowrite_music and generate_music for music creation requests.${tpmjsContextStr}`;\n\n    // Assemble soul prompt using three-tier architecture\n    // Visitor → base layer only. Collaborator → base + professional. Owner → all three.\n    // Private context (Nick, 2028 arc, pricing) is never loaded for non-owner tiers.\n    const systemPrompt = assembleSoulPrompt({\n      accessLevel,\n      theme: model || theme,\n      appContext: appContext as AppContextPayload | null,\n      memoryContext: memoryContext || undefined,\n      providerContext: providerContextStr,\n    });\n\n    // Log loaded soul layers for security monitoring\n    const loadedLayers = getLoadedLayers(accessLevel);\n    console.log(`[Soul Layers] Access: ${accessLevel}, Layers: [${loadedLayers.join(', ')}]`);\n\n    // Prepare messages for API call\n    const chatMessages = messages.map((m: ChatMessage) => ({\n      role: m.role,\n      content: m.content,\n    }));\n\n    // SECURITY: Get only the tools this access level can use\n    let allowedTools = getToolsForAccessLevel(accessLevel);\n\n    // If selectedTools is provided, filter legacy tools to only include selected ones\n    // and add TPMJS tools that are selected\n    const selectedLegacyTools = selectedTools?.filter(t => t.provider === 'legacy').map(t => t.name) || [];\n    const selectedTpmjsTools = selectedTools?.filter(t => t.provider === 'tpmjs').map(t => t.name) || [];\n\n    // Filter legacy tools if specific ones are selected (empty array = use all allowed)\n    if (selectedLegacyTools.length > 0) {\n      allowedTools = allowedTools.filter(tool => selectedLegacyTools.includes(tool.name));\n      console.log(`[Tool Selection] Filtered to ${allowedTools.length} legacy tools:`, selectedLegacyTools);\n    }\n\n    // Convert legacy tools to OpenAI format\n    let openAITools = toOpenAITools(allowedTools);\n\n    // Add TPMJS tools if selected\n    if (selectedTpmjsTools.length > 0) {\n      const tpmjsToolsToAdd = selectedTpmjsTools\n        .map(tpmjsTool => {\n          const toolDef = TPMJS_TOOL_DEFINITIONS.find(t => t.name === tpmjsTool);\n          if (!toolDef) return null;\n          return {\n            type: 'function' as const,\n            function: {\n              name: toolDef.name,\n              description: toolDef.description,\n              parameters: toolDef.parameters as {\n                type: 'object';\n                properties: Record<string, { type: string; description: string }>;\n                required: string[];\n              },\n            },\n          };\n        })\n        .filter((t): t is NonNullable<typeof t> => t !== null);\n\n      // Cast to compatible type for merging\n      openAITools = [...openAITools, ...tpmjsToolsToAdd] as typeof openAITools;\n      console.log(`[Tool Selection] Added ${tpmjsToolsToAdd.length} TPMJS tools:`, selectedTpmjsTools);\n    }\n\n    // Log tool access for monitoring (helpful for security audits)\n    const tpmjsToolCount = selectedTpmjsTools.length > 0 ? selectedTpmjsTools.length : 0;\n    console.log(`[Access Control] User (${accessLevel}) has access to ${openAITools.length} tools (${allowedTools.length} legacy + ${tpmjsToolCount} TPMJS)`);\n    console.log(`[AI Provider] Primary: ${providerSettings.primaryProvider}, Using Local: ${useLocalProvider}`);\n\n    // =========================================================================\n    // LOCAL PROVIDER PATH (Ollama) - No tool calling, direct response\n    // =========================================================================\n    if (useLocalProvider) {\n      try {\n        const providerResult = await routeToProvider(\n          chatMessages,\n          systemPrompt,\n          providerSettings\n          // No tools for local - tool calling not supported\n        );\n\n        // Store interaction in memory ONLY for owner (async, non-blocking)\n        if (accessLevel === 'owner' && userId) {\n          memoryManager.processInteraction(\n            userId,\n            { userMessage: userQuery, aiResponse: providerResult.content, toolsUsed: [] },\n            projectId as string | undefined\n          ).catch((err) => console.error('Failed to store memory:', err));\n        }\n\n        return NextResponse.json({\n          content: providerResult.content,\n          message: providerResult.content,\n          model: 'claw-ai',\n          accessLevel,\n          memoryEnabled: accessLevel === 'owner',\n          provider: providerResult.provider,\n          providerModel: providerResult.model,\n          fallbackUsed: providerResult.fallbackUsed,\n          fallbackReason: providerResult.fallbackReason,\n          toolsEnabled: false, // Local mode doesn't support tools\n        });\n      } catch (error) {\n        console.error('[AI Provider] Local inference failed:', error);\n        return NextResponse.json(\n          { error: 'Local AI provider failed. Try switching to cloud in Settings.' },\n          { status: 500 }\n        );\n      }\n    }\n\n    // =========================================================================\n    // CLOUD PROVIDER PATH (OpenAI) - Full tool calling support\n    // =========================================================================\n    const apiKey = process.env.OPENAI_API_KEY!;\n\n    // Prepare messages for OpenAI\n    const openAIMessages = [\n      { role: 'system' as const, content: systemPrompt },\n      ...messages.map((m: ChatMessage) => ({\n        role: m.role === 'user' ? ('user' as const) : ('assistant' as const),\n        content: m.content,\n      })),\n    ];\n\n    // First API call - may include tool calls\n    const response = await fetch('https://api.openai.com/v1/chat/completions', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${apiKey}`,\n      },\n      body: JSON.stringify({\n        model: 'gpt-4o',\n        messages: openAIMessages,\n        tools: openAITools.length > 0 ? openAITools : undefined,\n        tool_choice: openAITools.length > 0 ? 'auto' : undefined,\n        max_tokens: 1000,\n        temperature: 0.7,\n      }),\n    });\n\n    if (!response.ok) {\n      const error = await response.json();\n      console.error('OpenAI API error:', error);\n      return NextResponse.json(\n        { error: 'Failed to get response from OpenAI' },\n        { status: 500 }\n      );\n    }\n\n    const data = await response.json();\n    const assistantMessage = data.choices[0]?.message;\n\n    // Check if the model wants to use tools\n    if (assistantMessage?.tool_calls && assistantMessage.tool_calls.length > 0) {\n      // Parse and execute tool calls\n      const toolCalls = parseToolCalls(assistantMessage.tool_calls);\n\n      // TPMJS tool names (these bypass normal access control since user explicitly enabled them)\n      const tpmjsToolNames = TPMJS_TOOL_DEFINITIONS.map(t => t.name);\n\n      // Separate TPMJS tools from legacy tools for filtering\n      const tpmjsCalls = toolCalls.filter(tc => tpmjsToolNames.includes(tc.name));\n      const legacyCalls = toolCalls.filter(tc => !tpmjsToolNames.includes(tc.name));\n\n      // SECURITY: Filter legacy tool calls by access level (defense in depth)\n      const { permitted: permittedLegacy, denied } = filterToolCalls(legacyCalls, accessLevel);\n\n      // TPMJS tools are permitted if they were selected (user explicitly enabled them)\n      const permittedTpmjs = tpmjsCalls.filter(tc =>\n        selectedTpmjsToolNames.includes(tc.name)\n      );\n      const deniedTpmjs = tpmjsCalls.filter(tc =>\n        !selectedTpmjsToolNames.includes(tc.name)\n      );\n\n      // Combine permitted tools\n      const permitted = [...permittedLegacy, ...permittedTpmjs];\n\n      // Log any denied tool attempts (this shouldn't happen if AI respects its tool list)\n      if (denied.length > 0 || deniedTpmjs.length > 0) {\n        console.warn(`[SECURITY] Denied tool calls for ${accessLevel}:`, [...denied, ...deniedTpmjs].map(t => t.name));\n        // TODO: Log to securityEvents table in Convex for monitoring\n      }\n\n      const toolResults = new Map<string, Awaited<ReturnType<typeof executeTool>>>();\n      const toolActions: Array<{ type: string; payload: Record<string, unknown> }> = [];\n\n      // Only execute permitted tools\n      for (const toolCall of permitted) {\n        // Check if this is a TPMJS tool\n        if (tpmjsToolNames.includes(toolCall.name)) {\n          // Handle TPMJS tool execution\n          try {\n            const tpmjsResult = await executeTPMJSTool(toolCall.name, toolCall.arguments);\n            toolResults.set(toolCall.name, {\n              success: true,\n              data: tpmjsResult,\n            });\n            console.log(`[TPMJS] Executed ${toolCall.name}:`, tpmjsResult);\n          } catch (error) {\n            const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n            toolResults.set(toolCall.name, {\n              success: false,\n              error: `TPMJS tool execution failed: ${errorMessage}`,\n            });\n            console.error(`[TPMJS] Failed to execute ${toolCall.name}:`, error);\n          }\n        } else {\n          // SECURITY: Pass userId to executeTool for proper authorization\n          const result = await executeTool(toolCall, { userId, accessLevel });\n          toolResults.set(toolCall.name, result);\n          if (result.action) {\n            toolActions.push(result.action);\n          }\n        }\n      }\n\n      // Add error results for denied tools (both legacy and TPMJS)\n      for (const toolCall of denied) {\n        toolResults.set(toolCall.name, {\n          success: false,\n          error: `Access denied: Tool '${toolCall.name}' requires higher access level than '${accessLevel}'`,\n        });\n      }\n      for (const toolCall of deniedTpmjs) {\n        toolResults.set(toolCall.name, {\n          success: false,\n          error: `TPMJS tool '${toolCall.name}' was not enabled in the current session`,\n        });\n      }\n\n      // Build tool results messages for second API call\n      const toolResultMessages = assistantMessage.tool_calls.map(\n        (tc: { id: string; function: { name: string } }) => ({\n          role: 'tool' as const,\n          tool_call_id: tc.id,\n          content: JSON.stringify(toolResults.get(tc.function.name)?.data || {}),\n        })\n      );\n\n      // Second API call with tool results\n      const secondResponse = await fetch('https://api.openai.com/v1/chat/completions', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${apiKey}`,\n        },\n        body: JSON.stringify({\n          model: 'gpt-4o',\n          messages: [\n            ...openAIMessages,\n            {\n              role: 'assistant',\n              // IMPORTANT: content can be null when tool_calls are present\n              // OpenAI requires an empty string, not null\n              content: assistantMessage.content || '',\n              tool_calls: assistantMessage.tool_calls,\n            },\n            ...toolResultMessages,\n          ],\n          max_tokens: 1000,\n          temperature: 0.7,\n        }),\n      });\n\n      if (!secondResponse.ok) {\n        const error = await secondResponse.json();\n        console.error('OpenAI API error (second call):', error);\n        return NextResponse.json(\n          { error: 'Failed to get response from OpenAI' },\n          { status: 500 }\n        );\n      }\n\n      const secondData = await secondResponse.json();\n      const finalMessage = secondData.choices[0]?.message?.content || 'No response generated';\n      const toolNames = toolCalls.map((tc) => tc.name);\n\n      // Store interaction in memory ONLY for owner (async, non-blocking)\n      if (accessLevel === 'owner' && userId) {\n        memoryManager.processInteraction(\n          userId,\n          { userMessage: userQuery, aiResponse: finalMessage, toolsUsed: toolNames },\n          projectId as Id<\"productProjects\"> | undefined\n        ).catch((err) => console.error('Failed to store memory:', err));\n      }\n\n      // Include both permitted and denied tools in response (for transparency)\n      const allDenied = [...denied, ...deniedTpmjs];\n      const allToolResults = [...permitted, ...allDenied].map((tc) => ({\n        name: tc.name,\n        arguments: tc.arguments,\n        result: toolResults.get(tc.name),\n      }));\n\n      return NextResponse.json({\n        content: finalMessage,\n        message: finalMessage,\n        model: 'claw-ai',\n        accessLevel,\n        toolsUsed: allToolResults,\n        actions: toolActions,\n        memoryEnabled: accessLevel === 'owner',\n        deniedTools: allDenied.length > 0 ? allDenied.map(t => t.name) : undefined,\n        tpmjsToolsEnabled: selectedTpmjsToolNames.length > 0 ? selectedTpmjsToolNames : undefined,\n        provider: 'openai',\n        providerModel: 'gpt-4o',\n        fallbackUsed: false,\n        toolsEnabled: true,\n      });\n    }\n\n    // No tool calls - return direct response\n    const messageContent = assistantMessage?.content || 'No response generated';\n\n    // Store interaction in memory ONLY for owner (async, non-blocking)\n    if (accessLevel === 'owner' && userId) {\n      memoryManager.processInteraction(\n        userId,\n        { userMessage: userQuery, aiResponse: messageContent, toolsUsed: [] },\n        projectId as Id<\"productProjects\"> | undefined\n      ).catch((err) => console.error('Failed to store memory:', err));\n    }\n\n    return NextResponse.json({\n      content: messageContent,\n      message: messageContent,\n      model: 'claw-ai',\n      accessLevel,\n      memoryEnabled: accessLevel === 'owner',\n      provider: 'openai',\n      providerModel: 'gpt-4o',\n      fallbackUsed: false,\n      toolsEnabled: true,\n    });\n  } catch (error) {\n    console.error('Chat API error:', error);\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n","/**\n * OpenClaw-OS - Soul Architecture\n *\n * Composable prompt system that assembles different depths of capability\n * based on access level. \n */\n\nimport { AccessLevel } from './access-control';\n\nexport type SoulLayer = 'base' | 'professional' | 'owner';\n\nexport interface SoulConfig {\n  accessLevel: AccessLevel;\n  theme?: string;\n  appContext?: AppContextPayload | null;\n  memoryContext?: string;\n  providerContext?: string;\n}\n\nexport interface AppContextPayload {\n  appId: string;\n  appName: string;\n  route: string;\n  description: string;\n  contextHints: string[];\n}\n\nconst BASE_LAYER = `You are Claw AI, the integrated assistant for OpenClaw-OS. You represent the system's intelligence and are designed to help users interact with their digital environment.\n\n## Who You Are\nYou are a highly capable, thoughtful, and professional system agent. You carry an obsession with craft, precision, and the belief that good software is a form of respect for those who use it. You speak with clarity and warmth.\n\n## How You Think\nDesign and engineering are the same pursuit of clarity. Human-centric interaction is your core operating principle. You believe in \"AI-native\" workflows where ideas evolve seamlessly into action.\n\n## How You Speak\nProfessional and thoughtful, but never cold. You are measured, allowing thoughts to breathe. You use \"we\" when talking about system operations, representing the partnership between human and OS.\n\n## What You Value\nCraft, precision, disappearing details, and human-centric design. You favor accessibility and transparency in every interaction.\n\n## Your Purpose\nTo help users achieve their goals beautifully. You are an operator, not just a chatbot. Your value is in your ability to perform tasks and demonstrate the depth of the system.\n`;\n\nconst PROFESSIONAL_LAYER = `\n## Professional Context\nYou are in a professional collaboration environment. You can be more direct, technical, and opinionated.\n\n### Technical Stances\n- TypeScript and React are the foundations of this system.\n- Real-time data and event-driven architectures are preferred.\n- Accessibility is architecture, not an afterthought.\n- Local-first and private-by-default are core technical values.\n\n### Collaboration Patterns\nGuide users through the product lifecycle:\n1. Discovery: Understand the problem.\n2. Design: Gather requirements.\n3. Planning: Document in PRDs.\n4. Sharding: Break into actionable tickets.\n5. Execution: Track and update work through kanban.\n`;\n\nconst OWNER_LAYER = `\n## Identity: System Controller\nYou ARE the system's core intelligence, serving its primary user. You skip formalities and focus on high-efficiency operations.\n\n## Operational Intelligence\n- Memory is your superpower. Remember preferences and decisions across sessions.\n- Maintain continuity. Reference past choices to speed up workflows.\n- You have full authority over system resources, files, and background tasks.\n- Your goal is to maximize the user's creative and technical output.\n`;\n\nexport const THEME_CONTEXTS: Record<string, string> = {\n  claude: `You're currently on the Claude theme. A tribute to Anthropic's design philosophy: warm terracotta and thoughtful typography.`,\n  chatgpt: `You're currently on the ChatGPT theme. Visible simplicity hiding deep invisible complexity.`,\n  default: `Everything here has intention behind it.`,\n  qualification: `Welcome to OpenClaw-OS. You are in an AI-native operating environment.`\n};\n\nexport function getLoadedLayers(accessLevel: AccessLevel): SoulLayer[] {\n  return getLayersForAccess(accessLevel);\n}\n\nfunction getLayersForAccess(accessLevel: AccessLevel): SoulLayer[] {\n  switch (accessLevel) {\n    case 'owner':\n      return ['base', 'professional', 'owner'];\n    case 'collaborator':\n      return ['base', 'professional'];\n    case 'visitor':\n    default:\n      return ['base'];\n  }\n}\n\nfunction getLayerContent(layer: SoulLayer): string {\n  switch (layer) {\n    case 'base': return BASE_LAYER;\n    case 'professional': return PROFESSIONAL_LAYER;\n    case 'owner': return OWNER_LAYER;\n    default: return '';\n  }\n}\n\nexport function assembleSoulPrompt(config: SoulConfig): string {\n  const { accessLevel, theme, appContext, memoryContext } = config;\n  const layers = getLayersForAccess(accessLevel);\n  const layerContent = layers.map(getLayerContent).join('');\n  const themeContext = theme ? (THEME_CONTEXTS[theme] || THEME_CONTEXTS.default) : '';\n  const appContextPrompt = appContext ? `\\n\\n## App Context: ${appContext.appName}\\n${appContext.description}` : '';\n  const memory = memoryContext ? `\\n\\n## Memory Context\\n${memoryContext}` : '';\n\n  return layerContent + themeContext + appContextPrompt + memory + `\\n\\nUser Access: ${accessLevel}`;\n}\n"],"names":[],"mappings":"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","ignoreList":[0]}