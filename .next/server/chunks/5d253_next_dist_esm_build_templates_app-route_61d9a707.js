module.exports=[600253,e=>{"use strict";var t=e.i(457375),r=e.i(174015),n=e.i(116384),a=e.i(63831),o=e.i(868001),i=e.i(842780),s=e.i(763077),l=e.i(502964),u=e.i(993216),c=e.i(783900),d=e.i(295731),p=e.i(726839),m=e.i(775778),g=e.i(40992),f=e.i(432128),h=e.i(193695);e.i(44807);var y=e.i(989978),R=e.i(39334),E=e.i(879389),w=e.i(572067),_=e.i(488782);let S={windowMs:36e5,maxRequests:10},v=null,A=process.env.OWNER_USER_ID,C=process.env.ACESTEP_DIRECT_URL||"http://localhost:8001";async function k(e=!1){try{if(!A)return console.error("[MusicGen] OWNER_USER_ID environment variable is required"),null;let t=(v||(v=new _.ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL)),v);if(e)return console.log("[MusicGen] Internal request - fetching owner settings directly"),await t.query(_.api.aiSettings.getSettingsWithDefaults,{ownerId:A});let{userId:r}=await (0,w.auth)();if(!r)return null;let n=await t.query(_.api.userManagement.getManagedUserByClerkId,{clerkId:r});if(n?.role!=="owner")return null;return await t.query(_.api.aiSettings.getSettingsWithDefaults,{ownerId:A})}catch(e){return console.error("[MusicGen] Error fetching AI settings:",e),null}}async function b(e){try{console.log(`[MusicGen] Direct ACE-Step call to: ${C}`);let t={prompt:e.prompt,lyrics:e.lyrics||"",duration:e.duration||30,bpm:e.bpm||120,key:e.key||"C major",time_signature:e.timeSignature||"4/4",infer_step:60,guidance_scale:15,guidance_scale_text:5,guidance_scale_lyric:5,manual_seeds:-1,audio2audio_enable:!1,ref_audio_strength:e.referenceStrength||.5},r=await fetch(`${C}/api/predict`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fn_index:0,data:[t.prompt,t.lyrics,t.duration,t.infer_step,t.guidance_scale,t.guidance_scale_text,t.guidance_scale_lyric,t.audio2audio_enable,null,t.ref_audio_strength,t.manual_seeds]}),signal:AbortSignal.timeout(6e5)});if(!r.ok){console.log("[MusicGen] Gradio API failed, trying REST endpoint...");let r=await fetch(`${C}/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(6e5)});if(!r.ok){let e=await r.text();return console.error("[MusicGen] ACE-Step error:",r.status,e),null}let n=await r.json();return T(n,e)}let n=await r.json();if(n.data){let t=n.data[0];return{id:`gen_${Date.now()}`,status:"completed",audioUrl:t?.url||t,audioBase64:t?.data,duration:e.duration||30,metadata:{bpm:e.bpm||120,key:e.key||"C major",timeSignature:e.timeSignature||"4/4",model:"acestep-v15-turbo",lmModel:"acestep-5Hz-lm-1.7B"},provider:"local-acestep-direct",title:e.title}}return T(n,e)}catch(e){return console.error("[MusicGen] Direct ACE-Step generation failed:",e),null}}function T(e,t){return{id:e.id||`gen_${Date.now()}`,status:"completed",audioUrl:e.audio_url,audioBase64:e.audio_base64,duration:e.duration||t.duration||30,metadata:{bpm:e.metadata?.bpm||t.bpm||120,key:e.metadata?.key||t.key||"C major",timeSignature:e.metadata?.time_signature||t.timeSignature||"4/4",model:e.metadata?.model||"acestep-v15-turbo",lmModel:e.metadata?.lm_model||"acestep-5Hz-lm-1.7B"},provider:"local-acestep-direct",title:t.title}}async function x(e,t,r){try{console.log(`[MusicGen] Using Lynkr tunnel: ${t}`);let n={prompt:e.prompt,lyrics:e.lyrics,duration:e.duration||30,bpm:e.bpm,key:e.key,time_signature:e.timeSignature||"4/4",reference_audio:e.referenceAudio,reference_strength:e.referenceStrength||.5,model:e.model||"acestep-v15-turbo",lm_model:e.lmModel||"acestep-5Hz-lm-1.7B",format:e.format||"mp3"},a=await fetch(`${t}/v1/audio/generate`,{method:"POST",headers:{"Content-Type":"application/json","X-Remote-Access-Key":r},body:JSON.stringify(n),signal:AbortSignal.timeout(1e4)});if(!a.ok){let e=await a.text();return console.error("[MusicGen] Lynkr task creation error:",a.status,e),null}let o=await a.json(),i=o.id||o.task_id;if(!i)return console.error("[MusicGen] No task_id in Lynkr response:",o),null;console.log(`[MusicGen] Task created: ${i}, polling for completion...`);let s=Date.now();for(;Date.now()-s<3e5;){await new Promise(e=>setTimeout(e,2e3));let a=await fetch(`${t}/v1/audio/generate/${i}/status`,{method:"GET",headers:{"X-Remote-Access-Key":r},signal:AbortSignal.timeout(5e3)});if(!a.ok){console.error("[MusicGen] Status poll error:",a.status);continue}let o=await a.json();if("completed"===o.status&&o.audioUrl)return{id:o.id||i,status:"completed",audioUrl:o.audioUrl||o.audio_url,audioBase64:o.audioBase64||o.audio_base64,duration:o.duration||e.duration||30,metadata:{bpm:o.metadata?.bpm||e.bpm||120,key:o.metadata?.key||e.key||"C major",timeSignature:o.metadata?.time_signature||o.metadata?.timeSignature||e.timeSignature||"4/4",model:o.metadata?.model||n.model,lmModel:o.metadata?.lm_model||o.metadata?.lmModel||n.lm_model},provider:"local-acestep",title:e.title};if("failed"===o.status)return console.error("[MusicGen] Generation failed:",o.error),null;console.log(`[MusicGen] Status: ${o.status}, progress: ${100*(o.progress||0)}%`)}return console.error("[MusicGen] Polling timeout after 5 minutes"),null}catch(e){return console.error("[MusicGen] Lynkr generation failed:",e),null}}async function N(e,t,r,n){try{let a=await fetch(`${r}/v1/audio/analyze`,{method:"POST",headers:{"Content-Type":"application/json","X-Remote-Access-Key":n},body:JSON.stringify({audio:e,extract:t||["bpm","key","time_signature","caption"]}),signal:AbortSignal.timeout(6e4)});if(!a.ok){let e=await a.text();return console.error("[MusicGen] Analyze error:",a.status,e),null}return await a.json()}catch(e){return console.error("[MusicGen] Analyze failed:",e),null}}async function M(e,t,r,n){try{let a=await fetch(`${r}/v1/audio/separate`,{method:"POST",headers:{"Content-Type":"application/json","X-Remote-Access-Key":n},body:JSON.stringify({audio:e,stems:t||["vocals","drums","bass","other"]}),signal:AbortSignal.timeout(18e4)});if(!a.ok){let e=await a.text();return console.error("[MusicGen] Separate error:",a.status,e),null}return(await a.json()).stems}catch(e){return console.error("[MusicGen] Separation failed:",e),null}}async function j(e){let t=(0,E.getClientIp)(e),r=(0,E.checkRateLimit)(`music:${t}`,S);if(!r.allowed)return R.NextResponse.json({error:"Rate limit exceeded. Maximum 10 generations per hour.",retryAfter:Math.ceil((r.resetAt-Date.now())/1e3)},{status:429,headers:{"Retry-After":String(Math.ceil((r.resetAt-Date.now())/1e3))}});try{let t=await e.json(),{action:r="generate"}=t;if("generate"===r&&!t.prompt)return R.NextResponse.json({error:"Prompt is required for music generation"},{status:400});if(t.duration&&(t.duration<10||t.duration>600))return R.NextResponse.json({error:"Duration must be between 10 and 600 seconds"},{status:400});let n=e.headers.get("x-internal-secret"),a=e.headers.get("host")||"",o=(0,E.getClientIp)(e),i=/^(localhost|127\.0\.0\.1)(:\d+)?$/.test(a),s="127.0.0.1"===o||"::1"===o||"localhost"===o,l=n===process.env.INTERNAL_API_SECRET&&!!process.env.INTERNAL_API_SECRET||i||s,u=process.env.ACESTEP_DIRECT_URL;console.log("[MusicGen] Request check:",{host:a,clientIp:o,hasSecret:!!n,isLocalhostHost:i,isLocalhostIp:s,isInternalRequest:l,isDev:u}),l&&console.log("[MusicGen] Internal request detected - bypassing Clerk auth");let c=await k(l),d=c?.lynkrEnabled&&c?.lynkrTunnelUrl&&c?.lynkrApiKey;if(d&&c.lynkrApiKey.length<32)return R.NextResponse.json({error:"Lynkr API key must be at least 32 characters. Update in /settings/ai"},{status:503});switch(r){case"generate":{let e=null;if(d&&(e=await x(t,c.lynkrTunnelUrl,c.lynkrApiKey)),!e&&u&&(console.log("[MusicGen] Trying direct ACE-Step connection..."),e=await b(t)),!e)return R.NextResponse.json({error:"Music generation failed. Ensure ACE-Step is running locally on port 8001.",hint:d?"Lynkr tunnel configured but failed":"Set ACESTEP_DIRECT_URL or configure Lynkr in /settings/ai"},{status:500});return R.NextResponse.json(e)}case"analyze":{if(!d)return R.NextResponse.json({error:"Audio analysis requires Lynkr tunnel. Configure in /settings/ai"},{status:503});let e=t.audioUrl,r=t.extract;if(!e)return R.NextResponse.json({error:"audioUrl is required for analysis"},{status:400});let n=await N(e,r||["bpm","key","time_signature","caption"],c.lynkrTunnelUrl,c.lynkrApiKey);if(!n)return R.NextResponse.json({error:"Audio analysis failed."},{status:500});return R.NextResponse.json({...n,provider:"local-acestep"})}case"separate":{if(!d)return R.NextResponse.json({error:"Stem separation requires Lynkr tunnel. Configure in /settings/ai"},{status:503});let e=t.audioUrl,r=t.stems;if(!e)return R.NextResponse.json({error:"audioUrl is required for stem separation"},{status:400});let n=await M(e,r||["vocals","drums","bass","other"],c.lynkrTunnelUrl,c.lynkrApiKey);if(!n)return R.NextResponse.json({error:"Stem separation failed."},{status:500});return R.NextResponse.json({stems:n,provider:"local-acestep"})}default:return R.NextResponse.json({error:`Unknown action: ${r}`},{status:400})}}catch(e){return console.error("[MusicGen] Error:",e),R.NextResponse.json({error:"Failed to process request. Please try again."},{status:500})}}async function U(){let e=await k(),t=e?.lynkrEnabled&&e?.lynkrTunnelUrl,r=process.env.ACESTEP_DIRECT_URL;if(t)try{let t=await fetch(`${e.lynkrTunnelUrl}/health`,{method:"GET",signal:AbortSignal.timeout(5e3)});if(t.ok){let e=await t.json();return R.NextResponse.json({available:!0,acestepEnabled:e.acestep?.enabled??!1,models:e.acestep?.models??[],provider:"local-acestep-lynkr"})}}catch{console.log("[MusicGen] Lynkr health check failed, trying direct...")}if(r)try{if((await fetch(`${C}/info`,{method:"GET",signal:AbortSignal.timeout(5e3)})).ok||(await fetch(C,{method:"GET",signal:AbortSignal.timeout(5e3)})).ok)return R.NextResponse.json({available:!0,acestepEnabled:!0,models:["acestep-v15-turbo"],provider:"local-acestep-direct",url:C})}catch(e){console.log("[MusicGen] Direct ACE-Step health check failed:",e)}return R.NextResponse.json({available:!1,reason:t?"ACE-Step not responding":"Configure Lynkr tunnel or set ACESTEP_DIRECT_URL",hint:r?`Ensure ACE-Step is running at ${C}`:void 0})}e.s(["GET",()=>U,"POST",()=>j,"runtime",0,"nodejs"],225743);var P=e.i(225743);let I=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/music/generate/route",pathname:"/api/music/generate",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/music/generate/route.ts",nextConfigOutput:"",userland:P}),{workAsyncStorage:G,workUnitAsyncStorage:O,serverHooks:D}=I;function $(){return(0,n.patchFetch)({workAsyncStorage:G,workUnitAsyncStorage:O})}async function q(e,t,n){I.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/music/generate/route";R=R.replace(/\/index$/,"")||"/";let E=await I.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!E)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:w,params:_,nextConfig:S,parsedUrl:v,isDraftMode:A,prerenderManifest:C,routerServerContext:k,isOnDemandRevalidate:b,revalidateOnlyGenerated:T,resolvedPathname:x,clientReferenceManifest:N,serverActionsManifest:M}=E,j=(0,s.normalizeAppPath)(R),U=!!(C.dynamicRoutes[j]||C.routes[x]),P=async()=>((null==k?void 0:k.render404)?await k.render404(e,t,v,!1):t.end("This page could not be found"),null);if(U&&!A){let e=!!C.routes[x],t=C.dynamicRoutes[j];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await P();throw new h.NoFallbackError}}let G=null;!U||I.isDev||A||(G="/index"===(G=x)?"/":G);let O=!0===I.isDev||!U,D=U&&!O;M&&N&&(0,i.setManifestsSingleton)({page:R,clientReferenceManifest:N,serverActionsManifest:M});let $=e.method||"GET",q=(0,o.getTracer)(),L=q.getActiveScopeSpan(),H={params:_,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:O,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n,a)=>I.onRequestError(e,t,n,a,k)},sharedContext:{buildId:w}},K=new l.NodeNextRequest(e),B=new l.NodeNextResponse(t),F=u.NextRequestAdapter.fromNodeNextRequest(K,(0,u.signalFromNodeResponse)(t));try{let i=async e=>I.handle(F,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=q.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${$} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${R}`)}),s=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var o,l;let u=async({previousCacheEntry:r})=>{try{if(!s&&b&&T&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await i(a);e.fetchMetrics=H.renderOpts.fetchMetrics;let l=H.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let u=H.renderOpts.collectedTags;if(!U)return await (0,p.sendResponse)(K,B,o,H.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(o.headers);u&&(t[f.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,n=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:b})},!1,k),t}},c=await I.handleResponse({req:e,nextConfig:S,cacheKey:G,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:b,revalidateOnlyGenerated:T,responseGenerator:u,waitUntil:n.waitUntil,isMinimalMode:s});if(!U)return null;if((null==c||null==(o=c.value)?void 0:o.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",b?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let h=(0,m.fromNodeOutgoingHttpHeaders)(c.value.headers);return s&&U||h.delete(f.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||h.get("Cache-Control")||h.set("Cache-Control",(0,g.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(K,B,new Response(c.value.body,{headers:h,status:c.value.status||200})),null};L?await l(L):await q.withPropagatedContext(e.headers,()=>q.trace(c.BaseServerSpan.handleRequest,{spanName:`${$} ${R}`,kind:o.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof h.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:j,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:b})},!1,k),U)throw t;return await (0,p.sendResponse)(K,B,new Response(null,{status:500})),null}}e.s(["handler",()=>q,"patchFetch",()=>$,"routeModule",()=>I,"serverHooks",()=>D,"workAsyncStorage",()=>G,"workUnitAsyncStorage",()=>O],600253)}];

//# sourceMappingURL=5d253_next_dist_esm_build_templates_app-route_61d9a707.js.map