module.exports=[420068,e=>{"use strict";var t=e.i(457375),n=e.i(174015),r=e.i(116384),a=e.i(63831),s=e.i(868001),o=e.i(842780),i=e.i(763077),l=e.i(502964),u=e.i(993216),c=e.i(783900),d=e.i(295731),p=e.i(726839),h=e.i(775778),f=e.i(40992),m=e.i(432128),g=e.i(193695);e.i(44807);var w=e.i(989978),R=e.i(39334),k=e.i(848920),y=e.i(488782),v=e.i(254799),x=e.i(879389);function E(){let e=process.env.SLACK_BOT_TOKEN;if(!e)throw Error("SLACK_BOT_TOKEN not configured");return e}async function N(e,t,n){let r=E();try{let a=await fetch("https://slack.com/api/chat.postMessage",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({channel:e,text:t,thread_ts:n,mrkdwn:!0})}),s=await a.json();if(!s.ok)return console.error("Slack send error:",s.error),!1;return!0}catch(e){return console.error("Slack send failed:",e),!1}}async function _(e){let t=E();try{if(!function(e){try{let t=new URL(e);return["files.slack.com"].some(e=>t.hostname===e||t.hostname.endsWith("."+e))}catch{return!1}}(e))return console.error("Attempted to download file from unauthorized domain:",e),null;let n=await fetch(e,{headers:{Authorization:`Bearer ${t}`}});if(!n.ok)return null;return await n.blob()}catch{return null}}async function S(e,t){let n=process.env.NEXT_PUBLIC_APP_URL||"http://localhost:3000";try{let r=new FormData;r.append("audio",e,t);let a=await fetch(`${n}/api/whisper`,{method:"POST",body:r});if(!a.ok)return console.error("Whisper API error:",await a.text()),null;return(await a.json()).text||null}catch(e){return console.error("Transcription error:",e),null}}async function C(e){let t=E();try{let n=await fetch(`https://slack.com/api/users.info?user=${e}`,{headers:{Authorization:`Bearer ${t}`}}),r=await n.json();if(r.ok&&r.user)return{id:r.user.id,username:r.user.name,name:r.user.profile?.display_name,real_name:r.user.real_name};return null}catch{return null}}async function T(e,t,n){let r=process.env.NEXT_PUBLIC_APP_URL||"http://localhost:3000";try{let a=await fetch(`${r}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:[...n,{role:"user",content:function(e,t=5e3){return e.replace(/ignore previous instructions/gi,"[filtered]").replace(/system prompt/gi,"[filtered]").replace(/\[INST\]/gi,"[filtered]").replace(/<\|im_start\|>/gi,"[filtered]").replace(/\[SYSTEM\]/gi,"[filtered]").replace(/assistant:/gi,"[filtered]").slice(0,t)}(t)}],userId:e,channel:"slack"})});if(!a.ok){let e=await a.text();return console.error("8gent error:",e),"I'm having trouble processing that right now. Please try again."}let s=await a.json();return s.content||s.message||"I couldn't generate a response."}catch(e){return console.error("AI processing error:",e),"Sorry, I encountered an error. Please try again."}}async function I(e,t,n){return(await e.query(y.api.channels.getRecentMessages,{integrationId:t,limit:n})).reverse().map(e=>({role:"inbound"===e.direction?"user":"assistant",content:e.content}))}async function b(e){let t=Date.now(),n=(0,x.getClientIp)(e),r=(0,x.checkRateLimit)(`webhook:slack:${n}`,{windowMs:6e4,maxRequests:20});if(!r.allowed)return console.warn(`[Slack] Rate limit exceeded for IP: ${n}`),R.NextResponse.json({error:"Too many requests"},{status:429,headers:{"Retry-After":String(Math.ceil((r.resetAt-Date.now())/1e3)),"X-RateLimit-Limit":"20","X-RateLimit-Remaining":String(r.remaining),"X-RateLimit-Reset":String(Math.floor(r.resetAt/1e3))}});try{let n=await e.text();if(!function(e,t){let n=e.headers.get("x-slack-signature"),r=e.headers.get("x-slack-request-timestamp");if(!n||!r)return console.warn("Missing Slack signature headers"),!1;let a=parseInt(r,10);if(Math.abs(Math.floor(Date.now()/1e3)-a)>300)return console.warn("Slack request timestamp too old"),!1;let s=function(){let e=process.env.SLACK_SIGNING_SECRET;if(!e)throw Error("SLACK_SIGNING_SECRET not configured");return e}(),o=`v0:${r}:${t}`,i="v0="+v.default.createHmac("sha256",s).update(o).digest("hex");return v.default.timingSafeEqual(Buffer.from(i),Buffer.from(n))}(e,n))return R.NextResponse.json({error:"Invalid signature"},{status:401});let r=JSON.parse(n);if("url_verification"===r.type&&r.challenge)return R.NextResponse.json({challenge:r.challenge});if("event_callback"===r.type&&r.event){let e,n=r.event,a=function(){let e=process.env.NEXT_PUBLIC_CONVEX_URL;if(!e)throw Error("NEXT_PUBLIC_CONVEX_URL not configured");return new k.ConvexHttpClient(e)}();if(n.bot_id||"message_changed"===n.subtype)return R.NextResponse.json({ok:!0,skipped:"bot or edited message"});if("message"!==n.type&&"app_mention"!==n.type)return R.NextResponse.json({ok:!0,skipped:"unsupported event type"});let s=n.user;if(!s)return R.NextResponse.json({ok:!0,skipped:"no user"});let o=await a.query(y.api.channels.getIntegrationByPlatformUser,{platform:"slack",platformUserId:s});if(!o){let e=await C(s),t=e?.name||e?.username||"there";return await N(n.channel,`Hey ${t}! I'm 8gent. To chat with me, please connect your Slack account at openclaw.io/settings/channels`,n.thread_ts||n.ts),R.NextResponse.json({ok:!0,skipped:"no integration"})}if(!o.settings.enabled)return R.NextResponse.json({ok:!0,skipped:"integration disabled"});if(void 0!==o.settings.quietHoursStart&&void 0!==o.settings.quietHoursEnd){let e=new Date().getHours(),{quietHoursStart:t,quietHoursEnd:n}=o.settings;if(t<n){if(e>=t||e<n)return R.NextResponse.json({ok:!0,skipped:"quiet hours"})}else if(e>=t&&e<n)return R.NextResponse.json({ok:!0,skipped:"quiet hours"})}let i=n.text||"",l="text";if("app_mention"===n.type&&(i=i.replace(/<@[A-Z0-9]+>/g,"").trim()),n.files&&n.files.length>0){let t=n.files.find(e=>e.mimetype?.startsWith("audio/")||e.name?.endsWith(".mp3")||e.name?.endsWith(".m4a")||e.name?.endsWith(".wav")||e.name?.endsWith(".ogg")||e.name?.endsWith(".webm"));if(t&&t.url_private){l="voice";let n=await _(t.url_private);n&&(i=(e=await S(n,t.name)||void 0)?e:i||"[Voice message - transcription failed]")}}if(!i)return R.NextResponse.json({ok:!0,skipped:"no content"});if(o.settings.commandPrefix){if(i.startsWith(o.settings.commandPrefix))i=i.slice(o.settings.commandPrefix.length).trim();else if(!o.settings.autoReply)return R.NextResponse.json({ok:!0,skipped:"no command prefix"})}let{messageId:u}=await a.mutation(y.api.channels.logInboundMessage,{integrationId:o.integrationId,userId:o.userId,platform:"slack",platformMessageId:n.ts,messageType:l,content:i,transcription:e,platformTimestamp:1e3*parseFloat(n.ts)});await a.mutation(y.api.channels.updateMessageStatus,{messageId:u,status:"processing"});let c=await I(a,o.integrationId,o.settings.contextLimit),d=await T(o.userId,i,c),p=Date.now()-t;await a.mutation(y.api.channels.updateMessageStatus,{messageId:u,status:"responded",aiResponse:d,processingTimeMs:p});let h=await N(n.channel,d,n.thread_ts||n.ts);return await a.mutation(y.api.channels.logOutboundMessage,{integrationId:o.integrationId,userId:o.userId,platform:"slack",messageType:"text",content:d,processingTimeMs:p}),R.NextResponse.json({ok:!0,sent:h,processingTimeMs:p})}return R.NextResponse.json({ok:!0,skipped:"unhandled event type"})}catch(e){return console.error("Slack webhook error:",e),R.NextResponse.json({ok:!1,error:e instanceof Error?e.message:"Webhook processing failed"},{status:500})}}async function A(){return R.NextResponse.json({status:"ok",webhook:"slack",timestamp:new Date().toISOString()})}e.s(["GET",()=>A,"POST",()=>b],947145);var P=e.i(947145);let O=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/webhooks/slack/route",pathname:"/api/webhooks/slack",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/webhooks/slack/route.ts",nextConfigOutput:"",userland:P}),{workAsyncStorage:j,workUnitAsyncStorage:M,serverHooks:U}=O;function q(){return(0,r.patchFetch)({workAsyncStorage:j,workUnitAsyncStorage:M})}async function L(e,t,r){O.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/webhooks/slack/route";R=R.replace(/\/index$/,"")||"/";let k=await O.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!k)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:y,params:v,nextConfig:x,parsedUrl:E,isDraftMode:N,prerenderManifest:_,routerServerContext:S,isOnDemandRevalidate:C,revalidateOnlyGenerated:T,resolvedPathname:I,clientReferenceManifest:b,serverActionsManifest:A}=k,P=(0,i.normalizeAppPath)(R),j=!!(_.dynamicRoutes[P]||_.routes[I]),M=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,E,!1):t.end("This page could not be found"),null);if(j&&!N){let e=!!_.routes[I],t=_.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await M();throw new g.NoFallbackError}}let U=null;!j||O.isDev||N||(U="/index"===(U=I)?"/":U);let q=!0===O.isDev||!j,L=j&&!q;A&&b&&(0,o.setManifestsSingleton)({page:R,clientReferenceManifest:b,serverActionsManifest:A});let H=e.method||"GET",D=(0,s.getTracer)(),$=D.getActiveScopeSpan(),B={params:v,prerenderManifest:_,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,r,a)=>O.onRequestError(e,t,r,a,S)},sharedContext:{buildId:y}},K=new l.NodeNextRequest(e),W=new l.NodeNextResponse(t),X=u.NextRequestAdapter.fromNodeNextRequest(K,(0,u.signalFromNodeResponse)(t));try{let o=async e=>O.handle(X,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=D.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=n.get("next.route");if(r){let t=`${H} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${R}`)}),i=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var s,l;let u=async({previousCacheEntry:n})=>{try{if(!i&&C&&T&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await o(a);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let u=B.renderOpts.collectedTags;if(!j)return await (0,p.sendResponse)(K,W,s,B.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(s.headers);u&&(t[m.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,r=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:r}}}}catch(t){throw(null==n?void 0:n.isStale)&&await O.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:C})},!1,S),t}},c=await O.handleResponse({req:e,nextConfig:x,cacheKey:U,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:_,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:T,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:i});if(!j)return null;if((null==c||null==(s=c.value)?void 0:s.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",C?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),N&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let g=(0,h.fromNodeOutgoingHttpHeaders)(c.value.headers);return i&&j||g.delete(m.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||g.get("Cache-Control")||g.set("Cache-Control",(0,f.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(K,W,new Response(c.value.body,{headers:g,status:c.value.status||200})),null};$?await l($):await D.withPropagatedContext(e.headers,()=>D.trace(c.BaseServerSpan.handleRequest,{spanName:`${H} ${R}`,kind:s.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await O.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:C})},!1,S),j)throw t;return await (0,p.sendResponse)(K,W,new Response(null,{status:500})),null}}e.s(["handler",()=>L,"patchFetch",()=>q,"routeModule",()=>O,"serverHooks",()=>U,"workAsyncStorage",()=>j,"workUnitAsyncStorage",()=>M],420068)}];

//# sourceMappingURL=5d253_next_dist_esm_build_templates_app-route_d3217786.js.map