{"version":3,"sources":["../../../src/lib/video/ltx-video.ts","../../../node_modules/.pnpm/%40vercel%2Boidc%403.1.0/node_modules/%40vercel/oidc/dist/token-error.js"],"sourcesContent":["/**\n * LTX-2 Video Generation via Fal AI\n *\n * LTX-2 is Lightricks' 19B parameter DiT-based diffusion model for\n * synchronized audio-video generation.\n *\n * Capabilities:\n * - Text-to-Video (T2V)\n * - Image-to-Video (I2V)\n * - Video extension\n *\n * Model: fal-ai/ltx-video\n */\n\n// LTX-2 API endpoints on Fal AI\nconst FAL_API_URL = 'https://queue.fal.run';\nconst LTX_TEXT_TO_VIDEO = 'fal-ai/ltx-video';\nconst LTX_IMAGE_TO_VIDEO = 'fal-ai/ltx-video/image-to-video';\n\n// ─────────────────────────────────────────────────────────────────────────────\n// Types\n// ─────────────────────────────────────────────────────────────────────────────\n\nexport interface LTXTextToVideoRequest {\n  /** Text description of the video to generate */\n  prompt: string;\n  /** What to avoid in the generation */\n  negative_prompt?: string;\n  /** Number of frames (must be 8n+1, e.g., 97, 121, 145) */\n  num_frames?: number;\n  /** Width in pixels (must be divisible by 32) */\n  width?: number;\n  /** Height in pixels (must be divisible by 32) */\n  height?: number;\n  /** Random seed for reproducibility */\n  seed?: number;\n  /** Number of inference steps (default: 30) */\n  num_inference_steps?: number;\n  /** Guidance scale (default: 7.5) */\n  guidance_scale?: number;\n}\n\nexport interface LTXImageToVideoRequest {\n  /** Text description of the motion/animation */\n  prompt: string;\n  /** Starting image URL */\n  image_url: string;\n  /** What to avoid in the generation */\n  negative_prompt?: string;\n  /** Number of frames (must be 8n+1) */\n  num_frames?: number;\n  /** Random seed for reproducibility */\n  seed?: number;\n  /** Number of inference steps */\n  num_inference_steps?: number;\n  /** Guidance scale */\n  guidance_scale?: number;\n}\n\nexport interface LTXVideoResponse {\n  video: {\n    url: string;\n    content_type: string;\n    file_name: string;\n    file_size: number;\n  };\n  seed?: number;\n  timings?: {\n    inference: number;\n  };\n}\n\nexport interface LTXVideoPreset {\n  name: string;\n  width: number;\n  height: number;\n  num_frames: number;\n  description: string;\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// Presets\n// ─────────────────────────────────────────────────────────────────────────────\n\nexport const LTX_PRESETS: Record<string, LTXVideoPreset> = {\n  landscape_short: {\n    name: 'Landscape Short',\n    width: 768,\n    height: 512,\n    num_frames: 97, // ~4 seconds at 24fps\n    description: '16:9 landscape, 4 seconds',\n  },\n  landscape_long: {\n    name: 'Landscape Long',\n    width: 768,\n    height: 512,\n    num_frames: 145, // ~6 seconds at 24fps\n    description: '16:9 landscape, 6 seconds',\n  },\n  portrait_short: {\n    name: 'Portrait Short',\n    width: 512,\n    height: 768,\n    num_frames: 97,\n    description: '9:16 portrait (stories/reels), 4 seconds',\n  },\n  portrait_long: {\n    name: 'Portrait Long',\n    width: 512,\n    height: 768,\n    num_frames: 145,\n    description: '9:16 portrait (stories/reels), 6 seconds',\n  },\n  square: {\n    name: 'Square',\n    width: 512,\n    height: 512,\n    num_frames: 97,\n    description: '1:1 square, 4 seconds',\n  },\n  cinematic: {\n    name: 'Cinematic',\n    width: 832,\n    height: 448,\n    num_frames: 121, // ~5 seconds\n    description: '2.39:1 cinematic widescreen, 5 seconds',\n  },\n};\n\n// ─────────────────────────────────────────────────────────────────────────────\n// Fal Queue Helpers\n// ─────────────────────────────────────────────────────────────────────────────\n\ninterface FalQueueResponse {\n  request_id: string;\n  status: string;\n  response_url?: string;\n}\n\ninterface FalStatusResponse {\n  status: 'IN_QUEUE' | 'IN_PROGRESS' | 'COMPLETED' | 'FAILED';\n  response_url?: string;\n  logs?: { message: string; timestamp: string }[];\n  error?: string;\n}\n\nasync function submitToFalQueue<T>(\n  model: string,\n  input: Record<string, unknown>,\n  options?: {\n    maxAttempts?: number;\n    pollInterval?: number;\n    onProgress?: (status: string, logs?: { message: string; timestamp: string }[]) => void;\n  }\n): Promise<T> {\n  const apiKey = process.env.FAL_KEY;\n  if (!apiKey) {\n    throw new Error('FAL_KEY not configured');\n  }\n\n  const maxAttempts = options?.maxAttempts ?? 180; // 15 minutes max\n  const pollInterval = options?.pollInterval ?? 5000; // 5 seconds\n\n  // Submit to queue\n  const submitResponse = await fetch(`${FAL_API_URL}/${model}`, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      Authorization: `Key ${apiKey}`,\n    },\n    body: JSON.stringify(input),\n  });\n\n  if (!submitResponse.ok) {\n    const error = await submitResponse.text();\n    throw new Error(`LTX-2 submit error: ${error}`);\n  }\n\n  const queueData: FalQueueResponse = await submitResponse.json();\n  const statusUrl = `${FAL_API_URL}/${model}/requests/${queueData.request_id}/status`;\n  const resultUrl = `${FAL_API_URL}/${model}/requests/${queueData.request_id}`;\n\n  // Poll for completion\n  let attempts = 0;\n\n  while (attempts < maxAttempts) {\n    await new Promise((resolve) => setTimeout(resolve, pollInterval));\n\n    const statusResponse = await fetch(statusUrl, {\n      headers: { Authorization: `Key ${apiKey}` },\n    });\n\n    if (!statusResponse.ok) {\n      attempts++;\n      continue;\n    }\n\n    const status: FalStatusResponse = await statusResponse.json();\n    options?.onProgress?.(status.status, status.logs);\n\n    if (status.status === 'COMPLETED') {\n      const resultResponse = await fetch(resultUrl, {\n        headers: { Authorization: `Key ${apiKey}` },\n      });\n\n      if (!resultResponse.ok) {\n        throw new Error('Failed to fetch LTX-2 result');\n      }\n\n      return resultResponse.json();\n    }\n\n    if (status.status === 'FAILED') {\n      throw new Error(`LTX-2 job failed: ${status.error || 'Unknown error'}`);\n    }\n\n    attempts++;\n  }\n\n  throw new Error('LTX-2 job timed out');\n}\n\n// ─────────────────────────────────────────────────────────────────────────────\n// Public API\n// ─────────────────────────────────────────────────────────────────────────────\n\n/**\n * Generate a video from a text prompt using LTX-2\n */\nexport async function generateVideoFromText(\n  request: LTXTextToVideoRequest,\n  options?: {\n    onProgress?: (status: string) => void;\n  }\n): Promise<LTXVideoResponse> {\n  // Validate frame count (must be 8n+1)\n  if (request.num_frames && (request.num_frames - 1) % 8 !== 0) {\n    const corrected = Math.floor((request.num_frames - 1) / 8) * 8 + 1;\n    console.warn(`LTX-2: Correcting num_frames from ${request.num_frames} to ${corrected} (must be 8n+1)`);\n    request.num_frames = corrected;\n  }\n\n  // Validate dimensions (must be divisible by 32)\n  if (request.width && request.width % 32 !== 0) {\n    request.width = Math.floor(request.width / 32) * 32;\n  }\n  if (request.height && request.height % 32 !== 0) {\n    request.height = Math.floor(request.height / 32) * 32;\n  }\n\n  return submitToFalQueue<LTXVideoResponse>(\n    LTX_TEXT_TO_VIDEO,\n    {\n      prompt: request.prompt,\n      negative_prompt: request.negative_prompt || 'blurry, low quality, distorted, watermark',\n      num_frames: request.num_frames || 97,\n      width: request.width || 768,\n      height: request.height || 512,\n      seed: request.seed,\n      num_inference_steps: request.num_inference_steps || 30,\n      guidance_scale: request.guidance_scale || 7.5,\n    },\n    {\n      onProgress: (status) => options?.onProgress?.(status),\n    }\n  );\n}\n\n/**\n * Generate a video from an image using LTX-2 (Image-to-Video)\n */\nexport async function generateVideoFromImage(\n  request: LTXImageToVideoRequest,\n  options?: {\n    onProgress?: (status: string) => void;\n  }\n): Promise<LTXVideoResponse> {\n  // Validate frame count (must be 8n+1)\n  if (request.num_frames && (request.num_frames - 1) % 8 !== 0) {\n    const corrected = Math.floor((request.num_frames - 1) / 8) * 8 + 1;\n    request.num_frames = corrected;\n  }\n\n  return submitToFalQueue<LTXVideoResponse>(\n    LTX_IMAGE_TO_VIDEO,\n    {\n      prompt: request.prompt,\n      image_url: request.image_url,\n      negative_prompt: request.negative_prompt || 'blurry, low quality, distorted, watermark',\n      num_frames: request.num_frames || 97,\n      seed: request.seed,\n      num_inference_steps: request.num_inference_steps || 30,\n      guidance_scale: request.guidance_scale || 7.5,\n    },\n    {\n      onProgress: (status) => options?.onProgress?.(status),\n    }\n  );\n}\n\n/**\n * Generate video with a preset configuration\n */\nexport async function generateVideoWithPreset(\n  prompt: string,\n  presetName: keyof typeof LTX_PRESETS,\n  options?: {\n    negative_prompt?: string;\n    seed?: number;\n    image_url?: string;\n    onProgress?: (status: string) => void;\n  }\n): Promise<LTXVideoResponse> {\n  const preset = LTX_PRESETS[presetName];\n  if (!preset) {\n    throw new Error(`Unknown preset: ${presetName}`);\n  }\n\n  // If image_url provided, use I2V, otherwise T2V\n  if (options?.image_url) {\n    return generateVideoFromImage(\n      {\n        prompt,\n        image_url: options.image_url,\n        negative_prompt: options.negative_prompt,\n        num_frames: preset.num_frames,\n        seed: options.seed,\n      },\n      { onProgress: options?.onProgress }\n    );\n  }\n\n  return generateVideoFromText(\n    {\n      prompt,\n      negative_prompt: options?.negative_prompt,\n      width: preset.width,\n      height: preset.height,\n      num_frames: preset.num_frames,\n      seed: options?.seed,\n    },\n    { onProgress: options?.onProgress }\n  );\n}\n\n/**\n * Check if LTX-2 is configured (Fal API key available)\n */\nexport function isLTXConfigured(): boolean {\n  return !!process.env.FAL_KEY;\n}\n\n/**\n * Get estimated duration from frame count\n * LTX-2 generates at ~24fps\n */\nexport function getEstimatedDuration(numFrames: number): number {\n  return numFrames / 24;\n}\n\n/**\n * Get recommended frame count for a target duration\n * Returns the nearest valid frame count (8n+1)\n */\nexport function getFrameCountForDuration(targetSeconds: number): number {\n  const targetFrames = Math.round(targetSeconds * 24);\n  // Round to nearest 8n+1\n  return Math.floor((targetFrames - 1) / 8) * 8 + 1;\n}\n","\"use strict\";\nvar __defProp = Object.defineProperty;\nvar __getOwnPropDesc = Object.getOwnPropertyDescriptor;\nvar __getOwnPropNames = Object.getOwnPropertyNames;\nvar __hasOwnProp = Object.prototype.hasOwnProperty;\nvar __export = (target, all) => {\n  for (var name in all)\n    __defProp(target, name, { get: all[name], enumerable: true });\n};\nvar __copyProps = (to, from, except, desc) => {\n  if (from && typeof from === \"object\" || typeof from === \"function\") {\n    for (let key of __getOwnPropNames(from))\n      if (!__hasOwnProp.call(to, key) && key !== except)\n        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });\n  }\n  return to;\n};\nvar __toCommonJS = (mod) => __copyProps(__defProp({}, \"__esModule\", { value: true }), mod);\nvar token_error_exports = {};\n__export(token_error_exports, {\n  VercelOidcTokenError: () => VercelOidcTokenError\n});\nmodule.exports = __toCommonJS(token_error_exports);\nclass VercelOidcTokenError extends Error {\n  constructor(message, cause) {\n    super(message);\n    this.name = \"VercelOidcTokenError\";\n    this.cause = cause;\n  }\n  toString() {\n    if (this.cause) {\n      return `${this.name}: ${this.message}: ${this.cause}`;\n    }\n    return `${this.name}: ${this.message}`;\n  }\n}\n// Annotate the CommonJS export names for ESM import in node:\n0 && (module.exports = {\n  VercelOidcTokenError\n});\n"],"names":[],"mappings":"43BAeA,IAAM,EAAc,wBAqEP,EAA8C,CACzD,gBAAiB,CACf,KAAM,kBACN,MAAO,IACP,OAAQ,IACR,WAAY,GACZ,YAAa,2BACf,EACA,eAAgB,CACd,KAAM,iBACN,MAAO,IACP,OAAQ,IACR,WAAY,IACZ,YAAa,2BACf,EACA,eAAgB,CACd,KAAM,iBACN,MAAO,IACP,OAAQ,IACR,WAAY,GACZ,YAAa,0CACf,EACA,cAAe,CACb,KAAM,gBACN,MAAO,IACP,OAAQ,IACR,WAAY,IACZ,YAAa,0CACf,EACA,OAAQ,CACN,KAAM,SACN,MAAO,IACP,OAAQ,IACR,WAAY,GACZ,YAAa,uBACf,EACA,UAAW,CACT,KAAM,YACN,MAAO,IACP,OAAQ,IACR,WAAY,IACZ,YAAa,wCACf,CACF,EAmBA,eAAe,EACb,CAAa,CACb,CAA8B,CAC9B,CAIC,EAED,IAAM,EAAS,QAAQ,GAAG,CAAC,OAAO,CAClC,GAAI,CAAC,EACH,MAAM,AADK,AACD,MAAM,0BAGlB,IAAM,EAAc,GAAS,aAAe,IACtC,CAD2C,CAC5B,GAAS,aADoC,CACpB,IAGxC,EAH8C,AAG7B,MAAM,MAHmC,AAG7B,CAAA,EAAG,EAAY,CAAC,EAAE,EAAA,CAAO,CAAE,CAC5D,OAAQ,OACR,QAAS,CACP,eAAgB,mBAChB,cAAe,CAAC,IAAI,EAAE,EAAA,CAAQ,AAChC,EACA,KAAM,KAAK,SAAS,CAAC,EACvB,GAEA,GAAI,CAAC,EAAe,EAAE,CAAE,CACtB,IAAM,EAAQ,MAAM,EAAe,IAAI,EACvC,OAAM,AAAI,MAAM,CAAC,oBAAoB,EAAE,EAAA,CAAO,CAChD,CAEA,IAAM,EAA8B,MAAM,EAAe,IAAI,GACvD,EAAY,CAAA,EAAG,EAAY,CAAC,EAAE,EAAM,UAAU,EAAE,EAAU,UAAU,CAAC,OAAO,CAAC,CAC7E,EAAY,CAAA,EAAG,EAAY,CAAC,EAAE,EAAM,UAAU,EAAE,EAAU,UAAU,CAAA,CAAE,CAGxE,EAAW,EAEf,KAAO,EAAW,GAAa,CAC7B,MAAM,IAAI,QAAQ,AAAC,GAAY,WAAW,EAAS,IAEnD,IAAM,EAAiB,MAAM,MAAM,EAAW,CAC5C,QAAS,CAAE,cAAe,CAAC,IAAI,EAAE,EAAA,CAAQ,AAAC,CAC5C,GAEA,GAAI,CAAC,EAAe,EAAE,CAAE,CACtB,IACA,QACF,CAEA,IAAM,EAA4B,MAAM,EAAe,IAAI,GAG3D,GAFA,GAAS,aAAa,EAAO,MAAM,CAAE,EAAO,IAAI,EAE1B,cAAlB,EAAO,MAAM,CAAkB,CACjC,IAAM,EAAiB,MAAM,MAAM,EAAW,CAC5C,QAAS,CAAE,cAAe,CAAC,IAAI,EAAE,EAAA,CAAQ,AAAC,CAC5C,GAEA,GAAI,CAAC,EAAe,EAAE,CACpB,CADsB,KAChB,AAAI,MAAM,gCAGlB,OAAO,EAAe,IAAI,EAC5B,CAEA,GAAI,AAAkB,UAAU,GAArB,MAAM,CACf,MAAM,AAAI,MAAM,CAAC,kBAAkB,EAAE,EAAO,KAAK,EAAI,gBAAA,CAAiB,EAGxE,GACF,CAEA,MAAM,AAAI,MAAM,sBAClB,CASO,eAAe,EACpB,CAA8B,CAC9B,CAEC,EAGD,GAAI,EAAQ,UAAU,EAAI,CAAC,EAAQ,UAAU,EAAG,CAAC,CAAI,GAAM,EAAG,CAC5D,IAAM,EAAuD,EAA3C,KAAK,KAAK,CAAC,CAAC,EAAQ,UAAU,EAAG,CAAC,CAAI,GAAS,EACjE,QAAQ,IAAI,CAAC,CAAC,kCAAkC,EAAE,EAAQ,UAAU,CAAC,IAAI,EAAE,EAAU,eAAe,CAAC,EACrG,EAAQ,UAAU,CAAG,CACvB,CAUA,OAPI,EAAQ,KAAK,EAAI,EAAQ,KAAK,CAAG,IAAO,GAAG,CAC7C,EAAQ,KAAK,CAAG,AAAiC,QAA5B,KAAK,CAAC,EAAQ,KAAK,CAAG,GAAM,EAE/C,EAAQ,MAAM,EAAI,EAAQ,MAAM,CAAG,IAAO,GAAG,CAC/C,EAAQ,MAAM,CAAqC,GAAlC,KAAK,KAAK,CAAC,EAAQ,MAAM,CAAG,GAAM,EAG9C,EA1OiB,eA2OtB,IACA,CACE,OAAQ,EAAQ,MAAM,CACtB,gBAAiB,EAAQ,eAAe,EAAI,4CAC5C,WAAY,EAAQ,UAAU,EAAI,GAClC,MAAO,EAAQ,KAAK,EAAI,IACxB,OAAQ,EAAQ,MAAM,EAAI,IAC1B,KAAM,EAAQ,IAAI,CAClB,oBAAqB,EAAQ,mBAAmB,EAAI,GACpD,eAAgB,EAAQ,cAAc,EAAI,GAC5C,EACA,CACE,WAAY,AAAC,GAAW,GAAS,aAAa,EAChD,EAEJ,CAKO,eAAe,EACpB,CAA+B,CAC/B,CAEC,EAGD,GAAI,EAAQ,UAAU,EAAI,CAAC,EAAQ,UAAU,EAAG,CAAC,CAAI,GAAM,EAAG,CAC5D,IAAM,EAAuD,EAA3C,KAAK,KAAK,CAAC,CAAC,EAAQ,UAAU,CAAG,CAAC,EAAI,GAAS,EACjE,EAAQ,UAAU,CAAG,CACvB,CAEA,OAAO,EA1QkB,eA2QvB,mBACA,CACE,OAAQ,EAAQ,MAAM,CACtB,UAAW,EAAQ,SAAS,CAC5B,gBAAiB,EAAQ,eAAe,EAAI,4CAC5C,WAAY,EAAQ,UAAU,EAAI,GAClC,KAAM,EAAQ,IAAI,CAClB,oBAAqB,EAAQ,mBAAmB,EAAI,GACpD,eAAgB,EAAQ,cAAc,EAAI,GAC5C,EACA,CACE,WAAY,AAAC,GAAW,GAAS,aAAa,EAChD,EAEJ,CAKO,eAAe,EACpB,CAAc,CACd,CAAoC,CACpC,CAKC,EAED,IAAM,EAAS,CAAW,CAAC,EAAW,CACtC,GAAI,CAAC,EACH,MADW,AACL,AAAI,MAAM,CAAC,gBAAgB,EAAE,EAAA,CAAY,SAIjD,AAAI,GAAS,UACJ,CADe,CAEpB,QACE,EACA,UAAW,EAAQ,SAAS,CAC5B,gBAAiB,EAAQ,eAAe,CACxC,WAAY,EAAO,UAAU,CAC7B,KAAM,EAAQ,IAAI,AACpB,EACA,CAAE,WAAY,GAAS,UAAW,GAI/B,EACL,QACE,EACA,gBAAiB,GAAS,gBAC1B,MAAO,EAAO,KAAK,CACnB,OAAQ,EAAO,MAAM,CACrB,WAAY,EAAO,UAAU,CAC7B,KAAM,GAAS,IACjB,EACA,CAAE,WAAY,GAAS,UAAW,EAEtC,CAKO,SAAS,IACd,MAAO,CAAC,CAAC,QAAQ,GAAG,CAAC,OAAO,AAC9B,CAcO,SAAS,EAAyB,CAAqB,EAG5D,OAA4C,EAArC,KAAK,KAAK,CAAC,CAFG,AAEF,KAFO,KAAK,CAAiB,GAAhB,IAEE,CAAC,CAAI,GAAS,CAClD,+MC/WA,IAAI,EAAY,OAAO,cAAc,CACjC,EAAmB,OAAO,wBAAwB,CAClD,EAAoB,OAAO,mBAAmB,CAC9C,EAAe,OAAO,SAAS,CAAC,cAAc,CAc9C,EAAsB,CAAC,EAbH,EAcM,CAC5B,qBAAsB,IAAM,CAC9B,EAfE,IAAK,IAAI,KAAQ,EACf,EAYK,EAZa,EAAM,CAAE,GAAhB,CAAqB,CAAG,CAAC,EAAK,CAAE,YAAY,CAAK,GAe/D,EAAO,OAAO,CALc,CARV,CAAC,AAaF,EAbM,IAAc,KACnC,GAAI,GAAwB,UAAhB,OAAO,GAAqB,AAAgB,YAAY,OAArB,EAC7C,IAAK,IAAI,KAAO,EAAkB,GAC3B,AAAD,EAAc,CAAlB,GAAsB,CAAC,EAAI,IAHJ,SAGY,GACjC,EAAU,EAAI,CAD2B,CACtB,CAAE,IAAK,IAAM,CAAI,CAAC,EAAI,CAAE,WAAY,CAAC,CAAC,EAAO,EAAiB,EAAM,EAAA,CAAI,EAAK,EAAK,UAAU,AAAC,GAEtH,OAAO,EACT,EACwC,EAAU,CAAC,EAAG,aAAc,CAAE,OAAO,CAAK,GAKpD,CALwD,CAMtF,OAAM,UAA6B,MACjC,YAAY,CAAO,CAAE,CAAK,CAAE,CAC1B,KAAK,CAAC,GACN,IAAI,CAAC,IAAI,CAAG,uBACZ,IAAI,CAAC,KAAK,CAAG,CACf,CACA,UAAW,QACT,AAAI,IAAI,CAAC,KAAK,CACL,CADO,AACP,EAAG,IAAI,CAAC,IAAI,CAAC,EAAE,EAAE,IAAI,CAAC,OAAO,CAAC,EAAE,EAAE,IAAI,CAAC,KAAK,CAAA,CAAE,CAEhD,CAAA,EAAG,IAAI,CAAC,IAAI,CAAC,EAAE,EAAE,IAAI,CAAC,OAAO,CAAA,CAAE,AACxC,CACF","ignoreList":[1]}