module.exports=[950299,e=>{"use strict";var t=e.i(457375),s=e.i(174015),n=e.i(116384),o=e.i(63831),r=e.i(868001),a=e.i(842780),i=e.i(763077),c=e.i(502964),l=e.i(993216),u=e.i(783900),p=e.i(295731),d=e.i(726839),g=e.i(775778),h=e.i(40992),m=e.i(432128),f=e.i(193695);e.i(44807);var R=e.i(989978),w=e.i(39334),v=e.i(848920),E=e.i(488782),x=e.i(254799),y=e.i(879389);async function N(e,t,s,n="visitor",o){let r,a=process.env.NEXT_PUBLIC_APP_URL||"http://localhost:3000",i=(r="You are Claw AI, responding via WhatsApp. Keep responses concise and mobile-friendly. Use WhatsApp formatting: *bold*, _italic_, ~strikethrough~, ```code```.","owner"===n?`${r}

You are talking to James, your creator. You have FULL POWERS:
- Execute any command or tool
- Send messages to other contacts when asked
- Generate music, videos, images
- Build features, run research
- Manage contacts and settings

MEMORY: You have full access to the Recursive Memory Layer (RLM):
- Use 'remember' to search past conversations and events
- Use 'recall_preference' to retrieve James's preferences and knowledge
- Use 'memorize' to store important moments (importance 0-1)
- Use 'learn' to update semantic knowledge with confidence scores
- Use 'forget' to delete outdated memories when asked

Proactively use memory tools to:
- Reference past conversations and decisions
- Remember project context and ongoing work
- Store important requests and commitments
- Build continuity across chat sessions

Be helpful, direct, and proactive. James trusts you completely.`:"collaborator"===n?`${r}

You are talking to a trusted collaborator. You have ELEVATED ACCESS:
- Search portfolio and memories
- Check schedules and availability
- Respond with voice messages
- Access shared information

You CANNOT:
- Send messages to other contacts
- Modify system settings
- Execute destructive operations`:`${r}

You are talking to a visitor. You have LIMITED ACCESS:
- Basic conversation
- Portfolio information
- General questions about James

You CANNOT:
- Access memories or private data
- Execute commands or tools
- Book meetings or check schedules`);try{let o=await fetch(`${a}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:[{role:"system",content:i},...s,{role:"user",content:function(e,t=5e3){return e.replace(/ignore previous instructions/gi,"[filtered]").replace(/system prompt/gi,"[filtered]").replace(/\[INST\]/gi,"[filtered]").replace(/<\|im_start\|>/gi,"[filtered]").replace(/\[SYSTEM\]/gi,"[filtered]").replace(/assistant:/gi,"[filtered]").slice(0,t)}(t)}],userId:e,channel:"whatsapp",enableTools:"visitor"!==n})});if(!o.ok){let e=await o.text();return console.error("Claw AI error:",e),"I'm having trouble processing that right now. Please try again."}let r=await o.json();return r.content||r.message||"I couldn't generate a response."}catch(e){return console.error("AI processing error:",e),"Sorry, I encountered an error. Please try again."}}async function A(e,t,s){return(await e.query(E.api.channels.getRecentMessages,{integrationId:t,limit:s})).reverse().map(e=>({role:"inbound"===e.direction?"user":"assistant",content:e.content}))}async function I(e){let t=Date.now(),s=(0,y.getClientIp)(e),n=(0,y.checkRateLimit)(`webhook:whatsapp:${s}`,{windowMs:6e4,maxRequests:20});if(!n.allowed)return console.warn(`[WhatsApp] Rate limit exceeded for IP: ${s}`),w.NextResponse.json({error:"Too many requests"},{status:429,headers:{"Retry-After":String(Math.ceil((n.resetAt-Date.now())/1e3)),"X-RateLimit-Limit":"20","X-RateLimit-Remaining":String(n.remaining),"X-RateLimit-Reset":String(Math.floor(n.resetAt/1e3))}});try{let s=await e.text();if(!function(e,t){let s=e.headers.get("x-webhook-signature"),n=process.env.WHATSAPP_WEBHOOK_SECRET;if(!n)return console.error("[WhatsApp] WHATSAPP_WEBHOOK_SECRET not configured in production"),!1;if(!s)return!1;try{let e=Buffer.from(s),t=Buffer.from(n);if(e.length!==t.length)return!1;return x.default.timingSafeEqual(e,t)}catch{return!1}}(e,0))return w.NextResponse.json({error:"Invalid signature"},{status:401});let n=JSON.parse(s),o=function(){let e=process.env.NEXT_PUBLIC_CONVEX_URL;if(!e)throw Error("NEXT_PUBLIC_CONVEX_URL not configured");return new v.ConvexHttpClient(e)}();switch(n.event){case"message":{if(!n.message)return w.NextResponse.json({error:"No message in payload"},{status:400});let e=n.message,s=e.remoteJid.replace("@s.whatsapp.net","");if(e.fromMe){let t=process.env.OWNER_USER_ID,n=process.env.WHATSAPP_OWNER_NUMBER||"";if(!t)return console.error("[WhatsApp] OWNER_USER_ID environment variable is required for outbound messages"),w.NextResponse.json({success:!1,error:"Server configuration error - OWNER_USER_ID not set"},{status:500});let r=await o.query(E.api.channels.getIntegrationByPlatformUser,{platform:"whatsapp",platformUserId:n});if(!r)return console.warn("[WhatsApp] No integration found for owner outbound message"),w.NextResponse.json({success:!1,error:"Owner integration not configured - create in /settings/channels"},{status:500});return await o.mutation(E.api.channels.logOutboundMessage,{integrationId:r.integrationId,userId:r.userId,platform:"whatsapp",messageType:"text",content:e.text||"",processingTimeMs:0}),console.log(`[WhatsApp] Logged outbound message to ${s}`),w.NextResponse.json({success:!0,logged:"outbound message"})}let r=(process.env.WHATSAPP_OWNER_NUMBER||"").replace(/\D/g,""),a=s.replace(/\D/g,""),i="visitor";r&&a===r?(i="owner",console.log(`[WhatsApp] Owner detected via env var: ${s}`)):i=await o.query(E.api.whatsappContacts.getAccessLevel,{phoneNumber:s}),console.log(`[WhatsApp] Message from ${s}, access level: ${i}`);let c=await o.query(E.api.channels.getIntegrationByPlatformUser,{platform:"whatsapp",platformUserId:s});if(!c)return console.log(`No integration found for phone: ${s}`),w.NextResponse.json({success:!0,skipped:"no integration",message:"To use Claw AI on WhatsApp, connect your account at 8gent.app/settings/channels"});if(!c.settings.enabled)return w.NextResponse.json({success:!0,skipped:"integration disabled"});if(void 0!==c.settings.quietHoursStart&&void 0!==c.settings.quietHoursEnd){let e=new Date().getHours(),{quietHoursStart:t,quietHoursEnd:s}=c.settings;if(t<s){if(e>=t||e<s)return w.NextResponse.json({success:!0,skipped:"quiet hours"})}else if(e>=t&&e<s)return w.NextResponse.json({success:!0,skipped:"quiet hours"})}let l=e.text||e.caption||"",u="audio"===e.type?"voice":"text";if("audio"===e.type&&e.audioTranscription&&(l=e.audioTranscription),!l&&"audio"!==e.type)return w.NextResponse.json({success:!0,skipped:"unsupported message type"});if(c.settings.commandPrefix){if(l.startsWith(c.settings.commandPrefix))l=l.slice(c.settings.commandPrefix.length).trim();else if(!c.settings.autoReply)return w.NextResponse.json({success:!0,skipped:"no command prefix"})}let{messageId:p}=await o.mutation(E.api.channels.logInboundMessage,{integrationId:c.integrationId,userId:c.userId,platform:"whatsapp",platformMessageId:e.messageId,messageType:u,content:l,transcription:e.audioTranscription,platformTimestamp:1e3*e.timestamp});await o.mutation(E.api.channels.updateMessageStatus,{messageId:p,status:"processing"});let d=await A(o,c.integrationId,c.settings.contextLimit),g=await N(c.userId,l,d,i,s),h=Date.now()-t;return await o.mutation(E.api.channels.updateMessageStatus,{messageId:p,status:"responded",aiResponse:g,processingTimeMs:h}),await o.mutation(E.api.channels.logOutboundMessage,{integrationId:c.integrationId,userId:c.userId,platform:"whatsapp",messageType:"text",content:g,processingTimeMs:h}),o.mutation(E.api.whatsappContacts.updateContactStats,{phoneNumber:s}).catch(e=>console.log("[WhatsApp] Failed to update contact stats:",e)),w.NextResponse.json({success:!0,response:{remoteJid:e.remoteJid,text:g,generateVoice:c.settings.voiceEnabled,voiceId:c.settings.voiceId}})}case"connection":if(!n.integrationId||!n.connection)return w.NextResponse.json({error:"Missing connection data"},{status:400});return await o.mutation(E.api.channels.updateConnectionStatus,{integrationId:n.integrationId,status:"connected"===n.connection.status?"connected":"error"===n.connection.status?"error":"disconnected",error:n.connection.error}),w.NextResponse.json({success:!0});case"status":return w.NextResponse.json({success:!0});default:return w.NextResponse.json({success:!0,skipped:"unhandled event"})}}catch(e){return console.error("WhatsApp webhook error:",e),w.NextResponse.json({success:!1,error:e instanceof Error?e.message:"Webhook processing failed"},{status:500})}}async function C(e){let{searchParams:t}=new URL(e.url),s=t.get("challenge");return t.get("verify_token")===process.env.WHATSAPP_VERIFY_TOKEN&&s?new w.NextResponse(s):w.NextResponse.json({error:"Verification failed"},{status:403})}e.s(["GET",()=>C,"POST",()=>I],739171);var T=e.i(739171);let S=new t.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/webhooks/whatsapp/route",pathname:"/api/webhooks/whatsapp",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/webhooks/whatsapp/route.ts",nextConfigOutput:"",userland:T}),{workAsyncStorage:b,workUnitAsyncStorage:P,serverHooks:_}=S;function O(){return(0,n.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:P})}async function k(e,t,n){S.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/webhooks/whatsapp/route";w=w.replace(/\/index$/,"")||"/";let v=await S.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:E,params:x,nextConfig:y,parsedUrl:N,isDraftMode:A,prerenderManifest:I,routerServerContext:C,isOnDemandRevalidate:T,revalidateOnlyGenerated:b,resolvedPathname:P,clientReferenceManifest:_,serverActionsManifest:O}=v,k=(0,i.normalizeAppPath)(w),U=!!(I.dynamicRoutes[k]||I.routes[P]),M=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,N,!1):t.end("This page could not be found"),null);if(U&&!A){let e=!!I.routes[P],t=I.dynamicRoutes[k];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await M();throw new f.NoFallbackError}}let j=null;!U||S.isDev||A||(j="/index"===(j=P)?"/":j);let W=!0===S.isDev||!U,q=U&&!W;O&&_&&(0,a.setManifestsSingleton)({page:w,clientReferenceManifest:_,serverActionsManifest:O});let H=e.method||"GET",L=(0,r.getTracer)(),D=L.getActiveScopeSpan(),B={params:x,prerenderManifest:I,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:W,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,s,n,o)=>S.onRequestError(e,t,n,o,C)},sharedContext:{buildId:E}},$=new c.NodeNextRequest(e),Y=new c.NodeNextResponse(t),K=l.NextRequestAdapter.fromNodeNextRequest($,(0,l.signalFromNodeResponse)(t));try{let a=async e=>S.handle(K,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let s=L.getRootSpanAttributes();if(!s)return;if(s.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${s.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=s.get("next.route");if(n){let t=`${H} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${w}`)}),i=!!(0,o.getRequestMeta)(e,"minimalMode"),c=async o=>{var r,c;let l=async({previousCacheEntry:s})=>{try{if(!i&&T&&b&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await a(o);e.fetchMetrics=B.renderOpts.fetchMetrics;let c=B.renderOpts.pendingWaitUntil;c&&n.waitUntil&&(n.waitUntil(c),c=void 0);let l=B.renderOpts.collectedTags;if(!U)return await (0,d.sendResponse)($,Y,r,B.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(r.headers);l&&(t[m.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let s=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,n=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:s,expire:n}}}}catch(t){throw(null==s?void 0:s.isStale)&&await S.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:T})},!1,C),t}},u=await S.handleResponse({req:e,nextConfig:y,cacheKey:j,routeKind:s.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:I,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:b,responseGenerator:l,waitUntil:n.waitUntil,isMinimalMode:i});if(!U)return null;if((null==u||null==(r=u.value)?void 0:r.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(c=u.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",T?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let f=(0,g.fromNodeOutgoingHttpHeaders)(u.value.headers);return i&&U||f.delete(m.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||f.get("Cache-Control")||f.set("Cache-Control",(0,h.getCacheControlHeader)(u.cacheControl)),await (0,d.sendResponse)($,Y,new Response(u.value.body,{headers:f,status:u.value.status||200})),null};D?await c(D):await L.withPropagatedContext(e.headers,()=>L.trace(u.BaseServerSpan.handleRequest,{spanName:`${H} ${w}`,kind:r.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},c))}catch(t){if(t instanceof f.NoFallbackError||await S.onRequestError(e,t,{routerKind:"App Router",routePath:k,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:T})},!1,C),U)throw t;return await (0,d.sendResponse)($,Y,new Response(null,{status:500})),null}}e.s(["handler",()=>k,"patchFetch",()=>O,"routeModule",()=>S,"serverHooks",()=>_,"workAsyncStorage",()=>b,"workUnitAsyncStorage",()=>P],950299)}];

//# sourceMappingURL=5d253_next_dist_esm_build_templates_app-route_78b5c81c.js.map