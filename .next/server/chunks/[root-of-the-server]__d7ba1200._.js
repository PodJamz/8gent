module.exports=[918622,(e,t,s)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},556704,(e,t,s)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},832319,(e,t,s)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},324725,(e,t,s)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},193695,(e,t,s)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},254799,(e,t,s)=>{t.exports=e.x("crypto",()=>require("crypto"))},488782,e=>{"use strict";class t{constructor(e){}query(e,t){return Promise.resolve(null)}mutation(e,t){return Promise.resolve(null)}}e.s(["ConvexHttpClient",()=>t,"api",0,{jobs:{getAgentJobs:"jobs:getAgentJobs",cancelJob:"jobs:cancelJob",getJob:"jobs:getJob",queueCodeIteration:"jobs:queueCodeIteration",queueSpecialistDelegation:"jobs:queueSpecialistDelegation",queueAgentTask:"jobs:queueAgentTask",updateJobStatusPublic:"jobs:updateJobStatusPublic",logJobEventPublic:"jobs:logJobEventPublic"},aiSettings:{getSettings:"aiSettings:getSettings"},erv:{createEntity:"erv:createEntity",createRelationship:"erv:createRelationship",createDimension:"erv:createDimension",listDimensions:"erv:listDimensions",searchEntities:"erv:searchEntities",getEntity:"erv:getEntity"},jamz:{createProject:"jamz:createProject",createTrack:"jamz:createTrack",createClip:"jamz:createClip"},messages:{send:"messages:send"},whatsappContacts:{list:"whatsappContacts:list",getContactByPhone:"whatsappContacts:getContactByPhone",listContacts:"whatsappContacts:listContacts",upsertContact:"whatsappContacts:upsertContact"},channels:{list:"channels:list",getChannel:"channels:getChannel",sendMessage:"channels:sendMessage",getUserMessages:"channels:getUserMessages",getUserIntegrations:"channels:getUserIntegrations",getConversations:"channels:getConversations",getIntegration:"channels:getIntegration",logOutboundMessage:"channels:logOutboundMessage",searchMessages:"channels:searchMessages"},scheduling:{list:"scheduling:list",createEvent:"scheduling:createEvent",getEventTypes:"scheduling:getEventTypes",getAvailableSlots:"scheduling:getAvailableSlots",createBooking:"scheduling:createBooking",rescheduleBooking:"scheduling:rescheduleBooking",updateBookingStatus:"scheduling:updateBookingStatus"},userCronJobs:{list:"userCronJobs:list",create:"userCronJobs:create",delete:"userCronJobs:delete",createJob:"userCronJobs:createJob",getUserJobs:"userCronJobs:getUserJobs",toggleJob:"userCronJobs:toggleJob",deleteJob:"userCronJobs:deleteJob"},compaction:{compact:"compaction:compact",getLatestCompaction:"compaction:getLatestCompaction"},kanban:{listLists:"kanban:listLists",createCard:"kanban:createCard",moveCard:"kanban:moveCard",getTaskById:"kanban:getTaskById",searchTasks:"kanban:searchTasks",getTasks:"kanban:getTasks",isSeeded:"kanban:isSeeded",addTask:"kanban:addTask",updateTask:"kanban:updateTask",deleteTask:"kanban:deleteTask",moveTask:"kanban:moveTask",seedTasks:"kanban:seedTasks"},designCanvas:{getCanvas:"designCanvas:getCanvas",updateCanvas:"designCanvas:updateCanvas",createItem:"designCanvas:createItem",createCanvas:"designCanvas:createCanvas",getUserCanvases:"designCanvas:getUserCanvases",getCanvasNodes:"designCanvas:getCanvasNodes",getCanvasEdges:"designCanvas:getCanvasEdges",addNode:"designCanvas:addNode",addEdge:"designCanvas:addEdge",updateNode:"designCanvas:updateNode"},agentic:{createProductProject:"agentic:createProductProject",createPRD:"agentic:createPRD",createEpic:"agentic:createEpic",createTicket:"agentic:createTicket"},discovery:{getSession:"discovery:getSession",storeInsights:"discovery:storeInsights",storeArtifacts:"discovery:storeArtifacts",markNotificationSent:"discovery:markNotificationSent",markError:"discovery:markError",getSessionByCallerId:"discovery:getSessionByCallerId",updateTranscript:"discovery:updateTranscript"},memories:{searchEpisodic:"memories:searchEpisodic",getSemanticByCategories:"memories:getSemanticByCategories",getAllSemantic:"memories:getAllSemantic",getRecentEpisodic:"memories:getRecentEpisodic",storeEpisodic:"memories:storeEpisodic",upsertSemantic:"memories:upsertSemantic",deleteEpisodic:"memories:deleteEpisodic",deleteSemantic:"memories:deleteSemantic",getMemoryStats:"memories:getMemoryStats"},observability:{getSecurityScans:"observability:getSecurityScans",createSecurityScan:"observability:createSecurityScan",getActivityStream:"observability:getActivityStream",getDashboardOverview:"observability:getDashboardOverview",getProviderHealthStatus:"observability:getProviderHealthStatus",logOperation:"observability:logOperation"},roadmap:{submitSuggestion:"roadmap:submitSuggestion",getSuggestions:"roadmap:getSuggestions",updateSuggestionStatus:"roadmap:updateSuggestionStatus",voteSuggestion:"roadmap:voteSuggestion"}}])},35107,e=>{"use strict";var t=e.i(457375),s=e.i(174015),a=e.i(116384),r=e.i(63831),n=e.i(868001),o=e.i(842780),i=e.i(763077),l=e.i(502964),c=e.i(993216),d=e.i(783900),u=e.i(295731),g=e.i(726839),p=e.i(775778),m=e.i(40992),h=e.i(432128),v=e.i(193695);e.i(44807);var b=e.i(989978),C=e.i(39334),f=e.i(488782),y=e.i(254799);function x(){let e=process.env.NEXT_PUBLIC_CONVEX_URL;if(!e)throw Error("NEXT_PUBLIC_CONVEX_URL not configured");return new f.ConvexHttpClient(e)}async function E(e,t){try{let s=(await x().query(f.api.channels.getRecentMessages,{integrationId:t.integrationId,limit:t.settings.contextLimit})).map(e=>`${"inbound"===e.direction?"User":"Claw AI"}: ${e.content}`).join("\n"),a=function(e,t=500){return e.replace(/[\x00-\x1F\x7F]/g," ").replace(/\s+/g," ").trim().slice(0,t)}(e.text),r=await fetch(`${process.env.NEXT_PUBLIC_APP_URL||"http://localhost:3000"}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:[{role:"system",content:`You are Claw AI responding via iMessage. Keep responses concise and conversational, suitable for mobile messaging. Previous context:
${s}`},{role:"user",content:a}],userId:t.userId,channel:"imessage"})});if(!r.ok){let e=await r.text();return console.error("[iMessage] AI processing failed:",e),null}let n=await r.json();if(n.error)return console.error("[iMessage] AI error:",n.error),null;return n.response||n.content||null}catch(e){return console.error("[iMessage] AI processing error:",e),null}}async function S(e,t,s,a){try{let r=await fetch(`${e}/api/v1/message/text`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatGuid:s,message:a,tempGuid:`temp-${Date.now()}`,method:"private-api",password:t})});if(!r.ok)return console.error("[iMessage] BlueBubbles send failed:",await r.text()),!1;return!0}catch(e){return console.error("[iMessage] BlueBubbles send error:",e),!1}}async function k(e){let t=Date.now();try{let s=await e.text(),a=process.env.BLUEBUBBLES_WEBHOOK_SECRET;if(!function(e,t,s){if(!s)return console.error("[iMessage] BLUEBUBBLES_WEBHOOK_SECRET not configured in production"),!1;let a=e.headers.get("x-bluebubbles-signature");if(!a)return!1;let r=y.default.createHmac("sha256",s).update(t).digest("hex");return y.default.timingSafeEqual(Buffer.from(a),Buffer.from(r))}(e,s,a))return console.warn("[iMessage] Invalid webhook signature"),C.NextResponse.json({error:"Invalid signature"},{status:401});let r=JSON.parse(s);switch(console.log(`[iMessage] Received event: ${r.type}`),r.type){case"new-message":{let e=r.data;if(e.isFromMe)return C.NextResponse.json({status:"skipped",reason:"self-message"});let s=e.handle?.address;if(!s)return C.NextResponse.json({status:"skipped",reason:"no-sender"});let a=e.chats?.[0],n=a?.guid;if(!n)return C.NextResponse.json({status:"skipped",reason:"no-chat"});let o=await x().query(f.api.channels.getIntegrationByPlatformUser,{platform:"imessage",platformUserId:s});if(!o)return console.log(`[iMessage] No integration found for: ${s}`),C.NextResponse.json({status:"skipped",reason:"no-integration"});if(!o.settings.enabled)return C.NextResponse.json({status:"skipped",reason:"disabled"});if(await x().mutation(f.api.channels.storeMessage,{integrationId:o.integrationId,userId:o.userId,platform:"imessage",platformMessageId:e.guid,direction:"inbound",messageType:e.hasAttachments?"image":"text",content:e.text||"",platformTimestamp:e.dateCreated}),o.settings.autoReply){let t=await E(e,o);if(t){let e=o.credentials?.serverUrl,s=o.credentials?.serverPassword;e&&s&&await S(e,s,n,t)&&await x().mutation(f.api.channels.storeMessage,{integrationId:o.integrationId,userId:o.userId,platform:"imessage",direction:"outbound",messageType:"text",content:t})}}let i=Date.now()-t;return console.log(`[iMessage] Processed in ${i}ms`),C.NextResponse.json({status:"processed",processingTimeMs:i})}case"message-send-error":return console.error("[iMessage] Send error:",r.data),C.NextResponse.json({status:"logged"});case"updated-message":return console.log("[iMessage] Message updated:",r.data),C.NextResponse.json({status:"logged"});case"chat-read-status-changed":case"typing-indicator":return C.NextResponse.json({status:"acknowledged"});default:return console.log(`[iMessage] Unknown event type: ${r.type}`),C.NextResponse.json({status:"unknown-event"})}}catch(e){return console.error("[iMessage] Webhook error:",e),C.NextResponse.json({error:"Internal server error"},{status:500})}}async function R(){return C.NextResponse.json({status:"ok",service:"iMessage/BlueBubbles webhook",timestamp:new Date().toISOString()})}e.s(["GET",()=>R,"POST",()=>k],335105);var w=e.i(335105);let T=new t.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/webhooks/imessage/route",pathname:"/api/webhooks/imessage",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/webhooks/imessage/route.ts",nextConfigOutput:"",userland:w}),{workAsyncStorage:I,workUnitAsyncStorage:N,serverHooks:P}=T;function j(){return(0,a.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:N})}async function A(e,t,a){T.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let C="/api/webhooks/imessage/route";C=C.replace(/\/index$/,"")||"/";let f=await T.prepare(e,t,{srcPage:C,multiZoneDraftMode:!1});if(!f)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:y,params:x,nextConfig:E,parsedUrl:S,isDraftMode:k,prerenderManifest:R,routerServerContext:w,isOnDemandRevalidate:I,revalidateOnlyGenerated:N,resolvedPathname:P,clientReferenceManifest:j,serverActionsManifest:A}=f,M=(0,i.normalizeAppPath)(C),B=!!(R.dynamicRoutes[M]||R.routes[P]),O=async()=>((null==w?void 0:w.render404)?await w.render404(e,t,S,!1):t.end("This page could not be found"),null);if(B&&!k){let e=!!R.routes[P],t=R.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await O();throw new v.NoFallbackError}}let U=null;!B||T.isDev||k||(U="/index"===(U=P)?"/":U);let _=!0===T.isDev||!B,q=B&&!_;A&&j&&(0,o.setManifestsSingleton)({page:C,clientReferenceManifest:j,serverActionsManifest:A});let J=e.method||"GET",D=(0,n.getTracer)(),H=D.getActiveScopeSpan(),L={params:x,prerenderManifest:R,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:_,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,s,a,r)=>T.onRequestError(e,t,a,r,w)},sharedContext:{buildId:y}},$=new l.NodeNextRequest(e),F=new l.NodeNextResponse(t),K=c.NextRequestAdapter.fromNodeNextRequest($,(0,c.signalFromNodeResponse)(t));try{let o=async e=>T.handle(K,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let s=D.getRootSpanAttributes();if(!s)return;if(s.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${s.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=s.get("next.route");if(a){let t=`${J} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${J} ${C}`)}),i=!!(0,r.getRequestMeta)(e,"minimalMode"),l=async r=>{var n,l;let c=async({previousCacheEntry:s})=>{try{if(!i&&I&&N&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(r);e.fetchMetrics=L.renderOpts.fetchMetrics;let l=L.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let c=L.renderOpts.collectedTags;if(!B)return await (0,g.sendResponse)($,F,n,L.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(n.headers);c&&(t[h.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let s=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,a=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:b.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:s,expire:a}}}}catch(t){throw(null==s?void 0:s.isStale)&&await T.onRequestError(e,t,{routerKind:"App Router",routePath:C,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:I})},!1,w),t}},d=await T.handleResponse({req:e,nextConfig:E,cacheKey:U,routeKind:s.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:R,isRoutePPREnabled:!1,isOnDemandRevalidate:I,revalidateOnlyGenerated:N,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:i});if(!B)return null;if((null==d||null==(n=d.value)?void 0:n.kind)!==b.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",I?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),k&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let v=(0,p.fromNodeOutgoingHttpHeaders)(d.value.headers);return i&&B||v.delete(h.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||v.get("Cache-Control")||v.set("Cache-Control",(0,m.getCacheControlHeader)(d.cacheControl)),await (0,g.sendResponse)($,F,new Response(d.value.body,{headers:v,status:d.value.status||200})),null};H?await l(H):await D.withPropagatedContext(e.headers,()=>D.trace(d.BaseServerSpan.handleRequest,{spanName:`${J} ${C}`,kind:n.SpanKind.SERVER,attributes:{"http.method":J,"http.target":e.url}},l))}catch(t){if(t instanceof v.NoFallbackError||await T.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:I})},!1,w),B)throw t;return await (0,g.sendResponse)($,F,new Response(null,{status:500})),null}}e.s(["handler",()=>A,"patchFetch",()=>j,"routeModule",()=>T,"serverHooks",()=>P,"workAsyncStorage",()=>I,"workUnitAsyncStorage",()=>N],35107)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__d7ba1200._.js.map